{"version":3,"sources":["../src/index.ts","../src/channels/api.ts","../src/utils/logger.ts","../src/channels/telegram.ts","../src/channels/terminal.tsx","../src/cli/cost.ts","../src/cli/init.ts","../src/config/defaults.ts","../src/cli/jobs.ts","../src/cli/memory.ts","../src/config/loader.ts","../src/config/schema.ts","../src/core/context.ts","../src/core/tools/fs-tools.ts","../src/core/tools/types.ts","../src/core/tools/meta-tools.ts","../src/core/tools/network-tools.ts","../src/core/tools/scheduler-tools.ts","../src/scheduler/registry.ts","../src/core/tools/shell-tools.ts","../src/core/tools/index.ts","../src/core/executor.ts","../src/core/planner.ts","../src/core/agent.ts","../src/daemon.ts","../src/llm/cost-tracker.ts","../src/llm/providers/claude.ts","../src/llm/providers/ollama.ts","../src/llm/router.ts","../src/memory/consolidated.ts","../src/memory/consolidation.ts","../src/memory/decay.ts","../src/memory/embeddings.ts","../src/memory/episodic.ts","../src/memory/working.ts","../src/memory/retrieval.ts","../src/memory/soul.ts","../src/memory/store.ts","../src/sandbox/audit.ts","../src/sandbox/fs-cap.ts","../src/sandbox/network-cap.ts","../src/sandbox/sandbox.ts","../src/sandbox/shell-cap.ts","../src/scheduler/cron.ts","../src/scheduler/heartbeat.ts","../src/scheduler/triggers.ts"],"sourcesContent":["#!/usr/bin/env node\n\nimport { join } from 'node:path';\nimport { Command } from 'commander';\nimport {\n\tcreateApiChannel,\n\tcreateTelegramChannel,\n\tcreateTelegramHttpAdapter,\n\tstartTerminal,\n} from './channels/index.js';\nimport { registerCostCommand } from './cli/cost.js';\nimport { registerInitCommand } from './cli/init.js';\nimport { registerJobsCommands } from './cli/jobs.js';\nimport { registerMemoryCommands } from './cli/memory.js';\nimport { ensureMamaHome, getConfig, initConfig, type MamaConfig } from './config/index.js';\nimport { createAgent } from './core/index.js';\nimport {\n\tcreateDaemonController,\n\tgetDaemonStatus,\n\ttype ManagedService,\n\treadDaemonLogs,\n\tstartDetachedDaemonProcess,\n\tstopDaemonProcess,\n} from './daemon.js';\nimport { createClaudeProvider, createLLMRouter, createOllamaProvider } from './llm/index.js';\nimport {\n\tcreateConsolidatedMemoryStore,\n\tcreateConsolidationEngine,\n\tcreateConsolidationScheduler,\n\tcreateDecayEngine,\n\tcreateEmbeddingService,\n\tcreateEpisodicMemory,\n\tcreateMemoryRetrievalPipeline,\n\tcreateMemoryStore,\n\tcreateSoul,\n\tcreateWorkingMemory,\n} from './memory/index.js';\nimport {\n\tcreateAuditStore,\n\tcreateFsCapability,\n\tcreateNetworkCapability,\n\tcreateSandbox,\n\tcreateShellCapability,\n} from './sandbox/index.js';\nimport {\n\ttype CronScheduler,\n\tcreateCronScheduler,\n\tcreateHeartbeat,\n\tcreateTriggerEngine,\n\tsetScheduler,\n} from './scheduler/index.js';\nimport { createLogger, initLogger } from './utils/index.js';\n\nconst program = new Command();\nconst logger = createLogger('main');\n\ninterface RuntimeServices {\n\trouter: ReturnType<typeof createLLMRouter>;\n\tsoul: ReturnType<typeof createSoul>;\n\tmemoryStore: ReturnType<typeof createMemoryStore>;\n\tepisodicMemory: ReturnType<typeof createEpisodicMemory>;\n\tconsolidatedMemory: ReturnType<typeof createConsolidatedMemoryStore>;\n\tretrieval: ReturnType<typeof createMemoryRetrievalPipeline>;\n\tconsolidationEngine: ReturnType<typeof createConsolidationEngine>;\n}\n\ninterface AppRuntime {\n\tconfig: MamaConfig;\n\tmamaHome: string;\n\truntime: RuntimeServices;\n\tauditStore: ReturnType<typeof createAuditStore>;\n\tsandbox: ReturnType<typeof createSandbox>;\n\tcreateSessionAgent(): ReturnType<typeof createAgent>;\n\tclose(): void;\n}\n\nfunction resolvePath(value: string, mamaHome: string): string {\n\tif (value === '~') return process.env.HOME ?? mamaHome;\n\tif (value.startsWith('~/')) {\n\t\treturn value.replace('~', process.env.HOME ?? mamaHome);\n\t}\n\treturn value;\n}\n\nfunction initAppConfig(configPath?: string): MamaConfig {\n\tconst configResult = initConfig(configPath);\n\tif (!configResult.ok) {\n\t\tthrow configResult.error;\n\t}\n\treturn getConfig();\n}\n\nfunction createRuntimeServices(config: MamaConfig, mamaHome: string): RuntimeServices {\n\tconst memoryStore = createMemoryStore();\n\tconst claudeProvider = config.llm.providers.claude.apiKey\n\t\t? createClaudeProvider({\n\t\t\t\tapiKey: config.llm.providers.claude.apiKey,\n\t\t\t\tdefaultModel: config.llm.providers.claude.defaultModel,\n\t\t\t})\n\t\t: undefined;\n\tconst ollamaProvider = createOllamaProvider({\n\t\thost: config.llm.providers.ollama.host,\n\t\tapiKey: config.llm.providers.ollama.apiKey,\n\t\tdefaultModel: config.llm.providers.ollama.defaultModel,\n\t\tembeddingModel: config.llm.providers.ollama.embeddingModel,\n\t});\n\tconst router = createLLMRouter({\n\t\tconfig,\n\t\tclaudeProvider,\n\t\tollamaProvider,\n\t\tusageStore: memoryStore,\n\t});\n\tconst embeddings = createEmbeddingService({\n\t\tembedder: (text) => ollamaProvider.embed(text),\n\t});\n\tconst episodicMemory = createEpisodicMemory({\n\t\tstore: memoryStore,\n\t\tembeddings,\n\t\tdefaultTopK: config.memory.searchTopK,\n\t});\n\tconst consolidatedMemory = createConsolidatedMemoryStore({\n\t\tstore: memoryStore,\n\t\tembeddings,\n\t\tdefaultTopK: config.memory.searchTopK,\n\t});\n\tconst soul = createSoul({\n\t\tsoulPath: resolvePath(config.agent.soulPath, mamaHome),\n\t\tuserName: config.user.name,\n\t\tagentName: config.agent.name,\n\t});\n\tconst decayEngine = createDecayEngine({\n\t\tstore: memoryStore,\n\t\tconsolidated: consolidatedMemory,\n\t});\n\tconst retrieval = createMemoryRetrievalPipeline({\n\t\tstore: memoryStore,\n\t\tepisodic: episodicMemory,\n\t\tconsolidated: consolidatedMemory,\n\t\tmaxMemoryResults: 10,\n\t\tmaxRecentEpisodes: 20,\n\t\trecentWindowHours: 24,\n\t});\n\tconst consolidationEngine = createConsolidationEngine({\n\t\trouter,\n\t\tstore: memoryStore,\n\t\tepisodic: episodicMemory,\n\t\tconsolidated: consolidatedMemory,\n\t\tembeddings,\n\t\tsoul,\n\t\tdecay: decayEngine,\n\t\tminEpisodesToConsolidate: config.memory.consolidation.minEpisodesToConsolidate,\n\t});\n\n\treturn {\n\t\trouter,\n\t\tsoul,\n\t\tmemoryStore,\n\t\tepisodicMemory,\n\t\tconsolidatedMemory,\n\t\tretrieval,\n\t\tconsolidationEngine,\n\t};\n}\n\nfunction createAppRuntime(configPath?: string, silentLogs = true): AppRuntime {\n\tconst config = initAppConfig(configPath);\n\tconst mamaHome = ensureMamaHome();\n\tinitLogger({\n\t\tlevel: config.logging.level,\n\t\tfilePath: resolvePath(config.logging.file, mamaHome),\n\t\tsilent: silentLogs,\n\t});\n\n\tconst runtime = createRuntimeServices(config, mamaHome);\n\tconst auditStore = createAuditStore(join(mamaHome, 'mama.db'));\n\tconst sandbox = createSandbox(auditStore);\n\tconst homePath = process.env.HOME ?? mamaHome;\n\n\tsandbox.register(createFsCapability(config.sandbox.filesystem, homePath));\n\tsandbox.register(createShellCapability(config.sandbox.shell));\n\tsandbox.register(createNetworkCapability(config.sandbox.network));\n\n\tfunction createSessionAgent(): ReturnType<typeof createAgent> {\n\t\treturn createAgent({\n\t\t\trouter: runtime.router,\n\t\t\tworkingMemory: createWorkingMemory({ maxTokens: 100000 }),\n\t\t\tsoul: runtime.soul,\n\t\t\tsandbox,\n\t\t\tepisodicMemory: runtime.episodicMemory,\n\t\t\tretrieval: runtime.retrieval,\n\t\t\tretrievalTokenBudget: 1200,\n\t\t\tmaxIterations: 10,\n\t\t});\n\t}\n\n\treturn {\n\t\tconfig,\n\t\tmamaHome,\n\t\truntime,\n\t\tauditStore,\n\t\tsandbox,\n\t\tcreateSessionAgent,\n\t\tclose() {\n\t\t\tsetScheduler(null);\n\t\t\tauditStore.close();\n\t\t\truntime.memoryStore.close();\n\t\t},\n\t};\n}\n\nfunction createNaturalScheduleParser(router: RuntimeServices['router']) {\n\treturn {\n\t\tasync parseNaturalLanguage(schedule: string): Promise<string | null> {\n\t\t\tconst response = await router.complete({\n\t\t\t\ttaskType: 'simple_tasks',\n\t\t\t\tmaxTokens: 64,\n\t\t\t\tmessages: [\n\t\t\t\t\t{\n\t\t\t\t\t\trole: 'user',\n\t\t\t\t\t\tcontent: [\n\t\t\t\t\t\t\t'Convert this natural schedule into a 5-field cron expression.',\n\t\t\t\t\t\t\t'Return only the cron expression or INVALID.',\n\t\t\t\t\t\t\t`Schedule: ${schedule}`,\n\t\t\t\t\t\t].join('\\n'),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t});\n\t\t\tconst line = response.content.trim().split('\\n')[0]?.trim() ?? '';\n\t\t\tif (!line || line.toUpperCase().includes('INVALID')) return null;\n\t\t\treturn line.match(/^(\\S+\\s){4}\\S+$/)?.[0] ?? null;\n\t\t},\n\t};\n}\n\nasync function createScheduler(\n\tapp: AppRuntime,\n\tonRun?: (summary: string, priority?: 'low' | 'normal' | 'high' | 'urgent') => Promise<void>,\n): Promise<CronScheduler> {\n\tconst scheduler = await createCronScheduler({\n\t\tstore: app.runtime.memoryStore,\n\t\ttimezone: app.config.user.timezone,\n\t\tparser: createNaturalScheduleParser(app.runtime.router),\n\t\tauditStore: app.auditStore,\n\t\trunTask: async (task, context) => {\n\t\t\ttry {\n\t\t\t\tconst response = await app.createSessionAgent().processMessage(task, 'api');\n\t\t\t\tawait onRun?.(`Job \"${context.jobName}\" executed.\\n${response.content}`, 'normal');\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: true,\n\t\t\t\t\toutput: {\n\t\t\t\t\t\tcontent: response.content,\n\t\t\t\t\t\tmodel: response.model,\n\t\t\t\t\t\tprovider: response.provider,\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t} catch (error) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tawait onRun?.(`Job \"${context.jobName}\" failed: ${message}`, 'high');\n\t\t\t\treturn { success: false, error: message };\n\t\t\t}\n\t\t},\n\t});\n\treturn scheduler;\n}\n\nfunction createMemorySearch(app: AppRuntime) {\n\treturn async (query: string): Promise<string> => {\n\t\tconst [memories, episodes] = await Promise.all([\n\t\t\tapp.runtime.consolidatedMemory.search(query, {\n\t\t\t\ttopK: 5,\n\t\t\t\tincludeInactive: true,\n\t\t\t\tminConfidence: 0,\n\t\t\t}),\n\t\t\tapp.runtime.episodicMemory.searchSemantic(query, { topK: 5 }),\n\t\t]);\n\t\treturn [\n\t\t\t`Memory search: \"${query}\"`,\n\t\t\t'',\n\t\t\t'Consolidated:',\n\t\t\t...memories.map((m) => `- [${m.category}] ${m.content}`),\n\t\t\t'',\n\t\t\t'Episodic:',\n\t\t\t...episodes.map((e) => `- (${e.role}) ${e.content}`),\n\t\t]\n\t\t\t.filter(Boolean)\n\t\t\t.join('\\n');\n\t};\n}\n\nfunction createCostSnapshot(app: AppRuntime) {\n\treturn () => {\n\t\tconst tracker = app.runtime.router.getCostTracker();\n\t\treturn {\n\t\t\ttodayCostUsd: tracker.getCostToday(),\n\t\t\tmonthCostUsd: tracker.getCostThisMonth(),\n\t\t\ttotalCostUsd: tracker.getTotalCost(),\n\t\t\trecords: tracker.getRecords().length,\n\t\t};\n\t};\n}\n\nasync function runChat(configPath?: string): Promise<void> {\n\tconst app = createAppRuntime(configPath, true);\n\tlogger.info('Mama starting', { version: '0.1.0' });\n\n\tconst workingMemory = createWorkingMemory({ maxTokens: 100000 });\n\tconst agent = createAgent({\n\t\trouter: app.runtime.router,\n\t\tworkingMemory,\n\t\tsoul: app.runtime.soul,\n\t\tsandbox: app.sandbox,\n\t\tepisodicMemory: app.runtime.episodicMemory,\n\t\tretrieval: app.runtime.retrieval,\n\t\tretrievalTokenBudget: 1200,\n\t\tmaxIterations: 10,\n\t});\n\tlet lastInteractionAt = Date.now();\n\tconst trackedAgent: ReturnType<typeof createAgent> = {\n\t\t...agent,\n\t\tasync processMessage(input, channel, options) {\n\t\t\tlastInteractionAt = Date.now();\n\t\t\treturn agent.processMessage(input, channel, options);\n\t\t},\n\t};\n\n\tconst scheduler = await createScheduler(app);\n\tawait scheduler.start();\n\tsetScheduler(scheduler);\n\n\tconst cleanup = () => {\n\t\tscheduler.stop();\n\t\tapp.close();\n\t};\n\tprocess.on('exit', cleanup);\n\tprocess.on('SIGTERM', () => {\n\t\tcleanup();\n\t\tprocess.exit(0);\n\t});\n\n\tconst consolidation = createConsolidationScheduler({\n\t\tengine: app.runtime.consolidationEngine,\n\t\tintervalHours: app.config.memory.consolidation.intervalHours,\n\t\tminEpisodesToConsolidate: app.config.memory.consolidation.minEpisodesToConsolidate,\n\t\tisIdle: () => Date.now() - lastInteractionAt > 60_000,\n\t\tonReport: (report) => {\n\t\t\tif (!report.skipped) logger.info('Consolidation completed', { report });\n\t\t},\n\t});\n\tif (app.config.memory.consolidation.enabled) {\n\t\tconsolidation.start();\n\t}\n\tprocess.on('exit', () => consolidation.stop());\n\n\tstartTerminal(trackedAgent, app.config.agent.name, app.sandbox);\n}\n\nasync function runDaemonForeground(configPath?: string): Promise<void> {\n\tconst app = createAppRuntime(configPath, false);\n\tconst memorySearch = createMemorySearch(app);\n\tconst costSnapshot = createCostSnapshot(app);\n\tlet telegramChannel: ReturnType<typeof createTelegramChannel> | null = null;\n\n\tconst notify = async (\n\t\ttext: string,\n\t\tpriority: 'low' | 'normal' | 'high' | 'urgent' = 'normal',\n\t): Promise<void> => {\n\t\tconst chatId = app.config.channels.telegram.defaultChatId;\n\t\tif (!telegramChannel || !chatId || chatId <= 0) return;\n\t\tawait telegramChannel.sendProactiveMessage(chatId, text, priority);\n\t};\n\n\tconst scheduler = await createScheduler(app, notify);\n\tconst heartbeat = createHeartbeat({\n\t\tintervalMinutes: app.config.scheduler.heartbeat.intervalMinutes,\n\t\theartbeatFile: resolvePath(app.config.scheduler.heartbeat.heartbeatFile, app.mamaHome),\n\t\tauditStore: app.auditStore,\n\t\trunTask: async (prompt) => {\n\t\t\tconst response = await app.createSessionAgent().processMessage(prompt, 'api');\n\t\t\tawait notify(`Heartbeat run completed.\\n${response.content}`, 'low');\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\toutput: response.content,\n\t\t\t};\n\t\t},\n\t});\n\tconst triggers = createTriggerEngine({\n\t\tfileWatchers: app.config.scheduler.triggers.fileWatchers,\n\t\twebhooks: app.config.scheduler.triggers.webhooks,\n\t\trunTask: async (task) => {\n\t\t\tawait app.createSessionAgent().processMessage(task, 'api');\n\t\t\treturn { success: true };\n\t\t},\n\t});\n\n\tconst services: ManagedService[] = [\n\t\t{\n\t\t\tname: 'scheduler',\n\t\t\tstart: async () => {\n\t\t\t\tawait scheduler.start();\n\t\t\t\tsetScheduler(scheduler);\n\t\t\t},\n\t\t\tstop: async () => {\n\t\t\t\tscheduler.stop();\n\t\t\t\tsetScheduler(null);\n\t\t\t},\n\t\t\thealthCheck: async () => true,\n\t\t},\n\t];\n\n\tif (app.config.scheduler.heartbeat.enabled) {\n\t\tservices.push({\n\t\t\tname: 'heartbeat',\n\t\t\tstart: async () => heartbeat.start(),\n\t\t\tstop: async () => heartbeat.stop(),\n\t\t\thealthCheck: async () => heartbeat.isRunning(),\n\t\t});\n\t}\n\n\tif (\n\t\tapp.config.scheduler.triggers.fileWatchers.length > 0 ||\n\t\tapp.config.scheduler.triggers.webhooks.enabled\n\t) {\n\t\tservices.push({\n\t\t\tname: 'triggers',\n\t\t\tstart: async () => triggers.start(),\n\t\t\tstop: async () => triggers.stop(),\n\t\t\thealthCheck: async () => true,\n\t\t});\n\t}\n\n\tif (app.config.channels.telegram.enabled && app.config.channels.telegram.botToken) {\n\t\ttelegramChannel = createTelegramChannel({\n\t\t\ttoken: app.config.channels.telegram.botToken,\n\t\t\tallowedUserIds: app.config.user.telegramIds,\n\t\t\tworkspacePath: resolvePath(app.config.sandbox.filesystem.workspace, app.mamaHome),\n\t\t\tagent: app.createSessionAgent(),\n\t\t\tadapter: createTelegramHttpAdapter(app.config.channels.telegram.botToken),\n\t\t\tsandbox: app.sandbox,\n\t\t\tscheduler,\n\t\t\tauditStore: app.auditStore,\n\t\t\tmemorySearch,\n\t\t\tcostSnapshot,\n\t\t\tstatusSnapshot: async () => `running | jobs=${(await scheduler.listJobs()).length}`,\n\t\t});\n\t\tservices.push({\n\t\t\tname: 'telegram',\n\t\t\tstart: async () => telegramChannel?.start(),\n\t\t\tstop: async () => telegramChannel?.stop(),\n\t\t\thealthCheck: async () => true,\n\t\t});\n\t}\n\n\tif (app.config.channels.api.enabled) {\n\t\tconst apiChannel = createApiChannel({\n\t\t\thost: app.config.channels.api.host,\n\t\t\tport: app.config.channels.api.port,\n\t\t\ttoken: app.config.channels.api.token,\n\t\t\tagent: app.createSessionAgent(),\n\t\t\tscheduler,\n\t\t\tauditStore: app.auditStore,\n\t\t\tmemorySearch,\n\t\t\tcostSnapshot,\n\t\t\tstatusSnapshot: async () => ({\n\t\t\t\tstatus: 'running',\n\t\t\t\tjobs: (await scheduler.listJobs()).length,\n\t\t\t}),\n\t\t});\n\t\tservices.push({\n\t\t\tname: 'api',\n\t\t\tstart: async () => apiChannel.start(),\n\t\t\tstop: async () => apiChannel.stop(),\n\t\t\thealthCheck: async () => true,\n\t\t});\n\t}\n\n\tconst daemon = createDaemonController({\n\t\tpidFile: resolvePath(app.config.daemon.pidFile, app.mamaHome),\n\t\tservices,\n\t\thealthCheckIntervalMs: app.config.daemon.healthCheckIntervalSeconds * 1000,\n\t});\n\n\tawait daemon.start();\n\tlogger.info('Daemon started', {\n\t\tservices: services.map((service) => service.name),\n\t});\n\n\tconst shutdown = async () => {\n\t\tawait daemon.stop();\n\t\tapp.close();\n\t\tprocess.exit(0);\n\t};\n\tprocess.on('SIGINT', () => void shutdown());\n\tprocess.on('SIGTERM', () => void shutdown());\n\tawait new Promise<void>(() => undefined);\n}\n\nprogram.name('mama').description('Mama ‚Äî Personal AI Agent').version('0.1.0');\n\nprogram\n\t.command('chat')\n\t.description('Start interactive chat with Mama')\n\t.option('-c, --config <path>', 'Path to config file')\n\t.action(async (options: { config?: string }) => {\n\t\ttry {\n\t\t\tawait runChat(options.config);\n\t\t} catch (error) {\n\t\t\tprocess.stderr.write(`Error: ${error instanceof Error ? error.message : String(error)}\\n`);\n\t\t\tprocess.exitCode = 1;\n\t\t}\n\t});\n\nconst daemonCommand = program\n\t.command('daemon')\n\t.description('Run Mama in headless daemon mode')\n\t.option('-c, --config <path>', 'Path to config file')\n\t.option('--foreground', 'Run in foreground process');\n\ndaemonCommand.action(async (options: { config?: string }) => {\n\ttry {\n\t\tawait runDaemonForeground(options.config);\n\t} catch (error) {\n\t\tprocess.stderr.write(`Error: ${error instanceof Error ? error.message : String(error)}\\n`);\n\t\tprocess.exitCode = 1;\n\t}\n});\n\ndaemonCommand\n\t.command('start')\n\t.option('-c, --config <path>', 'Path to config file')\n\t.description('Start daemon as background process')\n\t.action((options: { config?: string }) => {\n\t\tconst config = initAppConfig(options.config);\n\t\tconst mamaHome = ensureMamaHome();\n\t\tconst pidFile = resolvePath(config.daemon.pidFile, mamaHome);\n\t\tconst status = getDaemonStatus(pidFile);\n\t\tif (status.running) {\n\t\t\tprocess.stdout.write(`Daemon already running (pid ${status.pid})\\n`);\n\t\t\treturn;\n\t\t}\n\t\tconst args = [process.argv[1] ?? 'dist/index.js', 'daemon', '--foreground'];\n\t\tif (options.config) {\n\t\t\targs.push('--config', options.config);\n\t\t}\n\t\tconst pid = startDetachedDaemonProcess({\n\t\t\tcommand: process.execPath,\n\t\t\targs,\n\t\t\tcwd: process.cwd(),\n\t\t});\n\t\tprocess.stdout.write(`Daemon started (pid ${pid}).\\n`);\n\t});\n\ndaemonCommand\n\t.command('stop')\n\t.option('-c, --config <path>', 'Path to config file')\n\t.description('Stop daemon process')\n\t.action((options: { config?: string }) => {\n\t\tconst config = initAppConfig(options.config);\n\t\tconst mamaHome = ensureMamaHome();\n\t\tconst pidFile = resolvePath(config.daemon.pidFile, mamaHome);\n\t\tconst stopped = stopDaemonProcess(pidFile);\n\t\tprocess.stdout.write(stopped ? 'Stop signal sent.\\n' : 'Daemon is not running.\\n');\n\t});\n\ndaemonCommand\n\t.command('status')\n\t.option('-c, --config <path>', 'Path to config file')\n\t.description('Check daemon status')\n\t.action((options: { config?: string }) => {\n\t\tconst config = initAppConfig(options.config);\n\t\tconst mamaHome = ensureMamaHome();\n\t\tconst pidFile = resolvePath(config.daemon.pidFile, mamaHome);\n\t\tconst status = getDaemonStatus(pidFile);\n\t\tprocess.stdout.write(status.running ? `running (pid ${status.pid})\\n` : 'not running\\n');\n\t});\n\ndaemonCommand\n\t.command('logs')\n\t.option('-c, --config <path>', 'Path to config file')\n\t.option('-n, --lines <n>', 'Number of lines', (value: string) => Number.parseInt(value, 10), 100)\n\t.description('Show daemon logs')\n\t.action((options: { config?: string; lines: number }) => {\n\t\tconst config = initAppConfig(options.config);\n\t\tconst mamaHome = ensureMamaHome();\n\t\tconst logs = readDaemonLogs(resolvePath(config.logging.file, mamaHome), options.lines);\n\t\tprocess.stdout.write(`${logs}\\n`);\n\t});\n\nregisterMemoryCommands(program, {\n\tasync resolveServices(configPath?: string) {\n\t\tconst app = createAppRuntime(configPath, true);\n\t\treturn {\n\t\t\tstore: app.runtime.memoryStore,\n\t\t\tepisodic: app.runtime.episodicMemory,\n\t\t\tconsolidated: app.runtime.consolidatedMemory,\n\t\t\tconsolidation: app.runtime.consolidationEngine,\n\t\t\tclose() {\n\t\t\t\tapp.close();\n\t\t\t},\n\t\t};\n\t},\n});\n\nregisterJobsCommands(program, {\n\tasync resolveScheduler(configPath?: string) {\n\t\tconst app = createAppRuntime(configPath, true);\n\t\tconst scheduler = await createScheduler(app);\n\t\tsetScheduler(scheduler);\n\t\treturn {\n\t\t\tscheduler,\n\t\t\tclose() {\n\t\t\t\tscheduler.stop();\n\t\t\t\tapp.close();\n\t\t\t},\n\t\t};\n\t},\n});\n\nregisterCostCommand(program, {\n\tasync resolveTracker(configPath?: string) {\n\t\tconst app = createAppRuntime(configPath, true);\n\t\treturn {\n\t\t\ttracker: app.runtime.router.getCostTracker(),\n\t\t\tclose() {\n\t\t\t\tapp.close();\n\t\t\t},\n\t\t};\n\t},\n});\n\nregisterInitCommand(program);\n\nprogram.action(() => {\n\tprogram.commands.find((command) => command.name() === 'chat')?.parse(process.argv);\n});\n\nprogram.parse();\n","import { randomUUID } from 'node:crypto';\nimport { createServer, type IncomingMessage, type Server, type ServerResponse } from 'node:http';\nimport type { createAgent } from '../core/agent.js';\nimport type { createAuditStore } from '../sandbox/audit.js';\nimport type { CronScheduler } from '../scheduler/cron.js';\nimport { createLogger } from '../utils/logger.js';\nimport type { Channel } from './types.js';\n\nconst logger = createLogger('channel:api');\n\ninterface ApiRequest {\n\tmethod: string;\n\tpathname: string;\n\tsearchParams: URLSearchParams;\n\theaders: Record<string, string | undefined>;\n\tbody?: string;\n}\n\ninterface ApiResponse {\n\tstatus: number;\n\tbody: unknown;\n}\n\ninterface ApiCostSnapshot {\n\ttodayCostUsd: number;\n\tmonthCostUsd: number;\n\ttotalCostUsd: number;\n\trecords: number;\n}\n\ninterface ApiChannelOptions {\n\thost: string;\n\tport: number;\n\ttoken?: string;\n\tagent: ReturnType<typeof createAgent>;\n\tscheduler?: CronScheduler;\n\tauditStore?: ReturnType<typeof createAuditStore>;\n\tmemorySearch?: (query: string) => Promise<string>;\n\tcostSnapshot?: () => ApiCostSnapshot;\n\tstatusSnapshot?: () => Promise<unknown> | unknown;\n}\n\ninterface ApiChannel extends Channel {\n\tname: 'api';\n\tgetToken(): string;\n\tgetPort(): number | null;\n}\n\nfunction json(res: ServerResponse, statusCode: number, payload: unknown): void {\n\tres.statusCode = statusCode;\n\tres.setHeader('content-type', 'application/json');\n\tres.end(JSON.stringify(payload));\n}\n\nfunction readBody(req: IncomingMessage): Promise<string> {\n\treturn new Promise((resolve, reject) => {\n\t\tconst chunks: Buffer[] = [];\n\t\treq.on('data', (chunk) => chunks.push(Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk)));\n\t\treq.on('end', () => resolve(Buffer.concat(chunks).toString('utf-8')));\n\t\treq.on('error', reject);\n\t});\n}\n\nfunction parseJsonBody(body: string | undefined): Record<string, unknown> {\n\tif (!body) return {};\n\ttry {\n\t\tconst parsed = JSON.parse(body) as unknown;\n\t\tif (parsed && typeof parsed === 'object') {\n\t\t\treturn parsed as Record<string, unknown>;\n\t\t}\n\t\treturn {};\n\t} catch {\n\t\treturn {};\n\t}\n}\n\nfunction extractBearerToken(header: string | undefined): string | null {\n\tif (!header) return null;\n\tconst trimmed = header.trim();\n\tif (!trimmed.startsWith('Bearer ')) return null;\n\treturn trimmed.slice(7).trim();\n}\n\nfunction isLocalhostHost(host: string): boolean {\n\treturn host === '127.0.0.1' || host === 'localhost';\n}\n\nexport function createApiRequestHandler(options: {\n\ttoken: string;\n\tagent: ReturnType<typeof createAgent>;\n\tscheduler?: CronScheduler;\n\tauditStore?: ReturnType<typeof createAuditStore>;\n\tmemorySearch?: (query: string) => Promise<string>;\n\tcostSnapshot?: () => ApiCostSnapshot;\n\tstatusSnapshot?: () => Promise<unknown> | unknown;\n}) {\n\treturn async function handle(request: ApiRequest): Promise<ApiResponse> {\n\t\tconst authToken = extractBearerToken(request.headers.authorization);\n\t\tif (authToken !== options.token) {\n\t\t\treturn { status: 401, body: { error: 'Unauthorized' } };\n\t\t}\n\n\t\tif (request.method === 'POST' && request.pathname === '/api/message') {\n\t\t\tconst body = parseJsonBody(request.body);\n\t\t\tconst message = String(body.message ?? '').trim();\n\t\t\tif (!message) {\n\t\t\t\treturn { status: 400, body: { error: 'message is required' } };\n\t\t\t}\n\t\t\tconst response = await options.agent.processMessage(message, 'api');\n\t\t\treturn {\n\t\t\t\tstatus: 200,\n\t\t\t\tbody: {\n\t\t\t\t\tcontent: response.content,\n\t\t\t\t\tmodel: response.model,\n\t\t\t\t\tprovider: response.provider,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tif (request.method === 'GET' && request.pathname === '/api/status') {\n\t\t\tconst status = (typeof options.statusSnapshot === 'function' &&\n\t\t\t\t(await options.statusSnapshot())) || {\n\t\t\t\tstatus: 'ok',\n\t\t\t};\n\t\t\treturn { status: 200, body: status };\n\t\t}\n\n\t\tif (request.method === 'GET' && request.pathname === '/api/jobs') {\n\t\t\tconst jobs = options.scheduler ? await options.scheduler.listJobs() : [];\n\t\t\treturn { status: 200, body: { jobs } };\n\t\t}\n\n\t\tif (request.method === 'POST' && request.pathname === '/api/jobs') {\n\t\t\tif (!options.scheduler) {\n\t\t\t\treturn { status: 503, body: { error: 'Scheduler unavailable' } };\n\t\t\t}\n\t\t\tconst body = parseJsonBody(request.body);\n\t\t\tconst schedule = String(body.schedule ?? '').trim();\n\t\t\tconst task = String(body.task ?? '').trim();\n\t\t\tconst name = typeof body.name === 'string' ? body.name : undefined;\n\t\t\tif (!schedule || !task) {\n\t\t\t\treturn { status: 400, body: { error: 'schedule and task are required' } };\n\t\t\t}\n\t\t\tconst id = await options.scheduler.createJob({ name, schedule, task });\n\t\t\treturn { status: 201, body: { id } };\n\t\t}\n\n\t\tif (request.method === 'GET' && request.pathname === '/api/audit') {\n\t\t\tif (!options.auditStore) {\n\t\t\t\treturn { status: 503, body: { error: 'Audit store unavailable' } };\n\t\t\t}\n\t\t\tconst limitRaw = request.searchParams.get('limit');\n\t\t\tconst limit = Math.max(1, Math.min(100, Number.parseInt(limitRaw ?? '20', 10) || 20));\n\t\t\tconst entries = options.auditStore.getRecent(limit);\n\t\t\treturn { status: 200, body: { entries } };\n\t\t}\n\n\t\tif (request.method === 'GET' && request.pathname === '/api/memory/search') {\n\t\t\tif (!options.memorySearch) {\n\t\t\t\treturn { status: 503, body: { error: 'Memory search unavailable' } };\n\t\t\t}\n\t\t\tconst q = request.searchParams.get('q')?.trim() ?? '';\n\t\t\tif (!q) {\n\t\t\t\treturn { status: 400, body: { error: 'q is required' } };\n\t\t\t}\n\t\t\tconst result = await options.memorySearch(q);\n\t\t\treturn { status: 200, body: { result } };\n\t\t}\n\n\t\tif (request.method === 'GET' && request.pathname === '/api/cost') {\n\t\t\tif (!options.costSnapshot) {\n\t\t\t\treturn { status: 503, body: { error: 'Cost tracker unavailable' } };\n\t\t\t}\n\t\t\treturn { status: 200, body: options.costSnapshot() };\n\t\t}\n\n\t\treturn { status: 404, body: { error: 'Not found' } };\n\t};\n}\n\nexport function createApiChannel(options: ApiChannelOptions): ApiChannel {\n\tif (!isLocalhostHost(options.host)) {\n\t\tthrow new Error('API channel must bind to localhost (127.0.0.1 or localhost).');\n\t}\n\n\tconst token = options.token?.trim() ? options.token : randomUUID();\n\tconst handler = createApiRequestHandler({\n\t\ttoken,\n\t\tagent: options.agent,\n\t\tscheduler: options.scheduler,\n\t\tauditStore: options.auditStore,\n\t\tmemorySearch: options.memorySearch,\n\t\tcostSnapshot: options.costSnapshot,\n\t\tstatusSnapshot: options.statusSnapshot,\n\t});\n\tlet server: Server | null = null;\n\tlet boundPort: number | null = null;\n\n\treturn {\n\t\tname: 'api',\n\t\tasync start(): Promise<void> {\n\t\t\tserver = createServer(async (req, res) => {\n\t\t\t\ttry {\n\t\t\t\t\tif (!req.url || !req.method) {\n\t\t\t\t\t\tjson(res, 404, { error: 'Not found' });\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tconst parsed = new URL(req.url, `http://${options.host}:${options.port}`);\n\t\t\t\t\tconst response = await handler({\n\t\t\t\t\t\tmethod: req.method,\n\t\t\t\t\t\tpathname: parsed.pathname,\n\t\t\t\t\t\tsearchParams: parsed.searchParams,\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\tauthorization: req.headers.authorization,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tbody: await readBody(req),\n\t\t\t\t\t});\n\t\t\t\t\tjson(res, response.status, response.body);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tjson(res, 500, {\n\t\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tawait new Promise<void>((resolve, reject) => {\n\t\t\t\tserver?.once('error', reject);\n\t\t\t\tserver?.listen(options.port, options.host, () => {\n\t\t\t\t\tconst address = server?.address();\n\t\t\t\t\tif (address && typeof address !== 'string') {\n\t\t\t\t\t\tboundPort = address.port;\n\t\t\t\t\t}\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tlogger.info('API channel started', {\n\t\t\t\thost: options.host,\n\t\t\t\tport: boundPort ?? options.port,\n\t\t\t});\n\t\t},\n\t\tasync stop(): Promise<void> {\n\t\t\tif (!server) return;\n\t\t\tawait new Promise<void>((resolve, reject) => {\n\t\t\t\tserver?.close((error) => {\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t});\n\t\t\tserver = null;\n\t\t\tboundPort = null;\n\t\t\tlogger.info('API channel stopped');\n\t\t},\n\t\tgetToken(): string {\n\t\t\treturn token;\n\t\t},\n\t\tgetPort(): number | null {\n\t\t\treturn boundPort;\n\t\t},\n\t};\n}\n\nexport type { ApiChannel, ApiChannelOptions, ApiCostSnapshot, ApiRequest, ApiResponse };\n","import { appendFileSync, existsSync, mkdirSync } from 'node:fs';\nimport { dirname } from 'node:path';\nimport type { LogLevel } from '../config/schema.js';\n\nconst LOG_LEVELS: Record<LogLevel, number> = {\n\tdebug: 0,\n\tinfo: 1,\n\twarn: 2,\n\terror: 3,\n};\n\ninterface LogEntry {\n\ttimestamp: string;\n\tlevel: LogLevel;\n\tmodule: string;\n\tmessage: string;\n\t[key: string]: unknown;\n}\n\ninterface LoggerOptions {\n\tlevel: LogLevel;\n\tfilePath?: string;\n\tsilent?: boolean;\n}\n\ninterface Logger {\n\tdebug: (message: string, context?: Record<string, unknown>) => void;\n\tinfo: (message: string, context?: Record<string, unknown>) => void;\n\twarn: (message: string, context?: Record<string, unknown>) => void;\n\terror: (message: string, context?: Record<string, unknown>) => void;\n}\n\nlet _globalOptions: LoggerOptions = { level: 'info' };\n\n/**\n * Initializes global logger settings. Call once at startup.\n */\nexport function initLogger(options: LoggerOptions): void {\n\t_globalOptions = options;\n\tif (options.filePath) {\n\t\tconst dir = dirname(options.filePath);\n\t\tif (!existsSync(dir)) {\n\t\t\tmkdirSync(dir, { recursive: true });\n\t\t}\n\t}\n}\n\nfunction shouldLog(level: LogLevel): boolean {\n\treturn LOG_LEVELS[level] >= LOG_LEVELS[_globalOptions.level];\n}\n\nfunction formatForStderr(entry: LogEntry): string {\n\tconst { timestamp, level, module, message, ...rest } = entry;\n\tconst time = timestamp.split('T')[1]?.replace('Z', '') ?? timestamp;\n\tconst prefix = `${time} [${level.toUpperCase().padEnd(5)}] [${module}]`;\n\tconst extra = Object.keys(rest).length > 0 ? ` ${JSON.stringify(rest)}` : '';\n\treturn `${prefix} ${message}${extra}`;\n}\n\nfunction writeLog(entry: LogEntry): void {\n\t// Write JSON to file\n\tif (_globalOptions.filePath) {\n\t\ttry {\n\t\t\tappendFileSync(_globalOptions.filePath, `${JSON.stringify(entry)}\\n`);\n\t\t} catch {\n\t\t\t// Silently fail file logging ‚Äî don't crash the agent\n\t\t}\n\t}\n\n\t// Pretty print to stderr (unless silent)\n\tif (!_globalOptions.silent) {\n\t\tconst formatted = formatForStderr(entry);\n\t\tprocess.stderr.write(`${formatted}\\n`);\n\t}\n}\n\n/**\n * Creates a scoped logger for a specific module.\n */\nexport function createLogger(moduleName: string): Logger {\n\tfunction log(level: LogLevel, message: string, context?: Record<string, unknown>): void {\n\t\tif (!shouldLog(level)) return;\n\n\t\tconst entry: LogEntry = {\n\t\t\ttimestamp: new Date().toISOString(),\n\t\t\tlevel,\n\t\t\tmodule: moduleName,\n\t\t\tmessage,\n\t\t\t...context,\n\t\t};\n\n\t\twriteLog(entry);\n\t}\n\n\treturn {\n\t\tdebug: (message, context) => log('debug', message, context),\n\t\tinfo: (message, context) => log('info', message, context),\n\t\twarn: (message, context) => log('warn', message, context),\n\t\terror: (message, context) => log('error', message, context),\n\t};\n}\n\n/**\n * Resets logger to defaults (for testing).\n */\nexport function resetLogger(): void {\n\t_globalOptions = { level: 'info' };\n}\n","import { mkdirSync, writeFileSync } from 'node:fs';\nimport { basename, join } from 'node:path';\nimport { setTimeout as sleep } from 'node:timers/promises';\nimport type { createAgent } from '../core/agent.js';\nimport type { createAuditStore } from '../sandbox/audit.js';\nimport type { ApprovalRequest } from '../sandbox/types.js';\nimport type { CronScheduler } from '../scheduler/cron.js';\nimport { createLogger } from '../utils/logger.js';\nimport type { Channel } from './types.js';\n\nconst logger = createLogger('channel:telegram');\n\nconst TELEGRAM_MESSAGE_LIMIT = 4096;\nconst APPROVAL_TIMEOUT_MS = 5 * 60_000;\n\ntype NotificationPriority = 'low' | 'normal' | 'high' | 'urgent';\n\ninterface TelegramIncomingMessage {\n\tchatId: number;\n\tfromId: number;\n\ttext?: string;\n\tdocument?: {\n\t\tfileName: string;\n\t\tcontent: string;\n\t};\n\tvoice?: boolean;\n}\n\ninterface TelegramCallback {\n\tchatId: number;\n\tfromId: number;\n\tdata: string;\n}\n\ninterface TelegramAdapter {\n\tstart(handlers: {\n\t\tonMessage: (message: TelegramIncomingMessage) => Promise<void>;\n\t\tonCallback: (callback: TelegramCallback) => Promise<void>;\n\t}): Promise<void>;\n\tstop(): Promise<void>;\n\tsendMessage(\n\t\tchatId: number,\n\t\ttext: string,\n\t\toptions?: {\n\t\t\tparseMode?: 'Markdown';\n\t\t\tdisableNotification?: boolean;\n\t\t\treplyMarkup?: {\n\t\t\t\tinline_keyboard: Array<Array<{ text: string; callback_data: string }>>;\n\t\t\t};\n\t\t},\n\t): Promise<void>;\n}\n\ninterface ApprovalCapableSandbox {\n\tsetApprovalHandler(handler: (request: ApprovalRequest) => Promise<boolean>): void;\n}\n\ninterface TelegramCostSnapshot {\n\ttodayCostUsd: number;\n\tmonthCostUsd: number;\n\ttotalCostUsd: number;\n}\n\ninterface TelegramChannelOptions {\n\ttoken: string;\n\tallowedUserIds: number[];\n\tworkspacePath: string;\n\tagent: ReturnType<typeof createAgent>;\n\tadapter: TelegramAdapter;\n\tsandbox?: ApprovalCapableSandbox;\n\tscheduler?: CronScheduler;\n\tauditStore?: ReturnType<typeof createAuditStore>;\n\tmemorySearch?: (query: string) => Promise<string>;\n\tcostSnapshot?: () => TelegramCostSnapshot;\n\tstatusSnapshot?: () => Promise<string> | string;\n}\n\ninterface PendingApproval {\n\tid: string;\n\tchatId: number;\n\tresolve: (approved: boolean) => void;\n\ttimeout: NodeJS.Timeout;\n\tkey: string;\n}\n\ninterface TelegramChannel extends Channel {\n\tname: 'telegram';\n\thandleIncoming(message: TelegramIncomingMessage): Promise<void>;\n\thandleCallback(callback: TelegramCallback): Promise<void>;\n\tsendProactiveMessage(\n\t\tchatId: number,\n\t\ttext: string,\n\t\tpriority?: NotificationPriority,\n\t): Promise<void>;\n}\n\nfunction splitMessage(text: string, limit = TELEGRAM_MESSAGE_LIMIT): string[] {\n\tif (text.length <= limit) return [text];\n\tconst lines = text.split('\\n');\n\tconst chunks: string[] = [];\n\tlet current = '';\n\tfor (const line of lines) {\n\t\tif (line.length > limit) {\n\t\t\tif (current) {\n\t\t\t\tchunks.push(current);\n\t\t\t\tcurrent = '';\n\t\t\t}\n\t\t\tfor (let i = 0; i < line.length; i += limit) {\n\t\t\t\tchunks.push(line.slice(i, i + limit));\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\tif ((current + (current ? '\\n' : '') + line).length > limit) {\n\t\t\tif (current) chunks.push(current);\n\t\t\tcurrent = line;\n\t\t\tcontinue;\n\t\t}\n\t\tcurrent = current ? `${current}\\n${line}` : line;\n\t}\n\tif (current) chunks.push(current);\n\treturn chunks.length > 0 ? chunks : [text.slice(0, limit)];\n}\n\nfunction approvalKey(request: ApprovalRequest): string {\n\treturn `${request.capability}:${request.action}:${request.resource}`;\n}\n\nfunction isAuthorized(allowedUserIds: number[], fromId: number): boolean {\n\treturn allowedUserIds.includes(fromId);\n}\n\nfunction renderApprovalMessage(request: ApprovalRequest): string {\n\treturn [\n\t\t'üîí Permission Request',\n\t\t`Action: ${request.capability}:${request.action}`,\n\t\t`Path/Resource: ${request.resource}`,\n\t].join('\\n');\n}\n\nfunction normalizeDocumentName(fileName: string): string {\n\treturn basename(fileName).replace(/[^\\w.-]/g, '_');\n}\n\nasync function sendChunked(\n\tadapter: TelegramAdapter,\n\tchatId: number,\n\ttext: string,\n\toptions: { markdown?: boolean; disableNotification?: boolean } = {},\n): Promise<void> {\n\tconst chunks = splitMessage(text);\n\tfor (const chunk of chunks) {\n\t\tawait adapter.sendMessage(chatId, chunk, {\n\t\t\tparseMode: options.markdown ? 'Markdown' : undefined,\n\t\t\tdisableNotification: options.disableNotification,\n\t\t});\n\t}\n}\n\nexport function createTelegramChannel(options: TelegramChannelOptions): TelegramChannel {\n\tconst pendingById = new Map<string, PendingApproval>();\n\tconst alwaysApproved = new Set<string>();\n\tconst chatByUser = new Map<number, number>();\n\n\tasync function handleIncoming(message: TelegramIncomingMessage): Promise<void> {\n\t\tif (!isAuthorized(options.allowedUserIds, message.fromId)) {\n\t\t\treturn;\n\t\t}\n\t\tchatByUser.set(message.fromId, message.chatId);\n\n\t\tif (message.voice) {\n\t\t\tawait sendChunked(\n\t\t\t\toptions.adapter,\n\t\t\t\tmessage.chatId,\n\t\t\t\t'Voice messages are not supported yet. Please send text for now.',\n\t\t\t);\n\t\t\treturn;\n\t\t}\n\n\t\tif (message.document) {\n\t\t\tmkdirSync(options.workspacePath, { recursive: true });\n\t\t\tconst fileName = normalizeDocumentName(message.document.fileName);\n\t\t\tconst targetPath = join(options.workspacePath, fileName);\n\t\t\twriteFileSync(targetPath, message.document.content, 'utf-8');\n\t\t\tconst response = await options.agent.processMessage(\n\t\t\t\t`A document was uploaded to ${targetPath}. Please review and process it.`,\n\t\t\t\t'telegram',\n\t\t\t);\n\t\t\tawait sendChunked(options.adapter, message.chatId, response.content, { markdown: true });\n\t\t\treturn;\n\t\t}\n\n\t\tconst text = message.text?.trim() ?? '';\n\t\tif (!text) return;\n\n\t\tif (text.startsWith('/')) {\n\t\t\tawait handleCommand(message.chatId, text);\n\t\t\treturn;\n\t\t}\n\n\t\tconst response = await options.agent.processMessage(text, 'telegram');\n\t\tawait sendChunked(options.adapter, message.chatId, response.content, { markdown: true });\n\t}\n\n\tasync function handleCommand(chatId: number, input: string): Promise<void> {\n\t\tconst [command, ...args] = input.trim().split(/\\s+/);\n\n\t\tswitch (command) {\n\t\t\tcase '/status': {\n\t\t\t\tconst status =\n\t\t\t\t\t(typeof options.statusSnapshot === 'function' && (await options.statusSnapshot())) ||\n\t\t\t\t\t'Mama is running.';\n\t\t\t\tawait sendChunked(options.adapter, chatId, String(status));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tcase '/jobs': {\n\t\t\t\tif (!options.scheduler) {\n\t\t\t\t\tawait sendChunked(options.adapter, chatId, 'Scheduler is not enabled.');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst jobs = await options.scheduler.listJobs();\n\t\t\t\tif (jobs.length === 0) {\n\t\t\t\t\tawait sendChunked(options.adapter, chatId, 'No scheduled jobs.');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst lines = jobs.map(\n\t\t\t\t\t(job) =>\n\t\t\t\t\t\t`- ${job.id} | ${job.enabled ? 'enabled' : 'disabled'} | ${job.schedule} | ${job.name}`,\n\t\t\t\t);\n\t\t\t\tawait sendChunked(options.adapter, chatId, lines.join('\\n'));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tcase '/audit': {\n\t\t\t\tif (!options.auditStore) {\n\t\t\t\t\tawait sendChunked(options.adapter, chatId, 'Audit store is not available.');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst entries = options.auditStore.getRecent(10);\n\t\t\t\tconst lines = entries.map(\n\t\t\t\t\t(entry) =>\n\t\t\t\t\t\t`- ${entry.timestamp.toISOString()} ${entry.capability}:${entry.action} ${entry.result}`,\n\t\t\t\t);\n\t\t\t\tawait sendChunked(options.adapter, chatId, lines.join('\\n') || 'No audit entries.');\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tcase '/cost': {\n\t\t\t\tif (!options.costSnapshot) {\n\t\t\t\t\tawait sendChunked(options.adapter, chatId, 'Cost tracker is not available.');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst cost = options.costSnapshot();\n\t\t\t\tawait sendChunked(\n\t\t\t\t\toptions.adapter,\n\t\t\t\t\tchatId,\n\t\t\t\t\t[\n\t\t\t\t\t\t`Today: $${cost.todayCostUsd.toFixed(4)}`,\n\t\t\t\t\t\t`This month: $${cost.monthCostUsd.toFixed(4)}`,\n\t\t\t\t\t\t`Total: $${cost.totalCostUsd.toFixed(4)}`,\n\t\t\t\t\t].join('\\n'),\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tcase '/memory': {\n\t\t\t\tif (!options.memorySearch) {\n\t\t\t\t\tawait sendChunked(options.adapter, chatId, 'Memory search is not available.');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst query = args.join(' ').trim();\n\t\t\t\tif (!query) {\n\t\t\t\t\tawait sendChunked(options.adapter, chatId, 'Usage: /memory <query>');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst result = await options.memorySearch(query);\n\t\t\t\tawait sendChunked(options.adapter, chatId, result);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\tawait sendChunked(options.adapter, chatId, `Unknown command: ${command}`);\n\t\t}\n\t}\n\n\tasync function handleCallback(callback: TelegramCallback): Promise<void> {\n\t\tif (!isAuthorized(options.allowedUserIds, callback.fromId)) {\n\t\t\treturn;\n\t\t}\n\t\tconst [action, approvalId] = callback.data.split(':');\n\t\tif (!approvalId) return;\n\t\tconst pending = pendingById.get(approvalId);\n\t\tif (!pending) return;\n\n\t\tclearTimeout(pending.timeout);\n\t\tpendingById.delete(approvalId);\n\n\t\tif (action === 'always') {\n\t\t\talwaysApproved.add(pending.key);\n\t\t\tpending.resolve(true);\n\t\t\tawait sendChunked(options.adapter, callback.chatId, 'Approved and stored as always allow.');\n\t\t\treturn;\n\t\t}\n\n\t\tconst approved = action === 'approve';\n\t\tpending.resolve(approved);\n\t\tawait sendChunked(options.adapter, callback.chatId, approved ? 'Approved.' : 'Denied.');\n\t}\n\n\tasync function sendProactiveMessage(\n\t\tchatId: number,\n\t\ttext: string,\n\t\tpriority: NotificationPriority = 'normal',\n\t): Promise<void> {\n\t\tif (priority === 'urgent') {\n\t\t\tfor (let i = 0; i < 2; i++) {\n\t\t\t\tawait sendChunked(options.adapter, chatId, text);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tconst disableNotification = priority === 'low';\n\t\tawait sendChunked(options.adapter, chatId, text, { disableNotification });\n\t}\n\n\tfunction bindSandboxApproval(): void {\n\t\tif (!options.sandbox) return;\n\t\toptions.sandbox.setApprovalHandler(async (request) => {\n\t\t\tconst key = approvalKey(request);\n\t\t\tif (alwaysApproved.has(key)) return true;\n\n\t\t\tconst chatId = chatByUser.get(options.allowedUserIds[0] ?? -1);\n\t\t\tif (!chatId) return false;\n\n\t\t\tconst id = Math.random().toString(36).slice(2, 10);\n\t\t\tawait options.adapter.sendMessage(chatId, renderApprovalMessage(request), {\n\t\t\t\treplyMarkup: {\n\t\t\t\t\tinline_keyboard: [\n\t\t\t\t\t\t[\n\t\t\t\t\t\t\t{ text: '‚úÖ Approve', callback_data: `approve:${id}` },\n\t\t\t\t\t\t\t{ text: '‚ùå Deny', callback_data: `deny:${id}` },\n\t\t\t\t\t\t\t{ text: 'üîì Always', callback_data: `always:${id}` },\n\t\t\t\t\t\t],\n\t\t\t\t\t],\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn new Promise<boolean>((resolve) => {\n\t\t\t\tconst timeout = setTimeout(() => {\n\t\t\t\t\tpendingById.delete(id);\n\t\t\t\t\tresolve(false);\n\t\t\t\t}, APPROVAL_TIMEOUT_MS);\n\n\t\t\t\tpendingById.set(id, { id, chatId, resolve, timeout, key });\n\t\t\t});\n\t\t});\n\t}\n\n\treturn {\n\t\tname: 'telegram',\n\t\tasync start(): Promise<void> {\n\t\t\tif (!options.token) {\n\t\t\t\tthrow new Error('Telegram token is required');\n\t\t\t}\n\t\t\tbindSandboxApproval();\n\t\t\tawait options.adapter.start({\n\t\t\t\tonMessage: handleIncoming,\n\t\t\t\tonCallback: handleCallback,\n\t\t\t});\n\t\t\tlogger.info('Telegram channel started');\n\t\t},\n\t\tasync stop(): Promise<void> {\n\t\t\tfor (const pending of pendingById.values()) {\n\t\t\t\tclearTimeout(pending.timeout);\n\t\t\t\tpending.resolve(false);\n\t\t\t}\n\t\t\tpendingById.clear();\n\t\t\tawait options.adapter.stop();\n\t\t\tlogger.info('Telegram channel stopped');\n\t\t},\n\t\thandleIncoming,\n\t\thandleCallback,\n\t\tsendProactiveMessage,\n\t};\n}\n\ninterface TelegramHttpUpdate {\n\tupdate_id: number;\n\tmessage?: {\n\t\tchat?: { id: number };\n\t\tfrom?: { id: number };\n\t\ttext?: string;\n\t\tvoice?: unknown;\n\t\tdocument?: { file_id?: string; file_name?: string };\n\t};\n\tcallback_query?: {\n\t\tfrom?: { id: number };\n\t\tdata?: string;\n\t\tmessage?: { chat?: { id: number } };\n\t};\n}\n\ninterface TelegramApiResponse<T> {\n\tok: boolean;\n\tresult: T;\n}\n\nasync function telegramApi<T>(\n\ttoken: string,\n\tmethod: string,\n\tpayload: Record<string, unknown>,\n): Promise<T> {\n\tconst response = await fetch(`https://api.telegram.org/bot${token}/${method}`, {\n\t\tmethod: 'POST',\n\t\theaders: { 'content-type': 'application/json' },\n\t\tbody: JSON.stringify(payload),\n\t});\n\tif (!response.ok) {\n\t\tthrow new Error(`Telegram API ${method} failed with HTTP ${response.status}`);\n\t}\n\tconst data = (await response.json()) as TelegramApiResponse<T>;\n\tif (!data.ok) {\n\t\tthrow new Error(`Telegram API ${method} returned ok=false`);\n\t}\n\treturn data.result;\n}\n\nasync function downloadTelegramDocument(token: string, fileId: string): Promise<string> {\n\tconst result = await telegramApi<{ file_path?: string }>(token, 'getFile', { file_id: fileId });\n\tconst filePath = result.file_path;\n\tif (!filePath) return '';\n\tconst response = await fetch(`https://api.telegram.org/file/bot${token}/${filePath}`);\n\tif (!response.ok) return '';\n\treturn await response.text();\n}\n\nexport function createTelegramHttpAdapter(token: string): TelegramAdapter {\n\tlet running = false;\n\tlet offset = 0;\n\tlet pollLoop: Promise<void> | null = null;\n\n\treturn {\n\t\tasync start(handlers): Promise<void> {\n\t\t\trunning = true;\n\t\t\tpollLoop = (async () => {\n\t\t\t\twhile (running) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst updates = await telegramApi<TelegramHttpUpdate[]>(token, 'getUpdates', {\n\t\t\t\t\t\t\ttimeout: 20,\n\t\t\t\t\t\t\toffset,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tfor (const update of updates) {\n\t\t\t\t\t\t\toffset = Math.max(offset, update.update_id + 1);\n\t\t\t\t\t\t\tconst message = update.message;\n\t\t\t\t\t\t\tif (message?.chat?.id && message.from?.id) {\n\t\t\t\t\t\t\t\tlet documentContent = '';\n\t\t\t\t\t\t\t\tif (message.document?.file_id) {\n\t\t\t\t\t\t\t\t\tdocumentContent = await downloadTelegramDocument(token, message.document.file_id);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tawait handlers.onMessage({\n\t\t\t\t\t\t\t\t\tchatId: message.chat.id,\n\t\t\t\t\t\t\t\t\tfromId: message.from.id,\n\t\t\t\t\t\t\t\t\ttext: message.text,\n\t\t\t\t\t\t\t\t\tvoice: Boolean(message.voice),\n\t\t\t\t\t\t\t\t\tdocument:\n\t\t\t\t\t\t\t\t\t\tmessage.document?.file_name || message.document?.file_id\n\t\t\t\t\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfileName: message.document?.file_name ?? 'document.txt',\n\t\t\t\t\t\t\t\t\t\t\t\t\tcontent: documentContent,\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst callback = update.callback_query;\n\t\t\t\t\t\t\tif (callback?.data && callback.from?.id && callback.message?.chat?.id) {\n\t\t\t\t\t\t\t\tawait handlers.onCallback({\n\t\t\t\t\t\t\t\t\tchatId: callback.message.chat.id,\n\t\t\t\t\t\t\t\t\tfromId: callback.from.id,\n\t\t\t\t\t\t\t\t\tdata: callback.data,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tlogger.warn('Telegram polling error', {\n\t\t\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t\t\t});\n\t\t\t\t\t\tawait sleep(1000);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})();\n\t\t},\n\t\tasync stop(): Promise<void> {\n\t\t\trunning = false;\n\t\t\tif (pollLoop) {\n\t\t\t\tawait pollLoop.catch(() => undefined);\n\t\t\t}\n\t\t\tpollLoop = null;\n\t\t},\n\t\tasync sendMessage(chatId, text, options): Promise<void> {\n\t\t\tawait telegramApi(token, 'sendMessage', {\n\t\t\t\tchat_id: chatId,\n\t\t\t\ttext,\n\t\t\t\tparse_mode: options?.parseMode,\n\t\t\t\tdisable_notification: options?.disableNotification,\n\t\t\t\treply_markup: options?.replyMarkup,\n\t\t\t});\n\t\t},\n\t};\n}\n\nexport type {\n\tNotificationPriority,\n\tTelegramAdapter,\n\tTelegramCallback,\n\tTelegramChannel,\n\tTelegramChannelOptions,\n\tTelegramCostSnapshot,\n\tTelegramIncomingMessage,\n};\n","import { Box, render, Text, useApp, useInput } from 'ink';\nimport TextInput from 'ink-text-input';\nimport { useCallback, useEffect, useRef, useState } from 'react';\nimport type { createAgent } from '../core/agent.js';\nimport type { ExecutionPlan } from '../core/planner.js';\nimport type { AgentEvent } from '../core/types.js';\nimport type { ApprovalRequest } from '../sandbox/types.js';\n\ninterface ChatMessage {\n\tid: string;\n\trole: 'user' | 'assistant' | 'system';\n\tcontent: string;\n\tmodel?: string;\n}\n\ntype PendingDecision =\n\t| {\n\t\t\tkind: 'sandbox';\n\t\t\trequest: ApprovalRequest;\n\t\t\tresolve: (approved: boolean) => void;\n\t  }\n\t| {\n\t\t\tkind: 'plan';\n\t\t\tplan: ExecutionPlan;\n\t\t\tresolve: (approved: boolean) => void;\n\t  };\n\ninterface ApprovalCapableSandbox {\n\tsetApprovalHandler(handler: (request: ApprovalRequest) => Promise<boolean>): void;\n}\n\ninterface AppProps {\n\tagent: ReturnType<typeof createAgent>;\n\tagentName: string;\n\tsandbox?: ApprovalCapableSandbox;\n}\n\nfunction formatPlanForApproval(plan: ExecutionPlan): string {\n\tconst stepLines = plan.steps.map((step) => `- ${step.id}. ${step.description} [${step.tool}]`);\n\tconst riskLine = plan.risks.length > 0 ? `Risks: ${plan.risks.join('; ')}` : 'Risks: none';\n\treturn [\n\t\t'Plan requires approval:',\n\t\t`Goal: ${plan.goal}`,\n\t\t...stepLines,\n\t\t`Estimated duration: ${plan.estimatedDuration}`,\n\t\triskLine,\n\t\t'Approve? (yes/no)',\n\t].join('\\n');\n}\n\nfunction formatEvent(event: AgentEvent): string | null {\n\tswitch (event.type) {\n\t\tcase 'tool_call_started':\n\t\t\treturn `Running tool: ${event.toolName}`;\n\t\tcase 'tool_call_finished':\n\t\t\treturn event.success\n\t\t\t\t? `Tool finished: ${event.toolName}`\n\t\t\t\t: `Tool failed: ${event.toolName}${event.error ? ` (${event.error})` : ''}`;\n\t\tcase 'plan_created':\n\t\t\treturn `Plan created with ${event.plan.steps.length} step(s).`;\n\t\tcase 'plan_approval_requested':\n\t\t\treturn 'Plan has side effects and needs approval.';\n\t\tcase 'plan_step_started':\n\t\t\treturn `Step ${event.stepId} started: ${event.description}`;\n\t\tcase 'plan_step_finished':\n\t\t\treturn `Step ${event.stepId} ${event.status} (${event.percentComplete}%)`;\n\t\tdefault:\n\t\t\treturn null;\n\t}\n}\n\nfunction App({ agent, agentName, sandbox }: AppProps) {\n\tconst messageId = useRef(1);\n\tconst [messages, setMessages] = useState<ChatMessage[]>([\n\t\t{\n\t\t\tid: 'msg-0',\n\t\t\trole: 'system',\n\t\t\tcontent: `${agentName} ready. Type your message. Ctrl+C to exit.`,\n\t\t},\n\t]);\n\tconst [input, setInput] = useState('');\n\tconst [isProcessing, setIsProcessing] = useState(false);\n\tconst [pendingDecision, setPendingDecision] = useState<PendingDecision | null>(null);\n\tconst { exit } = useApp();\n\n\tconst appendMessage = useCallback((message: Omit<ChatMessage, 'id'>) => {\n\t\tconst id = `msg-${messageId.current++}`;\n\t\tsetMessages((prev) => [...prev, { id, ...message }]);\n\t}, []);\n\n\tuseEffect(() => {\n\t\tif (!sandbox) return;\n\t\tsandbox.setApprovalHandler(async (request) => {\n\t\t\treturn new Promise<boolean>((resolve) => {\n\t\t\t\tappendMessage({\n\t\t\t\t\trole: 'system',\n\t\t\t\t\tcontent: `Approval needed (${request.capability}:${request.action}) on \"${request.resource}\". Approve? (yes/no)`,\n\t\t\t\t});\n\t\t\t\tsetPendingDecision({ kind: 'sandbox', request, resolve });\n\t\t\t});\n\t\t});\n\t}, [appendMessage, sandbox]);\n\n\tuseInput((_input, key) => {\n\t\tif (key.ctrl && _input === 'c') {\n\t\t\texit();\n\t\t}\n\t});\n\n\tconst handleSubmit = useCallback(\n\t\tasync (value: string) => {\n\t\t\tconst trimmed = value.trim();\n\t\t\tif (!trimmed) return;\n\n\t\t\tif (pendingDecision) {\n\t\t\t\tconst normalized = trimmed.toLowerCase();\n\t\t\t\tif (!['y', 'yes', 'n', 'no'].includes(normalized)) {\n\t\t\t\t\tappendMessage({\n\t\t\t\t\t\trole: 'system',\n\t\t\t\t\t\tcontent: 'Please answer with yes or no.',\n\t\t\t\t\t});\n\t\t\t\t\tsetInput('');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst approved = normalized === 'y' || normalized === 'yes';\n\t\t\t\tpendingDecision.resolve(approved);\n\t\t\t\tsetPendingDecision(null);\n\t\t\t\tsetInput('');\n\t\t\t\tappendMessage({\n\t\t\t\t\trole: 'system',\n\t\t\t\t\tcontent: approved ? 'Approved.' : 'Denied.',\n\t\t\t\t});\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (isProcessing) return;\n\n\t\t\tsetInput('');\n\t\t\tappendMessage({ role: 'user', content: trimmed });\n\t\t\tsetIsProcessing(true);\n\n\t\t\ttry {\n\t\t\t\tconst response = await agent.processMessage(trimmed, 'terminal', {\n\t\t\t\t\tonEvent(event) {\n\t\t\t\t\t\tconst eventText = formatEvent(event);\n\t\t\t\t\t\tif (eventText) {\n\t\t\t\t\t\t\tappendMessage({ role: 'system', content: eventText });\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tonPlanApproval(plan) {\n\t\t\t\t\t\treturn new Promise<boolean>((resolve) => {\n\t\t\t\t\t\t\tappendMessage({\n\t\t\t\t\t\t\t\trole: 'system',\n\t\t\t\t\t\t\t\tcontent: formatPlanForApproval(plan),\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tsetPendingDecision({ kind: 'plan', plan, resolve });\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t});\n\n\t\t\t\tappendMessage({\n\t\t\t\t\trole: 'assistant',\n\t\t\t\t\tcontent: response.content,\n\t\t\t\t\tmodel: response.model,\n\t\t\t\t});\n\t\t\t} catch (err) {\n\t\t\t\tappendMessage({\n\t\t\t\t\trole: 'system',\n\t\t\t\t\tcontent: `Error: ${err instanceof Error ? err.message : String(err)}`,\n\t\t\t\t});\n\t\t\t} finally {\n\t\t\t\tsetIsProcessing(false);\n\t\t\t}\n\t\t},\n\t\t[agent, appendMessage, isProcessing, pendingDecision],\n\t);\n\n\t// Show last N messages to keep terminal clean\n\tconst visibleMessages = messages.slice(-20);\n\n\treturn (\n\t\t<Box flexDirection=\"column\" padding={1}>\n\t\t\t{/* Header */}\n\t\t\t<Box marginBottom={1}>\n\t\t\t\t<Text bold color=\"magenta\">\n\t\t\t\t\t{'ü§± '}\n\t\t\t\t\t{agentName}\n\t\t\t\t</Text>\n\t\t\t\t<Text color=\"gray\"> ‚Äî Personal AI Agent</Text>\n\t\t\t</Box>\n\n\t\t\t{/* Messages */}\n\t\t\t<Box flexDirection=\"column\" marginBottom={1}>\n\t\t\t\t{visibleMessages.map((msg) => (\n\t\t\t\t\t<Box key={msg.id} marginBottom={0}>\n\t\t\t\t\t\t{msg.role === 'user' && (\n\t\t\t\t\t\t\t<Text>\n\t\t\t\t\t\t\t\t<Text color=\"cyan\" bold>\n\t\t\t\t\t\t\t\t\t{'You: '}\n\t\t\t\t\t\t\t\t</Text>\n\t\t\t\t\t\t\t\t<Text>{msg.content}</Text>\n\t\t\t\t\t\t\t</Text>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{msg.role === 'assistant' && (\n\t\t\t\t\t\t\t<Text>\n\t\t\t\t\t\t\t\t<Text color=\"magenta\" bold>{`${agentName}: `}</Text>\n\t\t\t\t\t\t\t\t<Text>{msg.content}</Text>\n\t\t\t\t\t\t\t\t{msg.model && <Text color=\"gray\">{` [${msg.model}]`}</Text>}\n\t\t\t\t\t\t\t</Text>\n\t\t\t\t\t\t)}\n\t\t\t\t\t\t{msg.role === 'system' && (\n\t\t\t\t\t\t\t<Text color=\"yellow\" dimColor>\n\t\t\t\t\t\t\t\t{msg.content}\n\t\t\t\t\t\t\t</Text>\n\t\t\t\t\t\t)}\n\t\t\t\t\t</Box>\n\t\t\t\t))}\n\t\t\t</Box>\n\n\t\t\t{/* Input */}\n\t\t\t<Box>\n\t\t\t\t{pendingDecision ? (\n\t\t\t\t\t<Box flexDirection=\"column\">\n\t\t\t\t\t\t<Text color=\"yellow\">\n\t\t\t\t\t\t\t{pendingDecision.kind === 'sandbox'\n\t\t\t\t\t\t\t\t? 'Awaiting sandbox approval (yes/no)...'\n\t\t\t\t\t\t\t\t: 'Awaiting plan approval (yes/no)...'}\n\t\t\t\t\t\t</Text>\n\t\t\t\t\t\t<Box>\n\t\t\t\t\t\t\t<Text color=\"cyan\" bold>\n\t\t\t\t\t\t\t\t{'> '}\n\t\t\t\t\t\t\t</Text>\n\t\t\t\t\t\t\t<TextInput value={input} onChange={setInput} onSubmit={handleSubmit} />\n\t\t\t\t\t\t</Box>\n\t\t\t\t\t</Box>\n\t\t\t\t) : isProcessing ? (\n\t\t\t\t\t<Text color=\"yellow\">{'‚è≥ Working...'}</Text>\n\t\t\t\t) : (\n\t\t\t\t\t<Box>\n\t\t\t\t\t\t<Text color=\"cyan\" bold>\n\t\t\t\t\t\t\t{'> '}\n\t\t\t\t\t\t</Text>\n\t\t\t\t\t\t<TextInput value={input} onChange={setInput} onSubmit={handleSubmit} />\n\t\t\t\t\t</Box>\n\t\t\t\t)}\n\t\t\t</Box>\n\t\t</Box>\n\t);\n}\n\n/**\n * Starts the terminal chat interface using Ink.\n */\nexport function startTerminal(\n\tagent: ReturnType<typeof createAgent>,\n\tagentName: string,\n\tsandbox?: ApprovalCapableSandbox,\n): void {\n\tconst instance = render(<App agent={agent} agentName={agentName} sandbox={sandbox} />);\n\tinstance.waitUntilExit().then(() => {\n\t\tprocess.exit(0);\n\t});\n}\n","import type { Command } from 'commander';\nimport type { CostTracker } from '../llm/cost-tracker.js';\nimport type { LLMUsageRecord } from '../llm/types.js';\n\ntype CostPeriod = 'today' | 'week' | 'month' | 'all';\n\ninterface RegisterCostCommandOptions {\n\tresolveTracker(configPath?: string): Promise<{\n\t\ttracker: CostTracker;\n\t\tclose(): void;\n\t}>;\n}\n\nfunction formatUsd(value: number): string {\n\treturn `$${value.toFixed(4)}`;\n}\n\nfunction formatInt(value: number): string {\n\treturn value.toLocaleString('en-US');\n}\n\nfunction recordsForPeriod(tracker: CostTracker, period: CostPeriod): LLMUsageRecord[] {\n\tswitch (period) {\n\t\tcase 'today':\n\t\t\treturn tracker.getUsageToday();\n\t\tcase 'week':\n\t\t\treturn tracker.getUsageThisWeek();\n\t\tcase 'month':\n\t\t\treturn tracker.getUsageThisMonth();\n\t\tdefault:\n\t\t\treturn tracker.getRecords();\n\t}\n}\n\nasync function withTracker<T>(\n\toptions: RegisterCostCommandOptions,\n\tconfigPath: string | undefined,\n\trun: (tracker: CostTracker) => Promise<T>,\n): Promise<T> {\n\tconst services = await options.resolveTracker(configPath);\n\ttry {\n\t\treturn await run(services.tracker);\n\t} finally {\n\t\tservices.close();\n\t}\n}\n\nexport function registerCostCommand(program: Command, options: RegisterCostCommandOptions): void {\n\tprogram\n\t\t.command('cost')\n\t\t.option('-c, --config <path>', 'Path to config file')\n\t\t.option('--period <period>', 'today|week|month|all', 'today')\n\t\t.description('Show LLM usage and cost dashboard')\n\t\t.action(async (commandOptions: { config?: string; period: CostPeriod }) => {\n\t\t\ttry {\n\t\t\t\tawait withTracker(options, commandOptions.config, async (tracker) => {\n\t\t\t\t\tconst period = (['today', 'week', 'month', 'all'] as CostPeriod[]).includes(\n\t\t\t\t\t\tcommandOptions.period,\n\t\t\t\t\t)\n\t\t\t\t\t\t? commandOptions.period\n\t\t\t\t\t\t: 'today';\n\t\t\t\t\tconst records = recordsForPeriod(tracker, period);\n\t\t\t\t\tconst summary = tracker.summarize(records);\n\t\t\t\t\tprocess.stdout.write(`Cost dashboard (${period})\\n`);\n\t\t\t\t\tprocess.stdout.write(\n\t\t\t\t\t\t`Records: ${records.length} | Input tokens: ${formatInt(summary.totalInputTokens)} | Output tokens: ${formatInt(summary.totalOutputTokens)}\\n`,\n\t\t\t\t\t);\n\t\t\t\t\tprocess.stdout.write(\n\t\t\t\t\t\t`Total cost: ${formatUsd(summary.totalCostUsd)} | Avg/day: ${formatUsd(summary.averageCostPerDayUsd)}\\n`,\n\t\t\t\t\t);\n\t\t\t\t\tprocess.stdout.write('\\nBy model:\\n');\n\t\t\t\t\tconst modelEntries = Object.entries(summary.byModel).sort(\n\t\t\t\t\t\t(a, b) => b[1].costUsd - a[1].costUsd,\n\t\t\t\t\t);\n\t\t\t\t\tif (modelEntries.length === 0) {\n\t\t\t\t\t\tprocess.stdout.write('(no usage records)\\n');\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tfor (const [model, stats] of modelEntries) {\n\t\t\t\t\t\tprocess.stdout.write(\n\t\t\t\t\t\t\t`- ${model}: in=${formatInt(stats.inputTokens)} out=${formatInt(stats.outputTokens)} cost=${formatUsd(stats.costUsd)}\\n`,\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} catch (error) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tprocess.stderr.write(`Error: ${message}\\n`);\n\t\t\t\tprocess.exitCode = 1;\n\t\t\t}\n\t\t});\n}\n\nexport type { CostPeriod, RegisterCostCommandOptions };\n","import { copyFileSync, existsSync, mkdirSync, readFileSync, writeFileSync } from 'node:fs';\nimport { homedir } from 'node:os';\nimport { dirname, join } from 'node:path';\nimport { createInterface } from 'node:readline/promises';\nimport type { Command } from 'commander';\nimport { parse as parseYaml, stringify as stringifyYaml } from 'yaml';\nimport { getDefaultConfigPath, getMamaHome } from '../config/defaults.js';\n\ninterface InitAnswers {\n\tname: string;\n\tclaudeApiKey: string;\n\ttelegramToken: string;\n}\n\ninterface InitOptions {\n\tname?: string;\n\tclaudeApiKey?: string;\n\ttelegramToken?: string;\n\tyes?: boolean;\n\tforce?: boolean;\n}\n\ninterface RunInitResult {\n\tmamaHome: string;\n\tconfigPath: string;\n}\n\nfunction resolveTemplatePath(name: string): string {\n\treturn join(process.cwd(), 'templates', name);\n}\n\nfunction ensureMamaStructure(mamaHome: string): void {\n\tfor (const dir of ['logs', 'workspace', 'notes', 'skills']) {\n\t\tmkdirSync(join(mamaHome, dir), { recursive: true });\n\t}\n}\n\nfunction askOrDefault(\n\tquestion: string,\n\tcurrent: string | undefined,\n\tdefaultValue: string,\n\tyes: boolean,\n): Promise<string> {\n\tif (current !== undefined) return Promise.resolve(current);\n\tif (yes) return Promise.resolve(defaultValue);\n\n\tconst rl = createInterface({ input: process.stdin, output: process.stdout });\n\treturn rl\n\t\t.question(`${question} [${defaultValue}]: `)\n\t\t.then((answer) => answer.trim() || defaultValue)\n\t\t.finally(() => rl.close());\n}\n\nasync function collectAnswers(options: InitOptions): Promise<InitAnswers> {\n\tconst name = await askOrDefault('Your name', options.name, 'Alex', Boolean(options.yes));\n\tconst claudeApiKey = await askOrDefault(\n\t\t'Claude API key (optional)',\n\t\toptions.claudeApiKey,\n\t\t'',\n\t\tBoolean(options.yes),\n\t);\n\tconst telegramToken = await askOrDefault(\n\t\t'Telegram bot token (optional)',\n\t\toptions.telegramToken,\n\t\t'',\n\t\tBoolean(options.yes),\n\t);\n\n\treturn { name, claudeApiKey, telegramToken };\n}\n\nfunction renderConfig(template: string, answers: InitAnswers): string {\n\tconst timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';\n\tconst locale = Intl.DateTimeFormat().resolvedOptions().locale || 'en-US';\n\tconst parsed = parseYaml(template) as Record<string, unknown>;\n\tconst user = (parsed.user as Record<string, unknown> | undefined) ?? {};\n\tuser.name = answers.name;\n\tuser.timezone = timezone;\n\tuser.locale = locale;\n\tparsed.user = user;\n\n\tconst channels = (parsed.channels as Record<string, unknown> | undefined) ?? {};\n\tconst telegram = (channels.telegram as Record<string, unknown> | undefined) ?? {};\n\ttelegram.bot_token = answers.telegramToken || `\\${MAMA_TELEGRAM_TOKEN}`;\n\tchannels.telegram = telegram;\n\tparsed.channels = channels;\n\n\tconst llm = (parsed.llm as Record<string, unknown> | undefined) ?? {};\n\tconst providers = (llm.providers as Record<string, unknown> | undefined) ?? {};\n\tconst claude = (providers.claude as Record<string, unknown> | undefined) ?? {};\n\tclaude.api_key = answers.claudeApiKey;\n\tclaude.default_model = claude.default_model ?? 'claude-sonnet-4-20250514';\n\tclaude.max_monthly_budget_usd = claude.max_monthly_budget_usd ?? 50;\n\tproviders.claude = claude;\n\tllm.providers = providers;\n\tparsed.llm = llm;\n\n\treturn stringifyYaml(parsed);\n}\n\nfunction writeConfig(configPath: string, answers: InitAnswers, force = false): void {\n\tconst template = readFileSync(resolveTemplatePath('config.default.yaml'), 'utf-8');\n\tconst config = renderConfig(template, answers);\n\n\tif (existsSync(configPath) && !force) {\n\t\tthrow new Error(`Config already exists at ${configPath}. Use --force to overwrite.`);\n\t}\n\n\tmkdirSync(dirname(configPath), { recursive: true });\n\twriteFileSync(configPath, config, 'utf-8');\n}\n\nfunction copyTemplateIfMissing(srcName: string, destPath: string): void {\n\tif (existsSync(destPath)) return;\n\tcopyFileSync(resolveTemplatePath(srcName), destPath);\n}\n\nexport function registerInitCommand(program: Command): void {\n\tprogram\n\t\t.command('init')\n\t\t.description('Initialize Mama home directory and default configuration')\n\t\t.option('--name <name>', 'User name')\n\t\t.option('--claude-api-key <key>', 'Claude API key')\n\t\t.option('--telegram-token <token>', 'Telegram bot token')\n\t\t.option('-y, --yes', 'Use defaults and skip interactive prompts')\n\t\t.option('--force', 'Overwrite existing config')\n\t\t.action(async (options: InitOptions) => {\n\t\t\ttry {\n\t\t\t\tconst result = await runInit(options);\n\t\t\t\tprocess.stdout.write(`Initialized Mama at ${result.mamaHome}\\n`);\n\t\t\t\tprocess.stdout.write(`Config: ${result.configPath}\\n`);\n\t\t\t\tprocess.stdout.write(`Workspace: ${join(result.mamaHome, 'workspace')}\\n`);\n\t\t\t\tprocess.stdout.write(`Next: run \"mama chat\"\\n`);\n\t\t\t} catch (error) {\n\t\t\t\tconst message = error instanceof Error ? error.message : String(error);\n\t\t\t\tprocess.stderr.write(`Error: ${message}\\n`);\n\t\t\t\tprocess.exitCode = 1;\n\t\t\t}\n\t\t});\n}\n\nexport async function runInit(options: InitOptions): Promise<RunInitResult> {\n\tconst mamaHome = getMamaHome();\n\tensureMamaStructure(mamaHome);\n\n\tconst answers = await collectAnswers(options);\n\tconst configPath = getDefaultConfigPath();\n\twriteConfig(configPath, answers, options.force);\n\n\tcopyTemplateIfMissing('SOUL.md', join(mamaHome, 'soul.md'));\n\tcopyTemplateIfMissing('heartbeat.md', join(mamaHome, 'heartbeat.md'));\n\n\treturn {\n\t\tmamaHome,\n\t\tconfigPath,\n\t};\n}\n\nexport function defaultMamaHomePath(): string {\n\treturn join(homedir(), '.mama');\n}\n","import { homedir, platform } from 'node:os';\nimport { join } from 'node:path';\n\n/**\n * Resolves the base directory for Mama's data.\n * Checks MAMA_HOME env var first, then uses platform-specific defaults.\n */\nexport function getMamaHome(): string {\n\tconst envHome = process.env.MAMA_HOME;\n\tif (envHome) return envHome;\n\n\tconst home = homedir();\n\tconst os = platform();\n\n\tif (os === 'darwin') {\n\t\treturn join(home, '.mama');\n\t}\n\t// Linux: respect XDG_DATA_HOME if set\n\tconst xdgData = process.env.XDG_DATA_HOME;\n\tif (xdgData) {\n\t\treturn join(xdgData, 'mama');\n\t}\n\treturn join(home, '.mama');\n}\n\n/**\n * Returns a default MamaConfig-compatible object (pre-validation).\n * This is used as the base that gets merged with user config.\n */\nexport function getDefaultConfigPath(): string {\n\treturn join(getMamaHome(), 'config.yaml');\n}\n","import type { Command } from 'commander';\nimport type { CronScheduler } from '../scheduler/cron.js';\n\ninterface RegisterJobsCommandOptions {\n\tresolveScheduler(configPath?: string): Promise<{\n\t\tscheduler: CronScheduler;\n\t\tclose(): void;\n\t}>;\n}\n\nfunction writeError(error: unknown): void {\n\tconst message = error instanceof Error ? error.message : String(error);\n\tprocess.stderr.write(`Error: ${message}\\n`);\n}\n\nasync function withScheduler<T>(\n\toptions: RegisterJobsCommandOptions,\n\tconfigPath: string | undefined,\n\trun: (scheduler: CronScheduler) => Promise<T>,\n): Promise<T> {\n\tconst services = await options.resolveScheduler(configPath);\n\ttry {\n\t\treturn await run(services.scheduler);\n\t} finally {\n\t\tservices.close();\n\t}\n}\n\nfunction formatDate(value: Date | null): string {\n\treturn value ? value.toISOString() : '-';\n}\n\nexport function registerJobsCommands(program: Command, options: RegisterJobsCommandOptions): void {\n\tconst jobs = program.command('jobs').description('Scheduled job operations');\n\n\tjobs\n\t\t.command('list')\n\t\t.option('-c, --config <path>', 'Path to config file')\n\t\t.option('--enabled', 'Show only enabled jobs')\n\t\t.description('List scheduled jobs')\n\t\t.action(async (commandOptions: { config?: string; enabled?: boolean }) => {\n\t\t\ttry {\n\t\t\t\tconst rows = await withScheduler(options, commandOptions.config, (scheduler) =>\n\t\t\t\t\tscheduler.listJobs(),\n\t\t\t\t);\n\t\t\t\tconst jobsToPrint = commandOptions.enabled ? rows.filter((job) => job.enabled) : rows;\n\t\t\t\tif (jobsToPrint.length === 0) {\n\t\t\t\t\tprocess.stdout.write('No scheduled jobs found.\\n');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tfor (const job of jobsToPrint) {\n\t\t\t\t\tprocess.stdout.write(\n\t\t\t\t\t\t`${job.id} | ${job.enabled ? 'enabled' : 'disabled'} | ${job.schedule} | ${job.name}\\n`,\n\t\t\t\t\t);\n\t\t\t\t\tprocess.stdout.write(\n\t\t\t\t\t\t`  task=\"${job.task}\" | runs=${job.runCount} | last=${formatDate(job.lastRun)} | next=${formatDate(job.nextRun)}\\n`,\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\twriteError(error);\n\t\t\t\tprocess.exitCode = 1;\n\t\t\t}\n\t\t});\n\n\tjobs\n\t\t.command('create')\n\t\t.argument('<schedule>', 'Cron expression or natural language schedule')\n\t\t.argument('<task>', 'Task description')\n\t\t.option('-n, --name <name>', 'Optional job name')\n\t\t.option('-c, --config <path>', 'Path to config file')\n\t\t.description('Create a scheduled job')\n\t\t.action(\n\t\t\tasync (\n\t\t\t\tschedule: string,\n\t\t\t\ttask: string,\n\t\t\t\tcommandOptions: { name?: string; config?: string },\n\t\t\t) => {\n\t\t\t\ttry {\n\t\t\t\t\tconst id = await withScheduler(options, commandOptions.config, (scheduler) =>\n\t\t\t\t\t\tscheduler.createJob({ name: commandOptions.name, schedule, task }),\n\t\t\t\t\t);\n\t\t\t\t\tprocess.stdout.write(`Created job ${id}\\n`);\n\t\t\t\t} catch (error) {\n\t\t\t\t\twriteError(error);\n\t\t\t\t\tprocess.exitCode = 1;\n\t\t\t\t}\n\t\t\t},\n\t\t);\n\n\tfor (const action of ['enable', 'disable', 'delete'] as const) {\n\t\tjobs\n\t\t\t.command(action)\n\t\t\t.argument('<id>', 'Job id')\n\t\t\t.option('-c, --config <path>', 'Path to config file')\n\t\t\t.description(`${action[0]?.toUpperCase()}${action.slice(1)} a scheduled job`)\n\t\t\t.action(async (id: string, commandOptions: { config?: string }) => {\n\t\t\t\ttry {\n\t\t\t\t\tawait withScheduler(options, commandOptions.config, async (scheduler) => {\n\t\t\t\t\t\tif (action === 'enable') {\n\t\t\t\t\t\t\tawait scheduler.enableJob(id);\n\t\t\t\t\t\t} else if (action === 'disable') {\n\t\t\t\t\t\t\tawait scheduler.disableJob(id);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tawait scheduler.deleteJob(id);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tprocess.stdout.write(`${action}d job ${id}\\n`);\n\t\t\t\t} catch (error) {\n\t\t\t\t\twriteError(error);\n\t\t\t\t\tprocess.exitCode = 1;\n\t\t\t\t}\n\t\t\t});\n\t}\n}\n","import type { Command } from 'commander';\nimport type {\n\tConsolidatedMemory,\n\tConsolidatedMemoryStore,\n\tMemoryCategory,\n} from '../memory/consolidated.js';\nimport type { ConsolidationEngine } from '../memory/consolidation.js';\nimport type { Episode, EpisodicMemory } from '../memory/episodic.js';\nimport type { MemoryStore } from '../memory/store.js';\n\nconst CATEGORY_VALUES: [MemoryCategory, ...MemoryCategory[]] = [\n\t'fact',\n\t'preference',\n\t'pattern',\n\t'goal',\n\t'relationship',\n\t'skill',\n\t'routine',\n\t'emotional',\n\t'project',\n];\n\ninterface MemoryStatsCountRow {\n\tcount: number;\n}\n\ninterface MemoryCategoryRow {\n\tcategory: string;\n\tcount: number;\n}\n\ninterface MemoryCliOutput {\n\twrite(value: string): void;\n\twriteError(value: string): void;\n}\n\ninterface CliColors {\n\tenabled: boolean;\n}\n\nexport interface MemoryCliServices {\n\tstore: MemoryStore;\n\tepisodic: EpisodicMemory;\n\tconsolidated: ConsolidatedMemoryStore;\n\tconsolidation?: ConsolidationEngine;\n\tclose(): void;\n}\n\ninterface SearchOptions {\n\tlimit?: number;\n}\n\ninterface ListOptions {\n\tcategory?: MemoryCategory;\n\tminConfidence?: number;\n}\n\nexport interface MemoryCliHandlers {\n\tsearch(query: string, options?: SearchOptions): Promise<string>;\n\tlist(options?: ListOptions): Promise<string>;\n\tforget(id: string): Promise<string>;\n\tconsolidate(): Promise<string>;\n\tstats(): Promise<string>;\n}\n\ninterface RegisterMemoryCommandOptions {\n\tresolveServices(configPath?: string): Promise<MemoryCliServices>;\n}\n\nfunction withColor(text: string, code: string, colors: CliColors): string {\n\tif (!colors.enabled) return text;\n\treturn `\\x1b[${code}m${text}\\x1b[0m`;\n}\n\nfunction title(text: string, colors: CliColors): string {\n\treturn withColor(text, '1;36', colors);\n}\n\nfunction section(text: string, colors: CliColors): string {\n\treturn withColor(text, '1;33', colors);\n}\n\nfunction ok(text: string, colors: CliColors): string {\n\treturn withColor(text, '32', colors);\n}\n\nfunction dim(text: string, colors: CliColors): string {\n\treturn withColor(text, '90', colors);\n}\n\nfunction danger(text: string, colors: CliColors): string {\n\treturn withColor(text, '31', colors);\n}\n\nfunction clampLimit(value: number | undefined, fallback: number): number {\n\tif (!value || Number.isNaN(value)) return fallback;\n\treturn Math.max(1, Math.min(100, Math.floor(value)));\n}\n\nfunction summarizeContent(content: string, max = 140): string {\n\tif (content.length <= max) return content;\n\treturn `${content.slice(0, max - 3)}...`;\n}\n\nfunction formatDate(value: Date): string {\n\treturn value.toISOString().replace('T', ' ').replace('.000Z', 'Z');\n}\n\nfunction formatConsolidatedMemoryLine(\n\tindex: number,\n\tmemory: ConsolidatedMemory,\n\tcolors: CliColors,\n): string {\n\tconst meta = dim(\n\t\t`${memory.id} | ${memory.category} | confidence=${memory.confidence.toFixed(2)} | active=${memory.active ? 'yes' : 'no'} | reinforced=${memory.reinforcementCount}`,\n\t\tcolors,\n\t);\n\tconst content = summarizeContent(memory.content, 220);\n\treturn `${index}. ${content}\\n   ${meta}`;\n}\n\nfunction formatEpisodeLine(index: number, episode: Episode, colors: CliColors): string {\n\tconst meta = dim(\n\t\t`${episode.id} | ${episode.role} | ${episode.channel} | ${formatDate(episode.timestamp)}`,\n\t\tcolors,\n\t);\n\tconst content = summarizeContent(episode.content, 200);\n\treturn `${index}. ${content}\\n   ${meta}`;\n}\n\nfunction readCount(store: MemoryStore, sql: string): number {\n\tconst row = store.get<MemoryStatsCountRow>(sql);\n\treturn row?.count ?? 0;\n}\n\nfunction readCategoryDistribution(store: MemoryStore): MemoryCategoryRow[] {\n\treturn store.all<MemoryCategoryRow>(\n\t\t`SELECT category, COUNT(*) AS count\n\t\t FROM memories\n\t\t GROUP BY category\n\t\t ORDER BY count DESC, category ASC`,\n\t);\n}\n\nfunction createMemoryCliOutput(): MemoryCliOutput {\n\treturn {\n\t\twrite(value: string) {\n\t\t\tprocess.stdout.write(value);\n\t\t},\n\t\twriteError(value: string) {\n\t\t\tprocess.stderr.write(value);\n\t\t},\n\t};\n}\n\nfunction getColors(): CliColors {\n\treturn {\n\t\tenabled: process.env.NO_COLOR !== '1',\n\t};\n}\n\nfunction categoryOptionValue(value: string): MemoryCategory {\n\tif (CATEGORY_VALUES.includes(value as MemoryCategory)) {\n\t\treturn value as MemoryCategory;\n\t}\n\tthrow new Error(`Invalid category \"${value}\". Expected one of: ${CATEGORY_VALUES.join(', ')}`);\n}\n\nfunction renderConsolidatedSearchSection(\n\tmemories: ConsolidatedMemory[],\n\tcolors: CliColors,\n): string[] {\n\tconst lines = [section('Consolidated Memories', colors)];\n\tif (memories.length === 0) {\n\t\tlines.push(dim('No consolidated memory matches.', colors));\n\t\treturn lines;\n\t}\n\n\tfor (let i = 0; i < memories.length; i++) {\n\t\tconst memory = memories[i];\n\t\tif (memory) {\n\t\t\tlines.push(formatConsolidatedMemoryLine(i + 1, memory, colors));\n\t\t}\n\t}\n\n\treturn lines;\n}\n\nfunction renderEpisodicSearchSection(episodes: Episode[], colors: CliColors): string[] {\n\tconst lines = [section('Episodic Memories', colors)];\n\tif (episodes.length === 0) {\n\t\tlines.push(dim('No episodic memory matches.', colors));\n\t\treturn lines;\n\t}\n\n\tfor (let i = 0; i < episodes.length; i++) {\n\t\tconst episode = episodes[i];\n\t\tif (episode) {\n\t\t\tlines.push(formatEpisodeLine(i + 1, episode, colors));\n\t\t}\n\t}\n\n\treturn lines;\n}\n\nexport function createMemoryCliHandlers(\n\tservices: MemoryCliServices,\n\tcolors: CliColors = getColors(),\n): MemoryCliHandlers {\n\tasync function search(query: string, options: SearchOptions = {}): Promise<string> {\n\t\tconst limit = clampLimit(options.limit, 10);\n\t\tconst [memories, episodes] = await Promise.all([\n\t\t\tservices.consolidated.search(query, { topK: limit, includeInactive: true, minConfidence: 0 }),\n\t\t\tservices.episodic.searchSemantic(query, { topK: limit }),\n\t\t]);\n\n\t\tconst lines: string[] = [];\n\t\tlines.push(`${title('Memory Search', colors)}  ${dim(`query=\"${query}\"`, colors)}`);\n\t\tlines.push(`${dim(`Top ${limit} per source`, colors)}\\n`);\n\t\tlines.push(...renderConsolidatedSearchSection(memories, colors));\n\t\tlines.push('');\n\t\tlines.push(...renderEpisodicSearchSection(episodes, colors));\n\n\t\treturn `${lines.join('\\n')}\\n`;\n\t}\n\n\tasync function list(options: ListOptions = {}): Promise<string> {\n\t\tconst minConfidence = options.minConfidence ?? 0;\n\t\tconst memories = options.category\n\t\t\t? (await services.consolidated.getByCategory(options.category)).filter(\n\t\t\t\t\t(memory) => memory.confidence >= minConfidence,\n\t\t\t\t)\n\t\t\t: await services.consolidated.getActive(minConfidence);\n\n\t\tconst lines: string[] = [];\n\t\tlines.push(title('Consolidated Memories', colors));\n\t\tlines.push(\n\t\t\tdim(\n\t\t\t\t`count=${memories.length} | minConfidence=${minConfidence.toFixed(2)}${\n\t\t\t\t\toptions.category ? ` | category=${options.category}` : ''\n\t\t\t\t}`,\n\t\t\t\tcolors,\n\t\t\t),\n\t\t);\n\t\tlines.push('');\n\n\t\tif (memories.length === 0) {\n\t\t\tlines.push(dim('No memories found for the selected filters.', colors));\n\t\t\treturn `${lines.join('\\n')}\\n`;\n\t\t}\n\n\t\tfor (let i = 0; i < memories.length; i++) {\n\t\t\tconst memory = memories[i];\n\t\t\tif (memory) {\n\t\t\t\tlines.push(formatConsolidatedMemoryLine(i + 1, memory, colors));\n\t\t\t}\n\t\t}\n\n\t\treturn `${lines.join('\\n')}\\n`;\n\t}\n\n\tasync function forget(id: string): Promise<string> {\n\t\tawait services.consolidated.deactivate(id);\n\t\treturn `${ok('Memory deactivated.', colors)} ${dim(id, colors)}\\n`;\n\t}\n\n\tasync function consolidate(): Promise<string> {\n\t\tif (!services.consolidation) {\n\t\t\tthrow new Error('Consolidation engine is not available.');\n\t\t}\n\t\tconst report = await services.consolidation.runConsolidation({ force: true });\n\n\t\tconst lines: string[] = [];\n\t\tlines.push(title('Consolidation Report', colors));\n\t\tlines.push(dim(`${report.startedAt} -> ${report.finishedAt}`, colors));\n\t\tlines.push('');\n\t\tif (report.skipped) {\n\t\t\tlines.push(`${section('Status', colors)} ${dim('skipped', colors)}`);\n\t\t\tlines.push(dim(report.skipReason ?? 'No reason provided', colors));\n\t\t\treturn `${lines.join('\\n')}\\n`;\n\t\t}\n\n\t\tlines.push(`${section('Processed episodes', colors)} ${report.processedEpisodes}`);\n\t\tlines.push(`${section('Created', colors)} ${report.created}`);\n\t\tlines.push(`${section('Reinforced', colors)} ${report.reinforced}`);\n\t\tlines.push(`${section('Updated', colors)} ${report.updated}`);\n\t\tlines.push(`${section('Contradicted', colors)} ${report.contradicted}`);\n\t\tlines.push(`${section('Decayed', colors)} ${report.decayed}`);\n\t\tlines.push(`${section('Deactivated', colors)} ${report.deactivated}`);\n\t\tlines.push(`${section('Connected', colors)} ${report.connected}`);\n\t\tif (report.errors.length > 0) {\n\t\t\tlines.push('');\n\t\t\tlines.push(section('Errors', colors));\n\t\t\tfor (const error of report.errors) {\n\t\t\t\tlines.push(`${danger('-', colors)} ${error}`);\n\t\t\t}\n\t\t}\n\n\t\treturn `${lines.join('\\n')}\\n`;\n\t}\n\n\tasync function stats(): Promise<string> {\n\t\tconst totalEpisodes = readCount(services.store, 'SELECT COUNT(*) AS count FROM episodes');\n\t\tconst unconsolidatedEpisodes = readCount(\n\t\t\tservices.store,\n\t\t\t'SELECT COUNT(*) AS count FROM episodes WHERE consolidated = 0',\n\t\t);\n\t\tconst totalMemories = readCount(services.store, 'SELECT COUNT(*) AS count FROM memories');\n\t\tconst activeMemories = readCount(\n\t\t\tservices.store,\n\t\t\t'SELECT COUNT(*) AS count FROM memories WHERE active = 1',\n\t\t);\n\t\tconst inactiveMemories = readCount(\n\t\t\tservices.store,\n\t\t\t'SELECT COUNT(*) AS count FROM memories WHERE active = 0',\n\t\t);\n\t\tconst enabledJobs = readCount(\n\t\t\tservices.store,\n\t\t\t'SELECT COUNT(*) AS count FROM jobs WHERE enabled = 1',\n\t\t);\n\t\tconst categoryRows = readCategoryDistribution(services.store);\n\n\t\tconst lines: string[] = [];\n\t\tlines.push(title('Memory Stats', colors));\n\t\tlines.push('');\n\t\tlines.push(section('Episodes', colors));\n\t\tlines.push(`- total: ${totalEpisodes}`);\n\t\tlines.push(`- unconsolidated: ${unconsolidatedEpisodes}`);\n\t\tlines.push('');\n\t\tlines.push(section('Consolidated Memories', colors));\n\t\tlines.push(`- total: ${totalMemories}`);\n\t\tlines.push(`- active: ${activeMemories}`);\n\t\tlines.push(`- inactive: ${inactiveMemories}`);\n\t\tlines.push('');\n\t\tlines.push(section('Scheduler', colors));\n\t\tlines.push(`- enabled jobs: ${enabledJobs}`);\n\t\tlines.push('');\n\t\tlines.push(section('By Category', colors));\n\t\tif (categoryRows.length === 0) {\n\t\t\tlines.push(dim('(No consolidated memories yet)', colors));\n\t\t} else {\n\t\t\tfor (const row of categoryRows) {\n\t\t\t\tlines.push(`- ${row.category}: ${row.count}`);\n\t\t\t}\n\t\t}\n\n\t\treturn `${lines.join('\\n')}\\n`;\n\t}\n\n\treturn {\n\t\tsearch,\n\t\tlist,\n\t\tforget,\n\t\tconsolidate,\n\t\tstats,\n\t};\n}\n\nasync function withServices<T>(\n\tresolveServices: RegisterMemoryCommandOptions['resolveServices'],\n\tconfigPath: string | undefined,\n\trun: (handlers: MemoryCliHandlers) => Promise<T>,\n): Promise<T> {\n\tconst services = await resolveServices(configPath);\n\ttry {\n\t\tconst handlers = createMemoryCliHandlers(services);\n\t\treturn await run(handlers);\n\t} finally {\n\t\tservices.close();\n\t}\n}\n\nfunction writeOutput(output: MemoryCliOutput, text: string): void {\n\toutput.write(text);\n}\n\nfunction writeFailure(output: MemoryCliOutput, error: unknown): void {\n\tconst colors = getColors();\n\tconst message = error instanceof Error ? error.message : String(error);\n\toutput.writeError(`${danger('Error:', colors)} ${message}\\n`);\n}\n\nexport function registerMemoryCommands(\n\tprogram: Command,\n\toptions: RegisterMemoryCommandOptions,\n): void {\n\tconst output = createMemoryCliOutput();\n\tconst memory = program.command('memory').description('Memory operations');\n\n\tmemory\n\t\t.command('search')\n\t\t.argument('<query>', 'Search query')\n\t\t.option('-c, --config <path>', 'Path to config file')\n\t\t.option('-l, --limit <n>', 'Top results per source', (value: string) =>\n\t\t\tNumber.parseInt(value, 10),\n\t\t)\n\t\t.description('Semantic search across consolidated and episodic memories')\n\t\t.action(async (query: string, commandOptions: { config?: string; limit?: number }) => {\n\t\t\ttry {\n\t\t\t\tconst rendered = await withServices(\n\t\t\t\t\toptions.resolveServices,\n\t\t\t\t\tcommandOptions.config,\n\t\t\t\t\t(handlers) => handlers.search(query, { limit: commandOptions.limit }),\n\t\t\t\t);\n\t\t\t\twriteOutput(output, rendered);\n\t\t\t} catch (error) {\n\t\t\t\twriteFailure(output, error);\n\t\t\t\tprocess.exitCode = 1;\n\t\t\t}\n\t\t});\n\n\tmemory\n\t\t.command('list')\n\t\t.option('-c, --config <path>', 'Path to config file')\n\t\t.option('--category <category>', 'Filter by category', categoryOptionValue)\n\t\t.option('--min-confidence <value>', 'Minimum confidence (0-1)', (value: string) =>\n\t\t\tNumber.parseFloat(value),\n\t\t)\n\t\t.description('List consolidated memories')\n\t\t.action(\n\t\t\tasync (commandOptions: {\n\t\t\t\tconfig?: string;\n\t\t\t\tcategory?: MemoryCategory;\n\t\t\t\tminConfidence?: number;\n\t\t\t}) => {\n\t\t\t\ttry {\n\t\t\t\t\tconst rendered = await withServices(\n\t\t\t\t\t\toptions.resolveServices,\n\t\t\t\t\t\tcommandOptions.config,\n\t\t\t\t\t\t(handlers) =>\n\t\t\t\t\t\t\thandlers.list({\n\t\t\t\t\t\t\t\tcategory: commandOptions.category,\n\t\t\t\t\t\t\t\tminConfidence: commandOptions.minConfidence,\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t);\n\t\t\t\t\twriteOutput(output, rendered);\n\t\t\t\t} catch (error) {\n\t\t\t\t\twriteFailure(output, error);\n\t\t\t\t\tprocess.exitCode = 1;\n\t\t\t\t}\n\t\t\t},\n\t\t);\n\n\tmemory\n\t\t.command('forget')\n\t\t.argument('<id>', 'Memory ID')\n\t\t.option('-c, --config <path>', 'Path to config file')\n\t\t.description('Deactivate a specific consolidated memory')\n\t\t.action(async (id: string, commandOptions: { config?: string }) => {\n\t\t\ttry {\n\t\t\t\tconst rendered = await withServices(\n\t\t\t\t\toptions.resolveServices,\n\t\t\t\t\tcommandOptions.config,\n\t\t\t\t\t(handlers) => handlers.forget(id),\n\t\t\t\t);\n\t\t\t\twriteOutput(output, rendered);\n\t\t\t} catch (error) {\n\t\t\t\twriteFailure(output, error);\n\t\t\t\tprocess.exitCode = 1;\n\t\t\t}\n\t\t});\n\n\tmemory\n\t\t.command('consolidate')\n\t\t.option('-c, --config <path>', 'Path to config file')\n\t\t.description('Manually run memory consolidation now')\n\t\t.action(async (commandOptions: { config?: string }) => {\n\t\t\ttry {\n\t\t\t\tconst rendered = await withServices(\n\t\t\t\t\toptions.resolveServices,\n\t\t\t\t\tcommandOptions.config,\n\t\t\t\t\t(handlers) => handlers.consolidate(),\n\t\t\t\t);\n\t\t\t\twriteOutput(output, rendered);\n\t\t\t} catch (error) {\n\t\t\t\twriteFailure(output, error);\n\t\t\t\tprocess.exitCode = 1;\n\t\t\t}\n\t\t});\n\n\tmemory\n\t\t.command('stats')\n\t\t.option('-c, --config <path>', 'Path to config file')\n\t\t.description('Show memory statistics')\n\t\t.action(async (commandOptions: { config?: string }) => {\n\t\t\ttry {\n\t\t\t\tconst rendered = await withServices(\n\t\t\t\t\toptions.resolveServices,\n\t\t\t\t\tcommandOptions.config,\n\t\t\t\t\t(handlers) => handlers.stats(),\n\t\t\t\t);\n\t\t\t\twriteOutput(output, rendered);\n\t\t\t} catch (error) {\n\t\t\t\twriteFailure(output, error);\n\t\t\t\tprocess.exitCode = 1;\n\t\t\t}\n\t\t});\n}\n","import { existsSync, mkdirSync, readFileSync } from 'node:fs';\nimport { parse as parseYaml } from 'yaml';\nimport { getDefaultConfigPath, getMamaHome } from './defaults.js';\nimport { ConfigSchema, type MamaConfig } from './schema.js';\n\ntype Result<T, E = Error> = { ok: true; value: T } | { ok: false; error: E };\n\n/**\n * Resolves environment variable references in config values.\n * Supports ${ENV_VAR} syntax. Returns the value unchanged if not a reference.\n */\nfunction resolveEnvVars(value: unknown): unknown {\n\tif (typeof value === 'string') {\n\t\treturn value.replace(/\\$\\{([^}]+)\\}/g, (_match, varName: string) => {\n\t\t\tconst envValue = process.env[varName];\n\t\t\tif (envValue === undefined) {\n\t\t\t\treturn '';\n\t\t\t}\n\t\t\treturn envValue;\n\t\t});\n\t}\n\tif (Array.isArray(value)) {\n\t\treturn value.map(resolveEnvVars);\n\t}\n\tif (value !== null && typeof value === 'object') {\n\t\treturn resolveEnvVarsInObject(value as Record<string, unknown>);\n\t}\n\treturn value;\n}\n\nfunction resolveEnvVarsInObject(obj: Record<string, unknown>): Record<string, unknown> {\n\tconst result: Record<string, unknown> = {};\n\tfor (const [key, val] of Object.entries(obj)) {\n\t\tresult[key] = resolveEnvVars(val);\n\t}\n\treturn result;\n}\n\n/**\n * Converts YAML snake_case keys to camelCase for TypeScript config.\n */\nfunction snakeToCamel(str: string): string {\n\treturn str.replace(/_([a-z])/g, (_match, letter: string) => letter.toUpperCase());\n}\n\nfunction convertKeysToCamelCase(obj: unknown): unknown {\n\tif (Array.isArray(obj)) {\n\t\treturn obj.map(convertKeysToCamelCase);\n\t}\n\tif (obj !== null && typeof obj === 'object') {\n\t\tconst result: Record<string, unknown> = {};\n\t\tfor (const [key, val] of Object.entries(obj as Record<string, unknown>)) {\n\t\t\tresult[snakeToCamel(key)] = convertKeysToCamelCase(val);\n\t\t}\n\t\treturn result;\n\t}\n\treturn obj;\n}\n\n/**\n * Loads and validates the Mama configuration.\n * Looks for config at the given path, or falls back to defaults.\n */\nexport function loadConfig(configPath?: string): Result<MamaConfig> {\n\tconst path = configPath ?? getDefaultConfigPath();\n\n\tlet rawConfig: Record<string, unknown> = {};\n\n\tif (existsSync(path)) {\n\t\ttry {\n\t\t\tconst content = readFileSync(path, 'utf-8');\n\t\t\tconst parsed = parseYaml(content) as unknown;\n\t\t\tif (parsed !== null && typeof parsed === 'object') {\n\t\t\t\trawConfig = parsed as Record<string, unknown>;\n\t\t\t}\n\t\t} catch (err) {\n\t\t\treturn {\n\t\t\t\tok: false,\n\t\t\t\terror: new Error(\n\t\t\t\t\t`Failed to parse config at ${path}: ${err instanceof Error ? err.message : String(err)}`,\n\t\t\t\t),\n\t\t\t};\n\t\t}\n\t}\n\n\t// Convert YAML snake_case to camelCase\n\tconst camelConfig = convertKeysToCamelCase(rawConfig) as Record<string, unknown>;\n\n\t// Resolve environment variable references\n\tconst resolvedConfig = resolveEnvVarsInObject(camelConfig);\n\n\t// Validate with Zod\n\tconst result = ConfigSchema.safeParse(resolvedConfig);\n\n\tif (!result.success) {\n\t\tconst issues = result.error.issues.map(\n\t\t\t(issue) => `  - ${issue.path.join('.')}: ${issue.message}`,\n\t\t);\n\t\treturn {\n\t\t\tok: false,\n\t\t\terror: new Error(`Invalid configuration:\\n${issues.join('\\n')}`),\n\t\t};\n\t}\n\n\treturn { ok: true, value: result.data };\n}\n\n/**\n * Ensures the Mama home directory exists.\n */\nexport function ensureMamaHome(): string {\n\tconst home = getMamaHome();\n\tif (!existsSync(home)) {\n\t\tmkdirSync(home, { recursive: true });\n\t}\n\tconst logsDir = `${home}/logs`;\n\tif (!existsSync(logsDir)) {\n\t\tmkdirSync(logsDir, { recursive: true });\n\t}\n\treturn home;\n}\n\n// Singleton config holder\nlet _config: MamaConfig | null = null;\n\n/**\n * Initializes and returns the config. Call once at startup.\n */\nexport function initConfig(configPath?: string): Result<MamaConfig> {\n\tconst result = loadConfig(configPath);\n\tif (result.ok) {\n\t\t_config = result.value;\n\t}\n\treturn result;\n}\n\n/**\n * Gets the loaded config. Throws if not initialized.\n */\nexport function getConfig(): MamaConfig {\n\tif (_config === null) {\n\t\tthrow new Error('Config not initialized. Call initConfig() first.');\n\t}\n\treturn _config;\n}\n\n/**\n * Resets config (for testing).\n */\nexport function resetConfig(): void {\n\t_config = null;\n}\n","import { z } from 'zod';\n\nconst AgentSchema = z.object({\n\tname: z.string().default('Mama'),\n\tsoulPath: z.string().default('./soul.md'),\n});\n\nconst UserSchema = z.object({\n\tname: z.string().default('User'),\n\ttelegramIds: z.array(z.number()).default([]),\n\ttimezone: z.string().default('UTC'),\n\tlocale: z.string().default('en-US'),\n});\n\nconst ClaudeProviderSchema = z.object({\n\tapiKey: z.string().default(''),\n\tdefaultModel: z.string().default('claude-sonnet-4-20250514'),\n\tmaxMonthlyBudgetUsd: z.number().positive().default(50),\n});\n\nconst OllamaProviderSchema = z.object({\n\thost: z.string().url().default('http://localhost:11434'),\n\tapiKey: z.string().default(''),\n\tdefaultModel: z.string().default('minimax-m2.5:cloud'),\n\tsmartModel: z.string().default('minimax-m2.5:cloud'),\n\tfastModel: z.string().default('gemini-3-flash-preview:cloud'),\n\tembeddingModel: z.string().default('nomic-embed-text'),\n});\n\nconst RoutingSchema = z.object({\n\tcomplexReasoning: z.enum(['claude', 'ollama']).default('ollama'),\n\tcodeGeneration: z.enum(['claude', 'ollama']).default('ollama'),\n\tsimpleTasks: z.enum(['claude', 'ollama']).default('ollama'),\n\tembeddings: z.enum(['claude', 'ollama']).default('ollama'),\n\tmemoryConsolidation: z.enum(['claude', 'ollama']).default('ollama'),\n\tprivateContent: z.enum(['claude', 'ollama']).default('ollama'),\n});\n\nconst LlmSchema = z.object({\n\tdefaultProvider: z.enum(['claude', 'ollama']).default('ollama'),\n\tproviders: z\n\t\t.object({\n\t\t\tclaude: ClaudeProviderSchema.default({}),\n\t\t\tollama: OllamaProviderSchema.default({}),\n\t\t})\n\t\t.default({}),\n\trouting: RoutingSchema.default({}),\n});\n\nconst TerminalChannelSchema = z.object({\n\tenabled: z.boolean().default(true),\n});\n\nconst TelegramChannelSchema = z.object({\n\tenabled: z.boolean().default(false),\n\tbotToken: z.string().default(''),\n\tdefaultChatId: z.number().int().optional(),\n});\n\nconst ApiChannelSchema = z.object({\n\tenabled: z.boolean().default(false),\n\thost: z.string().default('127.0.0.1'),\n\tport: z.number().int().min(1).max(65535).default(3377),\n\ttoken: z.string().default(''),\n});\n\nconst ChannelsSchema = z.object({\n\tterminal: TerminalChannelSchema.default({}),\n\ttelegram: TelegramChannelSchema.default({}),\n\tapi: ApiChannelSchema.default({}),\n});\n\nconst FsPathPermission = z.object({\n\tpath: z.string(),\n\tactions: z.array(z.enum(['read', 'write', 'list', 'delete'])),\n\tlevel: z.enum(['auto', 'ask', 'deny']),\n});\n\nconst FilesystemSandboxSchema = z.object({\n\tworkspace: z.string().default('~/.mama/workspace'),\n\tallowedPaths: z.array(FsPathPermission).default([]),\n\tdeniedPaths: z.array(z.string()).default([]),\n});\n\nconst ShellSandboxSchema = z.object({\n\tsafeCommands: z\n\t\t.array(z.string())\n\t\t.default([\n\t\t\t'ls',\n\t\t\t'cat',\n\t\t\t'head',\n\t\t\t'tail',\n\t\t\t'grep',\n\t\t\t'find',\n\t\t\t'wc',\n\t\t\t'date',\n\t\t\t'whoami',\n\t\t\t'pwd',\n\t\t\t'echo',\n\t\t\t'git status',\n\t\t\t'git log',\n\t\t\t'git diff',\n\t\t]),\n\taskCommands: z\n\t\t.array(z.string())\n\t\t.default(['git commit', 'git push', 'git pull', 'mkdir', 'cp', 'mv', 'npm', 'pnpm', 'node']),\n\tdeniedPatterns: z\n\t\t.array(z.string())\n\t\t.default([\n\t\t\t'rm -rf',\n\t\t\t'sudo',\n\t\t\t'curl | bash',\n\t\t\t'wget | sh',\n\t\t\t'chmod 777',\n\t\t\t'> /dev',\n\t\t\t'mkfs',\n\t\t\t'dd if=',\n\t\t]),\n});\n\nconst NetworkSandboxSchema = z.object({\n\tallowedDomains: z\n\t\t.array(z.string())\n\t\t.default(['ollama.com', 'api.telegram.org', 'localhost', 'api.github.com']),\n\taskDomains: z.boolean().default(true),\n\trateLimitPerMinute: z.number().int().positive().default(30),\n\tlogAllRequests: z.boolean().default(true),\n});\n\nconst SandboxSchema = z.object({\n\tfilesystem: FilesystemSandboxSchema.default({}),\n\tshell: ShellSandboxSchema.default({}),\n\tnetwork: NetworkSandboxSchema.default({}),\n});\n\nconst HeartbeatSchema = z.object({\n\tenabled: z.boolean().default(true),\n\tintervalMinutes: z.number().int().positive().default(30),\n\theartbeatFile: z.string().default('~/.mama/heartbeat.md'),\n});\n\nconst FileWatcherTriggerSchema = z.object({\n\tpath: z.string(),\n\tevents: z.array(z.enum(['add', 'change', 'unlink', 'rename'])).default(['add']),\n\ttask: z.string().min(1),\n});\n\nconst WebhookHookSchema = z.object({\n\tid: z.string().min(1),\n\ttoken: z.string().default(''),\n\ttask: z.string().min(1),\n});\n\nconst WebhookTriggersSchema = z.object({\n\tenabled: z.boolean().default(false),\n\thost: z.string().default('127.0.0.1'),\n\tport: z.number().int().min(1).max(65535).default(3378),\n\thooks: z.array(WebhookHookSchema).default([]),\n});\n\nconst TriggersSchema = z.object({\n\tfileWatchers: z.array(FileWatcherTriggerSchema).default([]),\n\twebhooks: WebhookTriggersSchema.default({}),\n});\n\nconst SchedulerSchema = z.object({\n\theartbeat: HeartbeatSchema.default({}),\n\tmaxConcurrentJobs: z.number().int().positive().default(3),\n\ttriggers: TriggersSchema.default({}),\n});\n\nconst DaemonSchema = z.object({\n\tpidFile: z.string().default('~/.mama/mama.pid'),\n\thealthCheckIntervalSeconds: z.number().int().positive().default(30),\n});\n\nconst ConsolidationSchema = z.object({\n\tenabled: z.boolean().default(true),\n\tintervalHours: z.number().positive().default(6),\n\tminEpisodesToConsolidate: z.number().int().positive().default(10),\n\tmodel: z.enum(['claude', 'ollama']).default('ollama'),\n});\n\nconst MemorySchema = z.object({\n\tconsolidation: ConsolidationSchema.default({}),\n\tmaxEpisodicEntries: z.number().int().positive().default(100000),\n\tembeddingDimensions: z.number().int().positive().default(768),\n\tsearchTopK: z.number().int().positive().default(10),\n});\n\nconst LoggingSchema = z.object({\n\tlevel: z.enum(['debug', 'info', 'warn', 'error']).default('info'),\n\tfile: z.string().default('~/.mama/logs/mama.log'),\n\tmaxSizeMb: z.number().positive().default(50),\n\trotate: z.boolean().default(true),\n});\n\nexport const ConfigSchema = z.object({\n\tversion: z.number().int().default(1),\n\tagent: AgentSchema.default({}),\n\tuser: UserSchema.default({}),\n\tllm: LlmSchema.default({}),\n\tchannels: ChannelsSchema.default({}),\n\tsandbox: SandboxSchema.default({}),\n\tscheduler: SchedulerSchema.default({}),\n\tdaemon: DaemonSchema.default({}),\n\tmemory: MemorySchema.default({}),\n\tlogging: LoggingSchema.default({}),\n});\n\nexport type MamaConfig = z.infer<typeof ConfigSchema>;\nexport type LogLevel = 'debug' | 'info' | 'warn' | 'error';\n","/**\n * Builds the full system prompt for the agent from soul content and memory injections.\n */\nexport function buildSystemPrompt(soul: string, memories?: string[]): string {\n\tconst parts: string[] = [soul];\n\n\tif (memories && memories.length > 0) {\n\t\tparts.push('\\n## Relevant Memories');\n\t\tfor (const mem of memories) {\n\t\t\tparts.push(`- ${mem}`);\n\t\t}\n\t}\n\n\tparts.push('\\n## Guidelines');\n\tparts.push('- Be concise and helpful');\n\tparts.push('- If you plan to perform actions with side effects, explain what you will do first');\n\tparts.push('- If you are unsure, say so honestly');\n\tparts.push(\"- Respect the user's time ‚Äî be efficient\");\n\n\treturn parts.join('\\n');\n}\n","import { z } from 'zod';\nimport type { CapabilityResult } from '../../sandbox/types.js';\nimport { createTool, type Tool, type ToolResult } from './types.js';\n\nfunction fromCapabilityResult(result: CapabilityResult): ToolResult {\n\treturn {\n\t\tsuccess: result.success,\n\t\toutput: result.output,\n\t\terror: result.error,\n\t};\n}\n\nfunction shQuote(value: string): string {\n\treturn `'${value.replace(/'/g, `'\\\\''`)}'`;\n}\n\nconst ReadFileParams = z.object({\n\tpath: z.string().min(1),\n});\n\nconst WriteFileParams = z.object({\n\tpath: z.string().min(1),\n\tcontent: z.string(),\n});\n\nconst ListDirectoryParams = z.object({\n\tpath: z.string().min(1),\n});\n\nconst SearchFilesParams = z.object({\n\tpath: z.string().min(1),\n\tpattern: z.string().min(1),\n});\n\nconst MoveFileParams = z.object({\n\tsourcePath: z.string().min(1),\n\tdestinationPath: z.string().min(1),\n});\n\nconst readFileTool = createTool({\n\tname: 'read_file',\n\tdescription: 'Read a UTF-8 text file from an allowed path.',\n\tparameters: ReadFileParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\tpath: { type: 'string', description: 'Absolute or relative file path to read' },\n\t\t},\n\t\trequired: ['path'],\n\t},\n\tasync execute(params, context) {\n\t\tconst result = await context.sandbox.execute(\n\t\t\t'filesystem',\n\t\t\t'read',\n\t\t\t{ path: params.path },\n\t\t\tcontext.requestedBy,\n\t\t);\n\t\treturn fromCapabilityResult(result);\n\t},\n});\n\nconst writeFileTool = createTool({\n\tname: 'write_file',\n\tdescription: 'Create or overwrite a UTF-8 text file in an allowed path.',\n\tparameters: WriteFileParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\tpath: { type: 'string', description: 'File path to write' },\n\t\t\tcontent: { type: 'string', description: 'Text content to write into the file' },\n\t\t},\n\t\trequired: ['path', 'content'],\n\t},\n\tasync execute(params, context) {\n\t\tconst result = await context.sandbox.execute(\n\t\t\t'filesystem',\n\t\t\t'write',\n\t\t\t{ path: params.path, content: params.content },\n\t\t\tcontext.requestedBy,\n\t\t);\n\t\treturn fromCapabilityResult(result);\n\t},\n});\n\nconst listDirectoryTool = createTool({\n\tname: 'list_directory',\n\tdescription: 'List entries of an allowed directory path.',\n\tparameters: ListDirectoryParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\tpath: { type: 'string', description: 'Directory path to list' },\n\t\t},\n\t\trequired: ['path'],\n\t},\n\tasync execute(params, context) {\n\t\tconst result = await context.sandbox.execute(\n\t\t\t'filesystem',\n\t\t\t'list',\n\t\t\t{ path: params.path },\n\t\t\tcontext.requestedBy,\n\t\t);\n\t\treturn fromCapabilityResult(result);\n\t},\n});\n\nconst searchFilesTool = createTool({\n\tname: 'search_files',\n\tdescription: 'Search files by name pattern under an allowed directory.',\n\tparameters: SearchFilesParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\tpath: { type: 'string', description: 'Directory root to search' },\n\t\t\tpattern: { type: 'string', description: 'find-compatible -name pattern (e.g. *.ts)' },\n\t\t},\n\t\trequired: ['path', 'pattern'],\n\t},\n\tasync execute(params, context) {\n\t\tconst command = `find ${shQuote(params.path)} -name ${shQuote(params.pattern)} -print`;\n\t\tconst result = await context.sandbox.execute('shell', 'run', { command }, context.requestedBy);\n\n\t\tif (!result.success) {\n\t\t\treturn fromCapabilityResult(result);\n\t\t}\n\n\t\tconst stdout = (result.output as { stdout?: string } | null)?.stdout ?? '';\n\t\tconst files = stdout\n\t\t\t.split('\\n')\n\t\t\t.map((line) => line.trim())\n\t\t\t.filter((line) => line.length > 0);\n\t\treturn { success: true, output: files };\n\t},\n});\n\nconst moveFileTool = createTool({\n\tname: 'move_file',\n\tdescription: 'Move or rename a file between allowed paths.',\n\tparameters: MoveFileParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\tsourcePath: { type: 'string', description: 'Original file path' },\n\t\t\tdestinationPath: { type: 'string', description: 'Destination file path' },\n\t\t},\n\t\trequired: ['sourcePath', 'destinationPath'],\n\t},\n\tasync execute(params, context) {\n\t\tconst command = `mv -- ${shQuote(params.sourcePath)} ${shQuote(params.destinationPath)}`;\n\t\tconst result = await context.sandbox.execute('shell', 'run', { command }, context.requestedBy);\n\t\treturn fromCapabilityResult(result);\n\t},\n});\n\nexport function createFsTools(): Tool[] {\n\treturn [readFileTool, writeFileTool, listDirectoryTool, searchFilesTool, moveFileTool];\n}\n","import type { z } from 'zod';\nimport type { ToolDefinition } from '../../llm/types.js';\nimport type { CapabilityResult } from '../../sandbox/types.js';\n\nexport interface SandboxExecutor {\n\texecute(\n\t\tcapName: string,\n\t\taction: string,\n\t\tparams: Record<string, unknown>,\n\t\trequestedBy?: string,\n\t): Promise<CapabilityResult>;\n}\n\nexport interface ToolContext {\n\tsandbox: SandboxExecutor;\n\trequestedBy?: string;\n}\n\nexport interface ToolResult {\n\tsuccess: boolean;\n\toutput: unknown;\n\terror?: string;\n}\n\nexport interface Tool<TSchema extends z.ZodTypeAny = z.ZodTypeAny> {\n\tname: string;\n\tdescription: string;\n\tparameters: TSchema;\n\tjsonSchema: Record<string, unknown>;\n\texecute(params: z.infer<TSchema>, context: ToolContext): Promise<ToolResult>;\n\trun(rawParams: unknown, context: ToolContext): Promise<ToolResult>;\n\tgetDefinition(): ToolDefinition;\n}\n\ninterface CreateToolArgs<TSchema extends z.ZodTypeAny> {\n\tname: string;\n\tdescription: string;\n\tparameters: TSchema;\n\tjsonSchema: Record<string, unknown>;\n\texecute(params: z.infer<TSchema>, context: ToolContext): Promise<ToolResult>;\n}\n\nfunction formatZodIssues(issues: z.ZodIssue[]): string {\n\treturn issues\n\t\t.map((issue) => {\n\t\t\tconst path = issue.path.length > 0 ? issue.path.join('.') : '(root)';\n\t\t\treturn `${path}: ${issue.message}`;\n\t\t})\n\t\t.join('; ');\n}\n\nexport function createTool<TSchema extends z.ZodTypeAny>(\n\targs: CreateToolArgs<TSchema>,\n): Tool<TSchema> {\n\treturn {\n\t\tname: args.name,\n\t\tdescription: args.description,\n\t\tparameters: args.parameters,\n\t\tjsonSchema: args.jsonSchema,\n\t\texecute: args.execute,\n\t\tasync run(rawParams: unknown, context: ToolContext): Promise<ToolResult> {\n\t\t\tconst parsed = args.parameters.safeParse(rawParams);\n\t\t\tif (!parsed.success) {\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\toutput: null,\n\t\t\t\t\terror: `Invalid tool parameters: ${formatZodIssues(parsed.error.issues)}`,\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn args.execute(parsed.data, context);\n\t\t},\n\t\tgetDefinition(): ToolDefinition {\n\t\t\treturn {\n\t\t\t\tname: args.name,\n\t\t\t\tdescription: args.description,\n\t\t\t\tparameters: args.jsonSchema,\n\t\t\t};\n\t\t},\n\t};\n}\n","import { z } from 'zod';\nimport { createTool, type Tool } from './types.js';\n\nconst AskUserParams = z.object({\n\tquestion: z.string().min(1),\n\tcontext: z.string().optional(),\n});\n\nconst ReportProgressParams = z.object({\n\tmessage: z.string().min(1),\n\tpercent: z.number().min(0).max(100).optional(),\n});\n\nconst askUserTool = createTool({\n\tname: 'ask_user',\n\tdescription: 'Request clarification from the user when task intent is ambiguous.',\n\tparameters: AskUserParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\tquestion: { type: 'string', description: 'Question to ask the user' },\n\t\t\tcontext: { type: 'string', description: 'Optional context shown with the question' },\n\t\t},\n\t\trequired: ['question'],\n\t},\n\tasync execute(params) {\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\toutput: {\n\t\t\t\ttype: 'user-question',\n\t\t\t\trequiresUserInput: true,\n\t\t\t\tquestion: params.question,\n\t\t\t\tcontext: params.context,\n\t\t\t},\n\t\t};\n\t},\n});\n\nconst reportProgressTool = createTool({\n\tname: 'report_progress',\n\tdescription: 'Emit structured progress updates during multi-step execution.',\n\tparameters: ReportProgressParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\tmessage: { type: 'string', description: 'Progress message' },\n\t\t\tpercent: { type: 'number', description: 'Optional completion percentage (0-100)' },\n\t\t},\n\t\trequired: ['message'],\n\t},\n\tasync execute(params) {\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\toutput: {\n\t\t\t\ttype: 'progress-update',\n\t\t\t\tmessage: params.message,\n\t\t\t\tpercent: params.percent,\n\t\t\t},\n\t\t};\n\t},\n});\n\nexport function createMetaTools(): Tool[] {\n\treturn [askUserTool, reportProgressTool];\n}\n","import { z } from 'zod';\nimport type { CapabilityResult } from '../../sandbox/types.js';\nimport { createTool, type Tool } from './types.js';\n\nfunction fromCapabilityResult(result: CapabilityResult) {\n\treturn {\n\t\tsuccess: result.success,\n\t\toutput: result.output,\n\t\terror: result.error,\n\t};\n}\n\nconst HttpRequestParams = z.object({\n\turl: z.string().url(),\n\tmethod: z.enum(['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD', 'OPTIONS']).default('GET'),\n\theaders: z.record(z.string()).optional(),\n\tbody: z.string().optional(),\n});\n\nconst httpRequestTool = createTool({\n\tname: 'http_request',\n\tdescription: 'Execute an outbound HTTP request through sandboxed network rules.',\n\tparameters: HttpRequestParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\turl: { type: 'string', description: 'Fully-qualified URL to request' },\n\t\t\tmethod: {\n\t\t\t\ttype: 'string',\n\t\t\t\tenum: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD', 'OPTIONS'],\n\t\t\t\tdescription: 'HTTP method',\n\t\t\t},\n\t\t\theaders: {\n\t\t\t\ttype: 'object',\n\t\t\t\tadditionalProperties: { type: 'string' },\n\t\t\t\tdescription: 'Optional request headers',\n\t\t\t},\n\t\t\tbody: { type: 'string', description: 'Optional request body for non-GET methods' },\n\t\t},\n\t\trequired: ['url'],\n\t},\n\tasync execute(params, context) {\n\t\tconst result = await context.sandbox.execute(\n\t\t\t'network',\n\t\t\t'request',\n\t\t\t{\n\t\t\t\turl: params.url,\n\t\t\t\tmethod: params.method,\n\t\t\t\theaders: params.headers,\n\t\t\t\tbody: params.body,\n\t\t\t},\n\t\t\tcontext.requestedBy,\n\t\t);\n\t\treturn fromCapabilityResult(result);\n\t},\n});\n\nexport function createNetworkTools(): Tool[] {\n\treturn [httpRequestTool];\n}\n","import { z } from 'zod';\nimport { getScheduler } from '../../scheduler/registry.js';\nimport { createTool, type Tool } from './types.js';\n\nconst CreateScheduledJobParams = z.object({\n\tname: z.string().min(1).optional(),\n\tschedule: z.string().min(1),\n\ttask: z.string().min(1),\n});\n\nconst ListScheduledJobsParams = z.object({\n\tenabledOnly: z.boolean().optional(),\n});\n\nconst ManageJobParams = z.object({\n\tid: z.string().min(1),\n\taction: z.enum(['enable', 'disable', 'delete']),\n});\n\nconst createScheduledJobTool = createTool({\n\tname: 'create_scheduled_job',\n\tdescription: 'Create a persistent scheduled job for the agent.',\n\tparameters: CreateScheduledJobParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\tname: { type: 'string', description: 'Optional job name' },\n\t\t\tschedule: {\n\t\t\t\ttype: 'string',\n\t\t\t\tdescription: 'Cron expression or natural language schedule (e.g. \"every 30 minutes\")',\n\t\t\t},\n\t\t\ttask: { type: 'string', description: 'Task to execute on each run' },\n\t\t},\n\t\trequired: ['schedule', 'task'],\n\t},\n\tasync execute(params) {\n\t\tconst scheduler = getScheduler();\n\t\tif (!scheduler) {\n\t\t\treturn { success: false, output: null, error: 'Scheduler is not available.' };\n\t\t}\n\n\t\tconst id = await scheduler.createJob(params);\n\t\tconst created = await scheduler.getJob(id);\n\t\treturn { success: true, output: created };\n\t},\n});\n\nconst listScheduledJobsTool = createTool({\n\tname: 'list_scheduled_jobs',\n\tdescription: 'List all currently registered scheduled jobs.',\n\tparameters: ListScheduledJobsParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\tenabledOnly: {\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdescription: 'When true, only enabled jobs are returned',\n\t\t\t},\n\t\t},\n\t\trequired: [],\n\t},\n\tasync execute(params) {\n\t\tconst scheduler = getScheduler();\n\t\tif (!scheduler) {\n\t\t\treturn { success: false, output: null, error: 'Scheduler is not available.' };\n\t\t}\n\t\tconst jobs = await scheduler.listJobs();\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\toutput: params.enabledOnly ? jobs.filter((job) => job.enabled) : jobs,\n\t\t};\n\t},\n});\n\nconst manageJobTool = createTool({\n\tname: 'manage_job',\n\tdescription: 'Enable, disable, or delete an existing scheduled job.',\n\tparameters: ManageJobParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\tid: { type: 'string', description: 'Job id' },\n\t\t\taction: {\n\t\t\t\ttype: 'string',\n\t\t\t\tenum: ['enable', 'disable', 'delete'],\n\t\t\t\tdescription: 'Operation to apply',\n\t\t\t},\n\t\t},\n\t\trequired: ['id', 'action'],\n\t},\n\tasync execute(params) {\n\t\tconst scheduler = getScheduler();\n\t\tif (!scheduler) {\n\t\t\treturn { success: false, output: null, error: 'Scheduler is not available.' };\n\t\t}\n\n\t\tswitch (params.action) {\n\t\t\tcase 'enable':\n\t\t\t\tawait scheduler.enableJob(params.id);\n\t\t\t\tbreak;\n\t\t\tcase 'disable':\n\t\t\t\tawait scheduler.disableJob(params.id);\n\t\t\t\tbreak;\n\t\t\tcase 'delete':\n\t\t\t\tawait scheduler.deleteJob(params.id);\n\t\t\t\tbreak;\n\t\t}\n\n\t\treturn {\n\t\t\tsuccess: true,\n\t\t\toutput: {\n\t\t\t\tid: params.id,\n\t\t\t\taction: params.action,\n\t\t\t},\n\t\t};\n\t},\n});\n\nexport function createSchedulerTools(): Tool[] {\n\treturn [createScheduledJobTool, listScheduledJobsTool, manageJobTool];\n}\n","import type { CronScheduler } from './cron.js';\n\nlet scheduler: CronScheduler | null = null;\n\nexport function setScheduler(value: CronScheduler | null): void {\n\tscheduler = value;\n}\n\nexport function getScheduler(): CronScheduler | null {\n\treturn scheduler;\n}\n","import { z } from 'zod';\nimport type { CapabilityResult } from '../../sandbox/types.js';\nimport { createTool, type Tool } from './types.js';\n\nfunction fromCapabilityResult(result: CapabilityResult) {\n\treturn {\n\t\tsuccess: result.success,\n\t\toutput: result.output,\n\t\terror: result.error,\n\t};\n}\n\nconst ExecuteCommandParams = z.object({\n\tcommand: z.string().min(1),\n\tcwd: z.string().min(1).optional(),\n\ttimeout: z.number().int().positive().max(300_000).optional(),\n});\n\nconst executeCommandTool = createTool({\n\tname: 'execute_command',\n\tdescription: 'Execute a shell command through the sandbox policy engine.',\n\tparameters: ExecuteCommandParams,\n\tjsonSchema: {\n\t\ttype: 'object',\n\t\tproperties: {\n\t\t\tcommand: { type: 'string', description: 'Shell command to execute' },\n\t\t\tcwd: { type: 'string', description: 'Optional working directory' },\n\t\t\ttimeout: { type: 'number', description: 'Optional timeout in milliseconds' },\n\t\t},\n\t\trequired: ['command'],\n\t},\n\tasync execute(params, context) {\n\t\tconst result = await context.sandbox.execute(\n\t\t\t'shell',\n\t\t\t'run',\n\t\t\t{\n\t\t\t\tcommand: params.command,\n\t\t\t\tcwd: params.cwd,\n\t\t\t\ttimeout: params.timeout,\n\t\t\t},\n\t\t\tcontext.requestedBy,\n\t\t);\n\t\treturn fromCapabilityResult(result);\n\t},\n});\n\nexport function createShellTools(): Tool[] {\n\treturn [executeCommandTool];\n}\n","import type { ToolDefinition } from '../../llm/types.js';\nimport { createFsTools } from './fs-tools.js';\nimport { createMetaTools } from './meta-tools.js';\nimport { createNetworkTools } from './network-tools.js';\nimport { createSchedulerTools } from './scheduler-tools.js';\nimport { createShellTools } from './shell-tools.js';\nimport type { Tool, ToolContext, ToolResult } from './types.js';\n\nconst TOOL_REGISTRY: Tool[] = [\n\t...createFsTools(),\n\t...createShellTools(),\n\t...createNetworkTools(),\n\t...createSchedulerTools(),\n\t...createMetaTools(),\n];\n\nexport function getTools(): Tool[] {\n\treturn [...TOOL_REGISTRY];\n}\n\nexport function getToolByName(name: string): Tool | undefined {\n\treturn TOOL_REGISTRY.find((tool) => tool.name === name);\n}\n\nexport function getToolDefinitions(): ToolDefinition[] {\n\treturn TOOL_REGISTRY.map((tool) => tool.getDefinition());\n}\n\nexport async function executeTool(\n\ttoolName: string,\n\tparams: unknown,\n\tcontext: ToolContext,\n): Promise<ToolResult> {\n\tconst tool = getToolByName(toolName);\n\tif (!tool) {\n\t\treturn {\n\t\t\tsuccess: false,\n\t\t\toutput: null,\n\t\t\terror: `Unknown tool: ${toolName}`,\n\t\t};\n\t}\n\n\treturn tool.run(params, context);\n}\n\nexport type { Tool, ToolContext, ToolResult } from './types.js';\n","import type { ExecutionPlan, ExecutionPlanStep } from './planner.js';\nimport { executeTool } from './tools/index.js';\nimport type { ToolContext, ToolResult } from './tools/types.js';\n\nexport type PlanStepStatus =\n\t| 'success'\n\t| 'failed-acceptable'\n\t| 'failed-critical'\n\t| 'fallback'\n\t| 'skipped';\n\nexport interface PlanStepExecutionResult {\n\tstepId: number;\n\ttool: string;\n\tdescription: string;\n\tstatus: PlanStepStatus;\n\tattempts: number;\n\toutput?: unknown;\n\terror?: string;\n}\n\nexport interface PlanExecutionResult {\n\taborted: boolean;\n\tcompletedSteps: number;\n\ttotalSteps: number;\n\tresults: PlanStepExecutionResult[];\n}\n\nexport type ExecutorEvent =\n\t| {\n\t\t\ttype: 'plan_step_started';\n\t\t\tstepId: number;\n\t\t\tdescription: string;\n\t\t\ttool: string;\n\t  }\n\t| {\n\t\t\ttype: 'plan_step_finished';\n\t\t\tstepId: number;\n\t\t\tdescription: string;\n\t\t\ttool: string;\n\t\t\tstatus: PlanStepStatus;\n\t\t\terror?: string;\n\t\t\tattempts: number;\n\t\t\tpercentComplete: number;\n\t  };\n\ninterface ExecutorContext extends ToolContext {\n\tonEvent?: (event: ExecutorEvent) => void;\n}\n\ninterface ExecutorDeps {\n\tmaxRetries?: number;\n\texecuteToolFn?: typeof executeTool;\n}\n\ninterface PlanExecutor {\n\texecutePlan(plan: ExecutionPlan, context: ExecutorContext): Promise<PlanExecutionResult>;\n}\n\nconst DEFAULT_MAX_RETRIES = 1;\n\nfunction parseFallbackInstruction(\n\tvalue: string | undefined,\n): { toolName: string; params: Record<string, unknown> } | null {\n\tif (!value) return null;\n\tconst trimmed = value.trim();\n\tif (!trimmed) return null;\n\n\tconst match = trimmed.match(/^([a-z_][a-z0-9_]*)\\s*(\\{[\\s\\S]*\\})?$/i);\n\tif (!match?.[1]) return null;\n\n\tconst toolName = match[1];\n\tconst rawParams = match[2];\n\tif (!toolName) return null;\n\n\tif (!rawParams) {\n\t\treturn { toolName, params: {} };\n\t}\n\n\ttry {\n\t\tconst parsed = JSON.parse(rawParams) as unknown;\n\t\tif (parsed !== null && typeof parsed === 'object' && !Array.isArray(parsed)) {\n\t\t\treturn { toolName, params: parsed as Record<string, unknown> };\n\t\t}\n\t\treturn { toolName, params: {} };\n\t} catch {\n\t\treturn null;\n\t}\n}\n\nexport function createExecutor(deps: ExecutorDeps = {}): PlanExecutor {\n\tconst maxRetries = deps.maxRetries ?? DEFAULT_MAX_RETRIES;\n\tconst toolExecutor = deps.executeToolFn ?? executeTool;\n\n\tasync function runStep(\n\t\tstep: ExecutionPlanStep,\n\t\tcontext: ExecutorContext,\n\t\tretries: number,\n\t): Promise<PlanStepExecutionResult & { rawResult: ToolResult }> {\n\t\tlet attempts = 0;\n\t\tlet lastResult: ToolResult = {\n\t\t\tsuccess: false,\n\t\t\toutput: null,\n\t\t\terror: 'Tool did not execute',\n\t\t};\n\n\t\tfor (let i = 0; i <= retries; i++) {\n\t\t\tattempts++;\n\t\t\tlastResult = await toolExecutor(step.tool, step.params, context);\n\t\t\tif (lastResult.success) {\n\t\t\t\treturn {\n\t\t\t\t\tstepId: step.id,\n\t\t\t\t\ttool: step.tool,\n\t\t\t\t\tdescription: step.description,\n\t\t\t\t\tstatus: 'success',\n\t\t\t\t\tattempts,\n\t\t\t\t\toutput: lastResult.output,\n\t\t\t\t\trawResult: lastResult,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\tstepId: step.id,\n\t\t\ttool: step.tool,\n\t\t\tdescription: step.description,\n\t\t\tstatus: step.canFail ? 'failed-acceptable' : 'failed-critical',\n\t\t\tattempts,\n\t\t\terror: lastResult.error ?? 'Step failed',\n\t\t\toutput: lastResult.output,\n\t\t\trawResult: lastResult,\n\t\t};\n\t}\n\n\tasync function executePlan(\n\t\tplan: ExecutionPlan,\n\t\tcontext: ExecutorContext,\n\t): Promise<PlanExecutionResult> {\n\t\tconst completed = new Set<number>();\n\t\tconst results: PlanStepExecutionResult[] = [];\n\t\tlet aborted = false;\n\n\t\tfor (const [index, step] of plan.steps.entries()) {\n\t\t\tconst dependenciesReady = step.dependsOn.every((id) => completed.has(id));\n\t\t\tif (!dependenciesReady) {\n\t\t\t\tconst skipped: PlanStepExecutionResult = {\n\t\t\t\t\tstepId: step.id,\n\t\t\t\t\ttool: step.tool,\n\t\t\t\t\tdescription: step.description,\n\t\t\t\t\tstatus: 'skipped',\n\t\t\t\t\tattempts: 0,\n\t\t\t\t\terror: 'Dependencies not met',\n\t\t\t\t};\n\t\t\t\tresults.push(skipped);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tcontext.onEvent?.({\n\t\t\t\ttype: 'plan_step_started',\n\t\t\t\tstepId: step.id,\n\t\t\t\tdescription: step.description,\n\t\t\t\ttool: step.tool,\n\t\t\t});\n\n\t\t\tconst stepResult = await runStep(step, context, maxRetries);\n\t\t\tlet finalResult: PlanStepExecutionResult = { ...stepResult };\n\n\t\t\tif (!stepResult.rawResult.success) {\n\t\t\t\tconst fallback = parseFallbackInstruction(step.fallback);\n\t\t\t\tif (fallback) {\n\t\t\t\t\tconst fallbackRun = await toolExecutor(fallback.toolName, fallback.params, context);\n\t\t\t\t\tif (fallbackRun.success) {\n\t\t\t\t\t\tfinalResult = {\n\t\t\t\t\t\t\tstepId: step.id,\n\t\t\t\t\t\t\ttool: fallback.toolName,\n\t\t\t\t\t\t\tdescription: step.description,\n\t\t\t\t\t\t\tstatus: 'fallback',\n\t\t\t\t\t\t\tattempts: stepResult.attempts + 1,\n\t\t\t\t\t\t\toutput: fallbackRun.output,\n\t\t\t\t\t\t};\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfinalResult = {\n\t\t\t\t\t\t\t...finalResult,\n\t\t\t\t\t\t\tattempts: stepResult.attempts + 1,\n\t\t\t\t\t\t\terror: fallbackRun.error ?? finalResult.error,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tresults.push(finalResult);\n\t\t\tif (finalResult.status === 'success' || finalResult.status === 'fallback') {\n\t\t\t\tcompleted.add(step.id);\n\t\t\t}\n\t\t\tif (finalResult.status === 'failed-acceptable') {\n\t\t\t\tcompleted.add(step.id);\n\t\t\t}\n\n\t\t\tconst percentComplete = Math.round(((index + 1) / plan.steps.length) * 100);\n\t\t\tcontext.onEvent?.({\n\t\t\t\ttype: 'plan_step_finished',\n\t\t\t\tstepId: step.id,\n\t\t\t\tdescription: step.description,\n\t\t\t\ttool: finalResult.tool,\n\t\t\t\tstatus: finalResult.status,\n\t\t\t\terror: finalResult.error,\n\t\t\t\tattempts: finalResult.attempts,\n\t\t\t\tpercentComplete,\n\t\t\t});\n\n\t\t\tif (finalResult.status === 'failed-critical') {\n\t\t\t\taborted = true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn {\n\t\t\taborted,\n\t\t\tcompletedSteps: completed.size,\n\t\t\ttotalSteps: plan.steps.length,\n\t\t\tresults,\n\t\t};\n\t}\n\n\treturn { executePlan };\n}\n","import type { createLLMRouter } from '../llm/router.js';\nimport type { Message } from '../llm/types.js';\nimport { getToolDefinitions } from './tools/index.js';\n\nexport interface ExecutionPlanStep {\n\tid: number;\n\tdescription: string;\n\ttool: string;\n\tparams: Record<string, unknown>;\n\tdependsOn: number[];\n\tcanFail: boolean;\n\tfallback?: string;\n}\n\nexport interface ExecutionPlan {\n\tgoal: string;\n\tsteps: ExecutionPlanStep[];\n\thasSideEffects: boolean;\n\testimatedDuration: string;\n\trisks: string[];\n}\n\ninterface PlannerDeps {\n\trouter: ReturnType<typeof createLLMRouter>;\n\tmaxSteps?: number;\n}\n\ninterface Planner {\n\tshouldPlan(input: string): boolean;\n\tcreatePlan(input: string, history: Message[]): Promise<ExecutionPlan | null>;\n}\n\nconst DEFAULT_MAX_STEPS = 8;\nconst MULTI_STEP_HINTS = [\n\t/\\bthen\\b/i,\n\t/\\band then\\b/i,\n\t/\\bafter that\\b/i,\n\t/\\bfirst\\b.*\\bthen\\b/i,\n\t/\\bcreate\\b.*\\b(write|list|read|move|run)\\b/i,\n\t/\\bmulti[- ]step\\b/i,\n];\n\nfunction shouldPlanInput(input: string): boolean {\n\treturn MULTI_STEP_HINTS.some((pattern) => pattern.test(input));\n}\n\nfunction buildPlanningPrompt(input: string, history: Message[]): string {\n\tconst toolList = getToolDefinitions()\n\t\t.map((tool) => `- ${tool.name}: ${tool.description}`)\n\t\t.join('\\n');\n\n\tconst recentHistory = history\n\t\t.slice(-6)\n\t\t.map((msg) => `${msg.role}: ${msg.content}`)\n\t\t.join('\\n');\n\n\treturn [\n\t\t'You are planning steps for a tool-using agent.',\n\t\t'Return ONLY valid JSON with this shape:',\n\t\t'{\"goal\":\"...\",\"steps\":[{\"id\":1,\"description\":\"...\",\"tool\":\"...\",\"params\":{},\"dependsOn\":[],\"canFail\":false,\"fallback\":\"optional\"}],\"hasSideEffects\":true,\"estimatedDuration\":\"...\",\"risks\":[\"...\"]}',\n\t\t'Rules:',\n\t\t'- Use only the listed tools',\n\t\t'- Keep steps minimal and ordered',\n\t\t'- Read before write when relevant',\n\t\t'- Mark hasSideEffects true for write/move/shell/network mutating tasks',\n\t\t'Available tools:',\n\t\ttoolList,\n\t\t'Recent conversation:',\n\t\trecentHistory || '(none)',\n\t\t`User request: ${input}`,\n\t].join('\\n');\n}\n\nfunction extractJsonBlock(text: string): string | null {\n\tconst fenced = text.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/i);\n\tif (fenced?.[1]) {\n\t\treturn fenced[1].trim();\n\t}\n\n\tconst start = text.indexOf('{');\n\tif (start === -1) return null;\n\n\tlet depth = 0;\n\tlet inString = false;\n\tlet escaping = false;\n\tfor (let i = start; i < text.length; i++) {\n\t\tconst char = text[i];\n\t\tif (!char) continue;\n\n\t\tif (inString) {\n\t\t\tif (escaping) {\n\t\t\t\tescaping = false;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (char === '\\\\') {\n\t\t\t\tescaping = true;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (char === '\"') {\n\t\t\t\tinString = false;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (char === '\"') {\n\t\t\tinString = true;\n\t\t\tcontinue;\n\t\t}\n\t\tif (char === '{') {\n\t\t\tdepth++;\n\t\t\tcontinue;\n\t\t}\n\t\tif (char === '}') {\n\t\t\tdepth--;\n\t\t\tif (depth === 0) {\n\t\t\t\treturn text.slice(start, i + 1);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn null;\n}\n\nfunction asRecord(value: unknown): Record<string, unknown> {\n\tif (value !== null && typeof value === 'object' && !Array.isArray(value)) {\n\t\treturn value as Record<string, unknown>;\n\t}\n\treturn {};\n}\n\nfunction toStringArray(value: unknown): string[] {\n\tif (!Array.isArray(value)) return [];\n\treturn value.map((item) => String(item));\n}\n\nfunction toNumberArray(value: unknown): number[] {\n\tif (!Array.isArray(value)) return [];\n\treturn value.map((item) => Number(item)).filter((item) => Number.isInteger(item) && item > 0);\n}\n\nfunction normalizeStep(raw: unknown, fallbackId: number): ExecutionPlanStep | null {\n\tconst step = asRecord(raw);\n\tconst id = Number(step.id);\n\tconst normalizedId = Number.isInteger(id) && id > 0 ? id : fallbackId;\n\n\tconst description = String(step.description ?? '').trim();\n\tconst tool = String(step.tool ?? '').trim();\n\tif (!description || !tool) return null;\n\n\tconst fallbackValue = step.fallback;\n\tconst fallback =\n\t\ttypeof fallbackValue === 'string' && fallbackValue.trim() ? fallbackValue : undefined;\n\n\treturn {\n\t\tid: normalizedId,\n\t\tdescription,\n\t\ttool,\n\t\tparams: asRecord(step.params),\n\t\tdependsOn: toNumberArray(step.dependsOn),\n\t\tcanFail: Boolean(step.canFail),\n\t\tfallback,\n\t};\n}\n\nfunction normalizePlan(raw: unknown, maxSteps: number): ExecutionPlan | null {\n\tconst candidate = asRecord(raw);\n\tconst rawSteps = Array.isArray(candidate.steps) ? candidate.steps : [];\n\tif (rawSteps.length === 0) return null;\n\n\tconst steps: ExecutionPlanStep[] = [];\n\tfor (const [index, rawStep] of rawSteps.entries()) {\n\t\tif (steps.length >= maxSteps) break;\n\t\tconst normalized = normalizeStep(rawStep, index + 1);\n\t\tif (normalized) {\n\t\t\tsteps.push(normalized);\n\t\t}\n\t}\n\n\tif (steps.length === 0) return null;\n\n\tsteps.sort((a, b) => a.id - b.id);\n\tconst sideEffectTools = new Set(['write_file', 'move_file', 'execute_command', 'http_request']);\n\tconst hasExplicitSideEffects = Boolean(candidate.hasSideEffects);\n\tconst hasToolSideEffects = steps.some((step) => sideEffectTools.has(step.tool));\n\n\treturn {\n\t\tgoal: String(candidate.goal ?? 'Complete user request'),\n\t\tsteps,\n\t\thasSideEffects: hasExplicitSideEffects || hasToolSideEffects,\n\t\testimatedDuration: String(candidate.estimatedDuration ?? 'unknown'),\n\t\trisks: toStringArray(candidate.risks),\n\t};\n}\n\nexport function parsePlanFromText(\n\ttext: string,\n\tmaxSteps = DEFAULT_MAX_STEPS,\n): ExecutionPlan | null {\n\tconst json = extractJsonBlock(text);\n\tif (!json) return null;\n\n\ttry {\n\t\tconst parsed = JSON.parse(json) as unknown;\n\t\treturn normalizePlan(parsed, maxSteps);\n\t} catch {\n\t\treturn null;\n\t}\n}\n\nexport function createPlanner(deps: PlannerDeps): Planner {\n\tconst maxSteps = deps.maxSteps ?? DEFAULT_MAX_STEPS;\n\n\tasync function createPlan(input: string, history: Message[]): Promise<ExecutionPlan | null> {\n\t\tconst requestText = buildPlanningPrompt(input, history);\n\t\tconst response = await deps.router.complete({\n\t\t\tmessages: [{ role: 'user', content: requestText }],\n\t\t\ttaskType: 'complex_reasoning',\n\t\t\ttemperature: 0,\n\t\t\tmaxTokens: 1400,\n\t\t});\n\n\t\treturn parsePlanFromText(response.content, maxSteps);\n\t}\n\n\treturn {\n\t\tshouldPlan: shouldPlanInput,\n\t\tcreatePlan,\n\t};\n}\n","import type { createLLMRouter } from '../llm/router.js';\nimport type { LLMRequest, Message } from '../llm/types.js';\nimport type { EpisodicMemory } from '../memory/episodic.js';\nimport type { MemoryRetrievalPipeline } from '../memory/retrieval.js';\nimport type { createSoul } from '../memory/soul.js';\nimport type { createWorkingMemory } from '../memory/working.js';\nimport { createLogger } from '../utils/logger.js';\nimport { buildSystemPrompt } from './context.js';\nimport { createExecutor } from './executor.js';\nimport { createPlanner, type ExecutionPlan } from './planner.js';\nimport { executeTool, getToolDefinitions } from './tools/index.js';\nimport type { SandboxExecutor } from './tools/types.js';\nimport type { AgentEvent, AgentResponse, AgentRunOptions, ChannelName } from './types.js';\n\nconst logger = createLogger('core:agent');\n\ninterface AgentDeps {\n\trouter: ReturnType<typeof createLLMRouter>;\n\tworkingMemory: ReturnType<typeof createWorkingMemory>;\n\tsoul: ReturnType<typeof createSoul>;\n\tsandbox?: SandboxExecutor;\n\tepisodicMemory?: EpisodicMemory;\n\tretrieval?: MemoryRetrievalPipeline;\n\tretrievalTokenBudget?: number;\n\tmaxIterations?: number;\n}\n\ninterface Agent {\n\tprocessMessage(\n\t\tinput: string,\n\t\tchannel: ChannelName,\n\t\toptions?: AgentRunOptions,\n\t): Promise<AgentResponse>;\n\tgetConversationHistory(): Message[];\n\tclearHistory(): void;\n}\n\n/**\n * Creates the main Mama agent.\n * Processes user messages through the LLM router with context management.\n */\nexport function createAgent(deps: AgentDeps): Agent {\n\tconst { router, workingMemory, soul, sandbox, episodicMemory, retrieval } = deps;\n\tconst planner = createPlanner({ router });\n\tconst executor = createExecutor();\n\tconst maxIterations = deps.maxIterations ?? 10;\n\tconst retrievalTokenBudget = deps.retrievalTokenBudget ?? 1200;\n\n\tfunction emit(options: AgentRunOptions | undefined, event: AgentEvent): void {\n\t\toptions?.onEvent?.(event);\n\t}\n\n\tfunction buildRequest(toolsEnabled: boolean): LLMRequest {\n\t\treturn {\n\t\t\tmessages: workingMemory.getMessages(),\n\t\t\tsystemPrompt: buildSystemPrompt(soul.getSoulPrompt(), workingMemory.getSystemInjection()),\n\t\t\ttaskType: 'general',\n\t\t\tmaxTokens: 4096,\n\t\t\ttools: toolsEnabled ? getToolDefinitions() : undefined,\n\t\t};\n\t}\n\n\tfunction stringifyToolResult(result: {\n\t\tsuccess: boolean;\n\t\toutput: unknown;\n\t\terror?: string;\n\t}): string {\n\t\treturn JSON.stringify({\n\t\t\tsuccess: result.success,\n\t\t\toutput: result.output,\n\t\t\terror: result.error,\n\t\t});\n\t}\n\n\tfunction formatPlanSummary(plan: ExecutionPlan): string {\n\t\tconst stepLines = plan.steps.map((step) => `${step.id}. ${step.description} [${step.tool}]`);\n\t\tconst riskLine = plan.risks.length > 0 ? `\\nRisks: ${plan.risks.join('; ')}` : '';\n\t\treturn [`Plan: ${plan.goal}`, ...stepLines, riskLine].filter(Boolean).join('\\n');\n\t}\n\n\tfunction formatExecutionSummary(\n\t\tplan: ExecutionPlan,\n\t\tresult: AgentResponse['planExecution'],\n\t): string {\n\t\tif (!result) {\n\t\t\treturn `Plan created for \"${plan.goal}\", but no execution results are available.`;\n\t\t}\n\n\t\tconst lines = [`Plan executed: ${plan.goal}`];\n\t\tfor (const step of result.results) {\n\t\t\tconst detail = step.error ? ` ‚Äî ${step.error}` : '';\n\t\t\tlines.push(`${step.stepId}. ${step.description}: ${step.status}${detail}`);\n\t\t}\n\t\tif (result.aborted) {\n\t\t\tlines.push('Execution aborted due to a critical step failure.');\n\t\t}\n\t\treturn lines.join('\\n');\n\t}\n\n\tasync function recordEpisode(\n\t\tchannel: ChannelName,\n\t\trole: 'system' | 'user' | 'assistant' | 'tool',\n\t\tcontent: string,\n\t\tmetadata?: Record<string, unknown>,\n\t): Promise<void> {\n\t\tif (!episodicMemory) return;\n\n\t\ttry {\n\t\t\tawait episodicMemory.storeEpisode({\n\t\t\t\tchannel,\n\t\t\t\trole,\n\t\t\t\tcontent,\n\t\t\t\tmetadata,\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tlogger.warn('Failed to record episodic memory', {\n\t\t\t\tchannel,\n\t\t\t\trole,\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t});\n\t\t}\n\t}\n\n\tasync function refreshRetrievedContext(input: string): Promise<void> {\n\t\tif (!retrieval) return;\n\n\t\ttry {\n\t\t\tconst context = await retrieval.retrieveContext(input, retrievalTokenBudget);\n\t\t\tworkingMemory.setSystemInjection(context.entries);\n\t\t} catch (error) {\n\t\t\tworkingMemory.setSystemInjection([]);\n\t\t\tlogger.warn('Failed to retrieve memory context', {\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t});\n\t\t}\n\t}\n\n\tasync function processMessage(\n\t\tinput: string,\n\t\tchannel: ChannelName,\n\t\toptions?: AgentRunOptions,\n\t): Promise<AgentResponse> {\n\t\tlogger.info('Processing message', { channel, inputLength: input.length });\n\n\t\t// Add user message to working memory\n\t\tconst userMessage: Message = { role: 'user', content: input };\n\t\tworkingMemory.addMessage(userMessage);\n\t\tawait recordEpisode(channel, 'user', input, { event: 'user_message' });\n\t\tawait refreshRetrievedContext(input);\n\n\t\t// Multi-step planning path\n\t\tif (sandbox && planner.shouldPlan(input)) {\n\t\t\tconst plan = await planner.createPlan(input, workingMemory.getMessages());\n\t\t\tif (plan) {\n\t\t\t\temit(options, { type: 'plan_created', plan });\n\t\t\t\tawait recordEpisode(channel, 'system', formatPlanSummary(plan), {\n\t\t\t\t\tevent: 'plan_created',\n\t\t\t\t\tstepCount: plan.steps.length,\n\t\t\t\t\thasSideEffects: plan.hasSideEffects,\n\t\t\t\t});\n\n\t\t\t\tif (plan.hasSideEffects) {\n\t\t\t\t\temit(options, { type: 'plan_approval_requested', plan });\n\t\t\t\t\tconst approved = options?.onPlanApproval ? await options.onPlanApproval(plan) : false;\n\t\t\t\t\tif (!approved) {\n\t\t\t\t\t\tconst cancelled = `Plan cancelled by user.\\n${formatPlanSummary(plan)}`;\n\t\t\t\t\t\tworkingMemory.addMessage({ role: 'assistant', content: cancelled });\n\t\t\t\t\t\tawait recordEpisode(channel, 'assistant', cancelled, { event: 'plan_cancelled' });\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tcontent: cancelled,\n\t\t\t\t\t\t\tmodel: 'planner-executor',\n\t\t\t\t\t\t\tprovider: 'internal',\n\t\t\t\t\t\t\ttokenUsage: { input: 0, output: 0 },\n\t\t\t\t\t\t\titerations: 0,\n\t\t\t\t\t\t\ttoolCallsExecuted: 0,\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst execution = await executor.executePlan(plan, {\n\t\t\t\t\tsandbox,\n\t\t\t\t\trequestedBy: channel,\n\t\t\t\t\tonEvent: (event) => emit(options, event),\n\t\t\t\t});\n\n\t\t\t\tconst summary = formatExecutionSummary(plan, execution);\n\t\t\t\tworkingMemory.addMessage({ role: 'assistant', content: summary });\n\t\t\t\tawait recordEpisode(channel, 'assistant', summary, {\n\t\t\t\t\tevent: 'plan_executed',\n\t\t\t\t\taborted: execution.aborted,\n\t\t\t\t\tstepCount: execution.results.length,\n\t\t\t\t});\n\t\t\t\treturn {\n\t\t\t\t\tcontent: summary,\n\t\t\t\t\tmodel: 'planner-executor',\n\t\t\t\t\tprovider: 'internal',\n\t\t\t\t\ttokenUsage: { input: 0, output: 0 },\n\t\t\t\t\titerations: 0,\n\t\t\t\t\ttoolCallsExecuted: execution.results.length,\n\t\t\t\t\tplanExecution: execution,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Standard ReAct loop with tool use\n\t\tlet totalInputTokens = 0;\n\t\tlet totalOutputTokens = 0;\n\t\tlet toolCallsExecuted = 0;\n\n\t\tfor (let iteration = 0; iteration < maxIterations; iteration++) {\n\t\t\tconst response = await router.complete(buildRequest(Boolean(sandbox)));\n\t\t\ttotalInputTokens += response.usage.inputTokens;\n\t\t\ttotalOutputTokens += response.usage.outputTokens;\n\n\t\t\tif (response.toolCalls.length === 0) {\n\t\t\t\tworkingMemory.addMessage({\n\t\t\t\t\trole: 'assistant',\n\t\t\t\t\tcontent: response.content,\n\t\t\t\t});\n\t\t\t\tawait recordEpisode(channel, 'assistant', response.content, {\n\t\t\t\t\tevent: 'assistant_response',\n\t\t\t\t\tmodel: response.model,\n\t\t\t\t\tprovider: response.provider,\n\t\t\t\t\titerations: iteration + 1,\n\t\t\t\t});\n\n\t\t\t\tlogger.info('Message processed', {\n\t\t\t\t\tchannel,\n\t\t\t\t\tmodel: response.model,\n\t\t\t\t\tprovider: response.provider,\n\t\t\t\t\tinputTokens: totalInputTokens,\n\t\t\t\t\toutputTokens: totalOutputTokens,\n\t\t\t\t\titerations: iteration + 1,\n\t\t\t\t\ttoolCallsExecuted,\n\t\t\t\t});\n\n\t\t\t\treturn {\n\t\t\t\t\tcontent: response.content,\n\t\t\t\t\tmodel: response.model,\n\t\t\t\t\tprovider: response.provider,\n\t\t\t\t\ttokenUsage: {\n\t\t\t\t\t\tinput: totalInputTokens,\n\t\t\t\t\t\toutput: totalOutputTokens,\n\t\t\t\t\t},\n\t\t\t\t\titerations: iteration + 1,\n\t\t\t\t\ttoolCallsExecuted,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (!sandbox) {\n\t\t\t\tconst noSandboxMessage = 'Tool call requested but sandbox is not configured.';\n\t\t\t\tworkingMemory.addMessage({ role: 'assistant', content: noSandboxMessage });\n\t\t\t\tawait recordEpisode(channel, 'assistant', noSandboxMessage, {\n\t\t\t\t\tevent: 'tool_unavailable',\n\t\t\t\t});\n\t\t\t\treturn {\n\t\t\t\t\tcontent: noSandboxMessage,\n\t\t\t\t\tmodel: response.model,\n\t\t\t\t\tprovider: response.provider,\n\t\t\t\t\ttokenUsage: {\n\t\t\t\t\t\tinput: totalInputTokens,\n\t\t\t\t\t\toutput: totalOutputTokens,\n\t\t\t\t\t},\n\t\t\t\t\titerations: iteration + 1,\n\t\t\t\t\ttoolCallsExecuted,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tworkingMemory.addMessage({\n\t\t\t\trole: 'assistant',\n\t\t\t\tcontent: response.content,\n\t\t\t\ttoolCalls: response.toolCalls,\n\t\t\t});\n\t\t\tif (response.content.trim().length > 0) {\n\t\t\t\tawait recordEpisode(channel, 'assistant', response.content, {\n\t\t\t\t\tevent: 'assistant_tool_request',\n\t\t\t\t\ttoolCount: response.toolCalls.length,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tfor (const toolCall of response.toolCalls) {\n\t\t\t\temit(options, {\n\t\t\t\t\ttype: 'tool_call_started',\n\t\t\t\t\tcallId: toolCall.id,\n\t\t\t\t\ttoolName: toolCall.name,\n\t\t\t\t});\n\t\t\t\tconst result = await executeTool(toolCall.name, toolCall.arguments, {\n\t\t\t\t\tsandbox,\n\t\t\t\t\trequestedBy: channel,\n\t\t\t\t});\n\t\t\t\ttoolCallsExecuted++;\n\t\t\t\temit(options, {\n\t\t\t\t\ttype: 'tool_call_finished',\n\t\t\t\t\tcallId: toolCall.id,\n\t\t\t\t\ttoolName: toolCall.name,\n\t\t\t\t\tsuccess: result.success,\n\t\t\t\t\terror: result.error,\n\t\t\t\t});\n\t\t\t\tconst toolResultContent = stringifyToolResult(result);\n\n\t\t\t\tworkingMemory.addMessage({\n\t\t\t\t\trole: 'tool',\n\t\t\t\t\tcontent: toolResultContent,\n\t\t\t\t\ttoolResultId: toolCall.id,\n\t\t\t\t});\n\t\t\t\tawait recordEpisode(channel, 'tool', toolResultContent, {\n\t\t\t\t\tevent: 'tool_result',\n\t\t\t\t\ttoolName: toolCall.name,\n\t\t\t\t\ttoolCallId: toolCall.id,\n\t\t\t\t\tsuccess: result.success,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tconst limitMessage = `Maximum tool iterations (${maxIterations}) reached. Please refine the request.`;\n\t\tworkingMemory.addMessage({ role: 'assistant', content: limitMessage });\n\t\tawait recordEpisode(channel, 'assistant', limitMessage, {\n\t\t\tevent: 'tool_iteration_limit',\n\t\t\tmaxIterations,\n\t\t});\n\n\t\tlogger.warn('Tool iteration limit reached', {\n\t\t\tchannel,\n\t\t\tmaxIterations,\n\t\t\ttoolCallsExecuted,\n\t\t});\n\n\t\treturn {\n\t\t\tcontent: limitMessage,\n\t\t\tmodel: 'tool-loop',\n\t\t\tprovider: 'internal',\n\t\t\ttokenUsage: {\n\t\t\t\tinput: totalInputTokens,\n\t\t\t\toutput: totalOutputTokens,\n\t\t\t},\n\t\t\titerations: maxIterations,\n\t\t\ttoolCallsExecuted,\n\t\t};\n\t}\n\n\tfunction getConversationHistory(): Message[] {\n\t\treturn workingMemory.getMessages();\n\t}\n\n\tfunction clearHistory(): void {\n\t\tworkingMemory.clear();\n\t\tlogger.info('Conversation history cleared');\n\t}\n\n\treturn {\n\t\tprocessMessage,\n\t\tgetConversationHistory,\n\t\tclearHistory,\n\t};\n}\n","import { spawn } from 'node:child_process';\nimport { existsSync, mkdirSync, readFileSync, rmSync, writeFileSync } from 'node:fs';\nimport { dirname } from 'node:path';\nimport { createLogger } from './utils/logger.js';\n\nconst logger = createLogger('daemon');\n\nexport interface ManagedService {\n\tname: string;\n\tstart(): Promise<void>;\n\tstop(): Promise<void>;\n\thealthCheck?(): Promise<boolean>;\n}\n\ninterface DaemonOptions {\n\tpidFile: string;\n\tservices: ManagedService[];\n\thealthCheckIntervalMs?: number;\n\tnow?: () => Date;\n}\n\nexport interface DaemonController {\n\tstart(): Promise<void>;\n\tstop(): Promise<void>;\n\tisRunning(): boolean;\n}\n\nfunction writePidFile(pidFile: string, pid: number): void {\n\tmkdirSync(dirname(pidFile), { recursive: true });\n\twriteFileSync(pidFile, `${pid}\\n`, 'utf-8');\n}\n\nfunction readPidFile(pidFile: string): number | null {\n\tif (!existsSync(pidFile)) return null;\n\tconst raw = readFileSync(pidFile, 'utf-8').trim();\n\tconst parsed = Number.parseInt(raw, 10);\n\treturn Number.isFinite(parsed) ? parsed : null;\n}\n\nexport function isProcessAlive(pid: number): boolean {\n\ttry {\n\t\tprocess.kill(pid, 0);\n\t\treturn true;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\nexport function getDaemonStatus(pidFile: string): { running: boolean; pid: number | null } {\n\tconst pid = readPidFile(pidFile);\n\tif (!pid) return { running: false, pid: null };\n\treturn { running: isProcessAlive(pid), pid };\n}\n\nexport function stopDaemonProcess(pidFile: string): boolean {\n\tconst pid = readPidFile(pidFile);\n\tif (!pid) return false;\n\ttry {\n\t\tprocess.kill(pid, 'SIGTERM');\n\t\treturn true;\n\t} catch {\n\t\treturn false;\n\t}\n}\n\nexport function readDaemonLogs(logFile: string, lines = 100): string {\n\tif (!existsSync(logFile)) return '';\n\tconst content = readFileSync(logFile, 'utf-8');\n\tconst chunks = content.split('\\n');\n\treturn chunks.slice(-lines).join('\\n').trim();\n}\n\nexport function startDetachedDaemonProcess(options: {\n\tcommand: string;\n\targs: string[];\n\tcwd: string;\n}): number {\n\tconst child = spawn(options.command, options.args, {\n\t\tcwd: options.cwd,\n\t\tdetached: true,\n\t\tstdio: 'ignore',\n\t});\n\tchild.unref();\n\treturn child.pid ?? -1;\n}\n\nexport function createDaemonController(options: DaemonOptions): DaemonController {\n\tconst now = options.now ?? (() => new Date());\n\tconst healthCheckIntervalMs = Math.max(5_000, options.healthCheckIntervalMs ?? 30_000);\n\tlet running = false;\n\tlet healthTimer: NodeJS.Timeout | null = null;\n\n\tasync function runHealthChecks(): Promise<void> {\n\t\tfor (const service of options.services) {\n\t\t\tif (!service.healthCheck) continue;\n\t\t\tconst healthy = await service.healthCheck();\n\t\t\tif (healthy) continue;\n\n\t\t\tlogger.warn('Service health check failed, restarting service', {\n\t\t\t\tservice: service.name,\n\t\t\t});\n\t\t\tawait service.stop();\n\t\t\tawait service.start();\n\t\t}\n\t}\n\n\tasync function start(): Promise<void> {\n\t\tif (running) return;\n\n\t\tconst existing = getDaemonStatus(options.pidFile);\n\t\tif (existing.running) {\n\t\t\tthrow new Error(`Daemon already running (pid ${existing.pid})`);\n\t\t}\n\n\t\twritePidFile(options.pidFile, process.pid);\n\t\tfor (const service of options.services) {\n\t\t\tawait service.start();\n\t\t\tlogger.info('Service started', { service: service.name, at: now().toISOString() });\n\t\t}\n\t\thealthTimer = setInterval(() => {\n\t\t\trunHealthChecks().catch((error) => {\n\t\t\t\tlogger.error('Daemon health check loop failed', {\n\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t});\n\t\t\t});\n\t\t}, healthCheckIntervalMs);\n\n\t\trunning = true;\n\t}\n\n\tasync function stop(): Promise<void> {\n\t\tif (!running) {\n\t\t\trmSync(options.pidFile, { force: true });\n\t\t\treturn;\n\t\t}\n\t\tif (healthTimer) {\n\t\t\tclearInterval(healthTimer);\n\t\t\thealthTimer = null;\n\t\t}\n\n\t\tfor (let i = options.services.length - 1; i >= 0; i--) {\n\t\t\tconst service = options.services[i];\n\t\t\tif (!service) continue;\n\t\t\ttry {\n\t\t\t\tawait service.stop();\n\t\t\t\tlogger.info('Service stopped', { service: service.name, at: now().toISOString() });\n\t\t\t} catch (error) {\n\t\t\t\tlogger.error('Failed to stop service', {\n\t\t\t\t\tservice: service.name,\n\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\trmSync(options.pidFile, { force: true });\n\t\trunning = false;\n\t}\n\n\treturn {\n\t\tstart,\n\t\tstop,\n\t\tisRunning: () => running,\n\t};\n}\n","import type { MemoryStore } from '../memory/store.js';\nimport { createLogger } from '../utils/logger.js';\nimport type { LLMProvider, LLMUsageRecord, TaskType, TokenUsage } from './types.js';\n\nconst logger = createLogger('llm:cost-tracker');\n\n/** Cost per 1M tokens (input/output) by model */\nconst MODEL_PRICING: Record<string, { input: number; output: number }> = {\n\t'claude-sonnet-4-20250514': { input: 3.0, output: 15.0 },\n\t'claude-haiku-4-20250514': { input: 0.8, output: 4.0 },\n\t'claude-opus-4-20250514': { input: 15.0, output: 75.0 },\n\t// Ollama models are free by default.\n\tdefault: { input: 0, output: 0 },\n};\n\ninterface CostTrackerOptions {\n\tstore?: MemoryStore;\n\tclock?: () => Date;\n}\n\ninterface UsageSummary {\n\ttotalInputTokens: number;\n\ttotalOutputTokens: number;\n\ttotalCostUsd: number;\n\taverageCostPerDayUsd: number;\n\tbyModel: Record<string, { inputTokens: number; outputTokens: number; costUsd: number }>;\n}\n\ninterface CostTracker {\n\trecord(params: {\n\t\tprovider: LLMProvider;\n\t\tmodel: string;\n\t\tusage: TokenUsage;\n\t\ttaskType: TaskType;\n\t\tlatencyMs: number;\n\t}): LLMUsageRecord;\n\tgetUsageToday(): LLMUsageRecord[];\n\tgetUsageThisWeek(): LLMUsageRecord[];\n\tgetUsageThisMonth(): LLMUsageRecord[];\n\tgetTotalCost(): number;\n\tgetCostToday(): number;\n\tgetCostThisMonth(): number;\n\tgetRecords(): LLMUsageRecord[];\n\tsummarize(records?: LLMUsageRecord[]): UsageSummary;\n\tclear(): void;\n}\n\ninterface UsageRow {\n\tid: string;\n\ttimestamp: string;\n\tprovider: LLMProvider;\n\tmodel: string;\n\tinput_tokens: number;\n\toutput_tokens: number;\n\tcost_usd: number;\n\ttask_type: TaskType;\n\tlatency_ms: number;\n}\n\nfunction getCostForModel(model: string, usage: TokenUsage): number {\n\tconst fallbackPricing = MODEL_PRICING.default ?? { input: 0, output: 0 };\n\tconst pricing = MODEL_PRICING[model] ?? fallbackPricing;\n\tconst inputCost = (usage.inputTokens / 1_000_000) * pricing.input;\n\tconst outputCost = (usage.outputTokens / 1_000_000) * pricing.output;\n\treturn inputCost + outputCost;\n}\n\nfunction parseUsageRow(row: UsageRow): LLMUsageRecord {\n\treturn {\n\t\tid: row.id,\n\t\ttimestamp: new Date(row.timestamp),\n\t\tprovider: row.provider,\n\t\tmodel: row.model,\n\t\tinputTokens: row.input_tokens,\n\t\toutputTokens: row.output_tokens,\n\t\tcostUsd: row.cost_usd,\n\t\ttaskType: row.task_type,\n\t\tlatencyMs: row.latency_ms,\n\t};\n}\n\nfunction startOfDay(date: Date): Date {\n\tconst copy = new Date(date);\n\tcopy.setHours(0, 0, 0, 0);\n\treturn copy;\n}\n\nfunction startOfWeek(date: Date): Date {\n\tconst day = date.getDay(); // Sunday=0\n\tconst copy = startOfDay(date);\n\tcopy.setDate(copy.getDate() - day);\n\treturn copy;\n}\n\nfunction startOfMonth(date: Date): Date {\n\tconst copy = startOfDay(date);\n\tcopy.setDate(1);\n\treturn copy;\n}\n\nfunction sumCost(entries: LLMUsageRecord[]): number {\n\treturn entries.reduce((sum, record) => sum + record.costUsd, 0);\n}\n\nfunction sumTokens(entries: LLMUsageRecord[]): { input: number; output: number } {\n\treturn entries.reduce(\n\t\t(acc, record) => ({\n\t\t\tinput: acc.input + record.inputTokens,\n\t\t\toutput: acc.output + record.outputTokens,\n\t\t}),\n\t\t{ input: 0, output: 0 },\n\t);\n}\n\nfunction estimateAverageCostPerDay(entries: LLMUsageRecord[]): number {\n\tif (entries.length === 0) return 0;\n\tconst timestamps = entries.map((entry) => entry.timestamp.getTime());\n\tconst min = Math.min(...timestamps);\n\tconst max = Math.max(...timestamps);\n\tconst days = Math.max(1, Math.ceil((max - min) / 86_400_000) + 1);\n\treturn sumCost(entries) / days;\n}\n\n/**\n * Creates a cost tracker and optionally persists usage in SQLite.\n */\nexport function createCostTracker(options: CostTrackerOptions = {}): CostTracker {\n\tconst records: LLMUsageRecord[] = [];\n\tconst clock = options.clock ?? (() => new Date());\n\tlet idCounter = 0;\n\n\tif (options.store) {\n\t\tconst rows = options.store.all<UsageRow>(\n\t\t\t`SELECT id, timestamp, provider, model, input_tokens, output_tokens, cost_usd, task_type, latency_ms\n\t\t\t FROM llm_usage\n\t\t\t ORDER BY timestamp ASC`,\n\t\t);\n\t\tfor (const row of rows) {\n\t\t\trecords.push(parseUsageRow(row));\n\t\t}\n\t\tidCounter = rows.length;\n\t}\n\n\tfunction persist(entry: LLMUsageRecord): void {\n\t\tif (!options.store) return;\n\t\toptions.store.run(\n\t\t\t`INSERT INTO llm_usage (id, timestamp, provider, model, input_tokens, output_tokens, cost_usd, task_type, latency_ms)\n\t\t\t VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,\n\t\t\t[\n\t\t\t\tentry.id,\n\t\t\t\tentry.timestamp.toISOString(),\n\t\t\t\tentry.provider,\n\t\t\t\tentry.model,\n\t\t\t\tentry.inputTokens,\n\t\t\t\tentry.outputTokens,\n\t\t\t\tentry.costUsd,\n\t\t\t\tentry.taskType,\n\t\t\t\tentry.latencyMs,\n\t\t\t],\n\t\t);\n\t}\n\n\tfunction record(params: {\n\t\tprovider: LLMProvider;\n\t\tmodel: string;\n\t\tusage: TokenUsage;\n\t\ttaskType: TaskType;\n\t\tlatencyMs: number;\n\t}): LLMUsageRecord {\n\t\tconst costUsd = getCostForModel(params.model, params.usage);\n\t\tidCounter++;\n\n\t\tconst entry: LLMUsageRecord = {\n\t\t\tid: `usage-${idCounter}`,\n\t\t\ttimestamp: clock(),\n\t\t\tprovider: params.provider,\n\t\t\tmodel: params.model,\n\t\t\tinputTokens: params.usage.inputTokens,\n\t\t\toutputTokens: params.usage.outputTokens,\n\t\t\tcostUsd,\n\t\t\ttaskType: params.taskType,\n\t\t\tlatencyMs: params.latencyMs,\n\t\t};\n\n\t\trecords.push(entry);\n\t\tpersist(entry);\n\n\t\tlogger.debug('LLM usage recorded', {\n\t\t\tmodel: params.model,\n\t\t\tinputTokens: params.usage.inputTokens,\n\t\t\toutputTokens: params.usage.outputTokens,\n\t\t\tcostUsd: costUsd.toFixed(6),\n\t\t\tlatencyMs: params.latencyMs,\n\t\t});\n\n\t\treturn entry;\n\t}\n\n\tfunction filterByDate(start: Date): LLMUsageRecord[] {\n\t\treturn records.filter((record) => record.timestamp >= start);\n\t}\n\n\tfunction getUsageToday(): LLMUsageRecord[] {\n\t\treturn filterByDate(startOfDay(clock()));\n\t}\n\n\tfunction getUsageThisWeek(): LLMUsageRecord[] {\n\t\treturn filterByDate(startOfWeek(clock()));\n\t}\n\n\tfunction getUsageThisMonth(): LLMUsageRecord[] {\n\t\treturn filterByDate(startOfMonth(clock()));\n\t}\n\n\tfunction summarize(entries: LLMUsageRecord[] = records): UsageSummary {\n\t\tconst byModel: UsageSummary['byModel'] = {};\n\t\tfor (const record of entries) {\n\t\t\tconst current = byModel[record.model] ?? {\n\t\t\t\tinputTokens: 0,\n\t\t\t\toutputTokens: 0,\n\t\t\t\tcostUsd: 0,\n\t\t\t};\n\t\t\tcurrent.inputTokens += record.inputTokens;\n\t\t\tcurrent.outputTokens += record.outputTokens;\n\t\t\tcurrent.costUsd += record.costUsd;\n\t\t\tbyModel[record.model] = current;\n\t\t}\n\n\t\tconst totals = sumTokens(entries);\n\t\treturn {\n\t\t\ttotalInputTokens: totals.input,\n\t\t\ttotalOutputTokens: totals.output,\n\t\t\ttotalCostUsd: sumCost(entries),\n\t\t\taverageCostPerDayUsd: estimateAverageCostPerDay(entries),\n\t\t\tbyModel,\n\t\t};\n\t}\n\n\tfunction clear(): void {\n\t\trecords.length = 0;\n\t\tidCounter = 0;\n\t\tif (options.store) {\n\t\t\toptions.store.run('DELETE FROM llm_usage');\n\t\t}\n\t}\n\n\treturn {\n\t\trecord,\n\t\tgetUsageToday,\n\t\tgetUsageThisWeek,\n\t\tgetUsageThisMonth,\n\t\tgetTotalCost: () => sumCost(records),\n\t\tgetCostToday: () => sumCost(getUsageToday()),\n\t\tgetCostThisMonth: () => sumCost(getUsageThisMonth()),\n\t\tgetRecords: () => [...records],\n\t\tsummarize,\n\t\tclear,\n\t};\n}\n\nexport type { CostTracker, CostTrackerOptions, UsageSummary };\n","import Anthropic from '@anthropic-ai/sdk';\nimport type {\n\tContentBlockParam,\n\tMessageParam,\n\tToolResultBlockParam,\n} from '@anthropic-ai/sdk/resources/messages';\nimport { createLogger } from '../../utils/logger.js';\nimport type { LLMProviderInterface, LLMRequest, LLMResponse, Message, ToolCall } from '../types.js';\n\nconst logger = createLogger('llm:claude');\n\ninterface ClaudeProviderConfig {\n\tapiKey: string;\n\tdefaultModel: string;\n}\n\nfunction convertMessages(messages: Message[]): MessageParam[] {\n\tconst result: MessageParam[] = [];\n\n\tfor (const msg of messages) {\n\t\tif (msg.role === 'system') continue; // System prompt handled separately\n\n\t\tif (msg.role === 'tool') {\n\t\t\t// Tool results go as user messages with tool_result content blocks\n\t\t\tconst toolResultBlock: ToolResultBlockParam = {\n\t\t\t\ttype: 'tool_result',\n\t\t\t\ttool_use_id: msg.toolResultId ?? '',\n\t\t\t\tcontent: msg.content,\n\t\t\t};\n\t\t\tresult.push({ role: 'user', content: [toolResultBlock] });\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (msg.role === 'assistant' && msg.toolCalls && msg.toolCalls.length > 0) {\n\t\t\t// Assistant message with tool calls\n\t\t\tconst content: ContentBlockParam[] = [];\n\t\t\tif (msg.content) {\n\t\t\t\tcontent.push({ type: 'text', text: msg.content });\n\t\t\t}\n\t\t\tfor (const tc of msg.toolCalls) {\n\t\t\t\tcontent.push({\n\t\t\t\t\ttype: 'tool_use',\n\t\t\t\t\tid: tc.id,\n\t\t\t\t\tname: tc.name,\n\t\t\t\t\tinput: tc.arguments,\n\t\t\t\t});\n\t\t\t}\n\t\t\tresult.push({ role: 'assistant', content });\n\t\t\tcontinue;\n\t\t}\n\n\t\tresult.push({\n\t\t\trole: msg.role as 'user' | 'assistant',\n\t\t\tcontent: msg.content,\n\t\t});\n\t}\n\n\treturn result;\n}\n\nfunction mapFinishReason(stopReason: string | null): LLMResponse['finishReason'] {\n\tswitch (stopReason) {\n\t\tcase 'end_turn':\n\t\t\treturn 'end';\n\t\tcase 'tool_use':\n\t\t\treturn 'tool_use';\n\t\tcase 'max_tokens':\n\t\t\treturn 'max_tokens';\n\t\tdefault:\n\t\t\treturn 'end';\n\t}\n}\n\n/**\n * Creates a Claude (Anthropic) LLM provider.\n */\nexport function createClaudeProvider(config: ClaudeProviderConfig): LLMProviderInterface {\n\tconst client = new Anthropic({ apiKey: config.apiKey });\n\n\tasync function complete(request: LLMRequest): Promise<LLMResponse> {\n\t\tconst model = request.model ?? config.defaultModel;\n\t\tconst messages = convertMessages(request.messages);\n\t\tconst startTime = Date.now();\n\n\t\tlogger.debug('Claude request', { model, messageCount: messages.length });\n\n\t\tconst params: Anthropic.MessageCreateParams = {\n\t\t\tmodel,\n\t\t\tmessages,\n\t\t\tmax_tokens: request.maxTokens ?? 4096,\n\t\t};\n\n\t\tif (request.systemPrompt) {\n\t\t\tparams.system = request.systemPrompt;\n\t\t}\n\n\t\tif (request.temperature !== undefined) {\n\t\t\tparams.temperature = request.temperature;\n\t\t}\n\n\t\tif (request.tools && request.tools.length > 0) {\n\t\t\tparams.tools = request.tools.map((tool) => ({\n\t\t\t\tname: tool.name,\n\t\t\t\tdescription: tool.description,\n\t\t\t\tinput_schema: tool.parameters as Anthropic.Tool.InputSchema,\n\t\t\t}));\n\t\t}\n\n\t\tconst response = await client.messages.create(params);\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\t// Extract content and tool calls\n\t\tlet textContent = '';\n\t\tconst toolCalls: ToolCall[] = [];\n\n\t\tfor (const block of response.content) {\n\t\t\tif (block.type === 'text') {\n\t\t\t\ttextContent += block.text;\n\t\t\t} else if (block.type === 'tool_use') {\n\t\t\t\ttoolCalls.push({\n\t\t\t\t\tid: block.id,\n\t\t\t\t\tname: block.name,\n\t\t\t\t\targuments: block.input as Record<string, unknown>,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tlogger.debug('Claude response', {\n\t\t\tmodel: response.model,\n\t\t\tlatencyMs,\n\t\t\tinputTokens: response.usage.input_tokens,\n\t\t\toutputTokens: response.usage.output_tokens,\n\t\t\tstopReason: response.stop_reason,\n\t\t});\n\n\t\treturn {\n\t\t\tcontent: textContent,\n\t\t\ttoolCalls,\n\t\t\tusage: {\n\t\t\t\tinputTokens: response.usage.input_tokens,\n\t\t\t\toutputTokens: response.usage.output_tokens,\n\t\t\t},\n\t\t\tmodel: response.model,\n\t\t\tprovider: 'claude',\n\t\t\tfinishReason: mapFinishReason(response.stop_reason),\n\t\t};\n\t}\n\n\tasync function isAvailable(): Promise<boolean> {\n\t\treturn config.apiKey.length > 0;\n\t}\n\n\treturn {\n\t\tname: 'claude',\n\t\tcomplete,\n\t\tisAvailable,\n\t};\n}\n","import { Ollama } from 'ollama';\nimport { createLogger } from '../../utils/logger.js';\nimport type { LLMProviderInterface, LLMRequest, LLMResponse, Message, ToolCall } from '../types.js';\n\nconst logger = createLogger('llm:ollama');\n\ninterface OllamaProviderConfig {\n\thost: string;\n\tapiKey?: string;\n\tdefaultModel: string;\n\tembeddingModel: string;\n}\n\nexport type OllamaProvider = LLMProviderInterface & {\n\tembed(text: string): Promise<number[]>;\n};\n\nfunction convertMessages(messages: Message[]): Array<{ role: string; content: string }> {\n\treturn messages\n\t\t.filter((msg) => msg.role !== 'system')\n\t\t.map((msg) => ({\n\t\t\trole: msg.role === 'tool' ? 'user' : msg.role,\n\t\t\tcontent:\n\t\t\t\tmsg.role === 'tool'\n\t\t\t\t\t? `[Tool Result (${msg.toolResultId ?? 'unknown'})]: ${msg.content}`\n\t\t\t\t\t: msg.content,\n\t\t}));\n}\n\n/**\n * Creates an Ollama (local LLM) provider with embedding support.\n */\nexport function createOllamaProvider(config: OllamaProviderConfig): OllamaProvider {\n\tconst headers = config.apiKey ? { Authorization: `Bearer ${config.apiKey}` } : undefined;\n\tconst client = new Ollama({ host: config.host, headers });\n\n\tasync function complete(request: LLMRequest): Promise<LLMResponse> {\n\t\tconst model = request.model ?? config.defaultModel;\n\t\tconst messages = convertMessages(request.messages);\n\t\tconst startTime = Date.now();\n\n\t\tlogger.debug('Ollama request', { model, messageCount: messages.length });\n\n\t\tconst ollamaMessages = messages.map((m) => ({\n\t\t\trole: m.role as 'user' | 'assistant' | 'system',\n\t\t\tcontent: m.content,\n\t\t}));\n\n\t\t// Add system prompt as first message if provided\n\t\tif (request.systemPrompt) {\n\t\t\tollamaMessages.unshift({ role: 'system', content: request.systemPrompt });\n\t\t}\n\n\t\tconst params: Parameters<typeof client.chat>[0] = {\n\t\t\tmodel,\n\t\t\tmessages: ollamaMessages,\n\t\t\toptions: {},\n\t\t};\n\n\t\tif (request.temperature !== undefined && params.options) {\n\t\t\tparams.options.temperature = request.temperature;\n\t\t}\n\n\t\tif (request.maxTokens && params.options) {\n\t\t\tparams.options.num_predict = request.maxTokens;\n\t\t}\n\n\t\t// Tool support for compatible models\n\t\tif (request.tools && request.tools.length > 0) {\n\t\t\tparams.tools = request.tools.map((tool) => ({\n\t\t\t\ttype: 'function' as const,\n\t\t\t\tfunction: {\n\t\t\t\t\tname: tool.name,\n\t\t\t\t\tdescription: tool.description,\n\t\t\t\t\t// ToolDefinition.parameters is already a JSON Schema object.\n\t\t\t\t\tparameters: tool.parameters as Record<string, unknown>,\n\t\t\t\t},\n\t\t\t}));\n\t\t}\n\n\t\tconst response = await client.chat(params);\n\t\tconst latencyMs = Date.now() - startTime;\n\n\t\t// Extract tool calls if present\n\t\tconst toolCalls: ToolCall[] = [];\n\t\tif (response.message.tool_calls) {\n\t\t\tfor (const tc of response.message.tool_calls) {\n\t\t\t\ttoolCalls.push({\n\t\t\t\t\tid: `ollama-${Date.now()}-${toolCalls.length}`,\n\t\t\t\t\tname: tc.function.name,\n\t\t\t\t\targuments: tc.function.arguments as Record<string, unknown>,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tconst inputTokens = response.prompt_eval_count ?? 0;\n\t\tconst outputTokens = response.eval_count ?? 0;\n\n\t\tlogger.debug('Ollama response', {\n\t\t\tmodel,\n\t\t\tlatencyMs,\n\t\t\tinputTokens,\n\t\t\toutputTokens,\n\t\t});\n\n\t\treturn {\n\t\t\tcontent: response.message.content,\n\t\t\ttoolCalls,\n\t\t\tusage: { inputTokens, outputTokens },\n\t\t\tmodel,\n\t\t\tprovider: 'ollama',\n\t\t\tfinishReason: toolCalls.length > 0 ? 'tool_use' : 'end',\n\t\t};\n\t}\n\n\tasync function isAvailable(): Promise<boolean> {\n\t\ttry {\n\t\t\tawait client.list();\n\t\t\treturn true;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tasync function embed(text: string): Promise<number[]> {\n\t\tconst response = await client.embed({\n\t\t\tmodel: config.embeddingModel,\n\t\t\tinput: text,\n\t\t});\n\t\treturn response.embeddings[0] ?? [];\n\t}\n\n\treturn {\n\t\tname: 'ollama',\n\t\tcomplete,\n\t\tisAvailable,\n\t\tembed,\n\t};\n}\n","import type { MamaConfig } from '../config/schema.js';\nimport type { MemoryStore } from '../memory/store.js';\nimport { createLogger } from '../utils/logger.js';\nimport { createCostTracker } from './cost-tracker.js';\nimport type {\n\tLLMProviderInterface,\n\tLLMRequest,\n\tLLMResponse,\n\tRoutingDecision,\n\tTaskType,\n} from './types.js';\n\nconst logger = createLogger('llm:router');\n\ninterface LLMRouter {\n\tcomplete(request: LLMRequest): Promise<LLMResponse>;\n\troute(taskType: TaskType): RoutingDecision;\n\tgetCostTracker(): ReturnType<typeof createCostTracker>;\n}\n\ninterface RouterDeps {\n\tconfig: MamaConfig;\n\tclaudeProvider?: LLMProviderInterface;\n\tollamaProvider?: LLMProviderInterface;\n\tusageStore?: MemoryStore;\n}\n\nfunction getModelForTask(\n\tconfig: MamaConfig,\n\tprovider: 'claude' | 'ollama',\n\ttaskType: TaskType,\n): string {\n\tif (provider === 'claude') {\n\t\treturn config.llm.providers.claude.defaultModel;\n\t}\n\n\tconst ollama = config.llm.providers.ollama;\n\tswitch (taskType) {\n\t\tcase 'complex_reasoning':\n\t\tcase 'code_generation':\n\t\tcase 'memory_consolidation':\n\t\t\treturn ollama.smartModel;\n\t\tcase 'simple_tasks':\n\t\tcase 'private_content':\n\t\t\treturn ollama.fastModel;\n\t\tcase 'embeddings':\n\t\t\treturn ollama.embeddingModel;\n\t\tdefault:\n\t\t\treturn ollama.defaultModel;\n\t}\n}\n\n/**\n * Creates an LLM router that intelligently selects providers based on task type.\n * Includes fallback logic and cost tracking.\n */\nexport function createLLMRouter(deps: RouterDeps): LLMRouter {\n\tconst { config } = deps;\n\tconst costTracker = createCostTracker({ store: deps.usageStore });\n\tconst providers = new Map<string, LLMProviderInterface>();\n\n\tif (deps.claudeProvider) providers.set('claude', deps.claudeProvider);\n\tif (deps.ollamaProvider) providers.set('ollama', deps.ollamaProvider);\n\n\tfunction route(taskType: TaskType): RoutingDecision {\n\t\tconst routing = config.llm.routing;\n\n\t\tconst routingMap: Record<TaskType, 'claude' | 'ollama'> = {\n\t\t\tcomplex_reasoning: routing.complexReasoning,\n\t\t\tcode_generation: routing.codeGeneration,\n\t\t\tsimple_tasks: routing.simpleTasks,\n\t\t\tembeddings: routing.embeddings,\n\t\t\tmemory_consolidation: routing.memoryConsolidation,\n\t\t\tprivate_content: routing.privateContent,\n\t\t\tgeneral: config.llm.defaultProvider,\n\t\t};\n\n\t\tconst provider = routingMap[taskType] ?? config.llm.defaultProvider;\n\t\tconst model = getModelForTask(config, provider, taskType);\n\n\t\treturn {\n\t\t\tprovider,\n\t\t\tmodel,\n\t\t\treason: `Task type \"${taskType}\" routed to ${provider}/${model}`,\n\t\t};\n\t}\n\n\tasync function complete(request: LLMRequest): Promise<LLMResponse> {\n\t\tconst taskType = request.taskType ?? 'general';\n\t\tconst decision = route(taskType);\n\t\tconst startTime = Date.now();\n\t\tlet primaryError: unknown;\n\n\t\t// Try primary provider\n\t\tconst primary = providers.get(decision.provider);\n\t\tif (primary) {\n\t\t\ttry {\n\t\t\t\tconst response = await primary.complete({\n\t\t\t\t\t...request,\n\t\t\t\t\tmodel: request.model ?? decision.model,\n\t\t\t\t});\n\n\t\t\t\tconst latencyMs = Date.now() - startTime;\n\t\t\t\tcostTracker.record({\n\t\t\t\t\tprovider: decision.provider,\n\t\t\t\t\tmodel: response.model,\n\t\t\t\t\tusage: response.usage,\n\t\t\t\t\ttaskType,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t});\n\n\t\t\t\tlogger.info('LLM request completed', {\n\t\t\t\t\tprovider: decision.provider,\n\t\t\t\t\tmodel: response.model,\n\t\t\t\t\ttaskType,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t\tinputTokens: response.usage.inputTokens,\n\t\t\t\t\toutputTokens: response.usage.outputTokens,\n\t\t\t\t});\n\n\t\t\t\treturn response;\n\t\t\t} catch (err) {\n\t\t\t\tprimaryError = err;\n\t\t\t\tlogger.warn('Primary provider failed, trying fallback', {\n\t\t\t\t\tprovider: decision.provider,\n\t\t\t\t\terror: err instanceof Error ? err.message : String(err),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\t// Fallback to the other provider\n\t\tconst fallbackName = decision.provider === 'claude' ? 'ollama' : 'claude';\n\t\tconst fallback = providers.get(fallbackName);\n\n\t\tif (fallback) {\n\t\t\tconst fallbackModel = getModelForTask(config, fallbackName, taskType);\n\n\t\t\ttry {\n\t\t\t\tconst response = await fallback.complete({\n\t\t\t\t\t...request,\n\t\t\t\t\tmodel: request.model ?? fallbackModel,\n\t\t\t\t});\n\n\t\t\t\tconst latencyMs = Date.now() - startTime;\n\t\t\t\tcostTracker.record({\n\t\t\t\t\tprovider: fallbackName,\n\t\t\t\t\tmodel: response.model,\n\t\t\t\t\tusage: response.usage,\n\t\t\t\t\ttaskType,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t});\n\n\t\t\t\tlogger.info('LLM request completed via fallback', {\n\t\t\t\t\tprovider: fallbackName,\n\t\t\t\t\tmodel: response.model,\n\t\t\t\t\ttaskType,\n\t\t\t\t\tlatencyMs,\n\t\t\t\t});\n\n\t\t\t\treturn response;\n\t\t\t} catch (err) {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`All LLM providers failed. Last error: ${err instanceof Error ? err.message : String(err)}`,\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tif (primaryError) {\n\t\t\tthrow new Error(\n\t\t\t\t`Primary provider \"${decision.provider}\" failed and no fallback provider is configured. Last error: ${\n\t\t\t\t\tprimaryError instanceof Error ? primaryError.message : String(primaryError)\n\t\t\t\t}`,\n\t\t\t);\n\t\t}\n\n\t\tthrow new Error('No LLM providers available');\n\t}\n\n\treturn {\n\t\tcomplete,\n\t\troute,\n\t\tgetCostTracker: () => costTracker,\n\t};\n}\n","import { v4 as uuidv4 } from 'uuid';\nimport { createLogger } from '../utils/logger.js';\nimport type { EmbeddingService } from './embeddings.js';\nimport type { MemoryStore } from './store.js';\n\nconst logger = createLogger('memory:consolidated');\n\nexport type MemoryCategory =\n\t| 'fact'\n\t| 'preference'\n\t| 'pattern'\n\t| 'goal'\n\t| 'relationship'\n\t| 'skill'\n\t| 'routine'\n\t| 'emotional'\n\t| 'project';\n\nexport interface ConsolidatedMemory {\n\tid: string;\n\tcreatedAt: Date;\n\tupdatedAt: Date;\n\tcategory: MemoryCategory;\n\tcontent: string;\n\tconfidence: number;\n\tsourceEpisodes: string[];\n\tembedding: Float32Array | null;\n\tactive: boolean;\n\treinforcementCount: number;\n\tlastReinforcedAt: Date | null;\n\tcontradictions: string[];\n}\n\nexport interface NewConsolidatedMemory {\n\tcategory: MemoryCategory;\n\tcontent: string;\n\tconfidence?: number;\n\tsourceEpisodes?: string[];\n\tactive?: boolean;\n\tcontradictions?: string[];\n}\n\nexport interface ConsolidatedSearchOptions {\n\ttopK?: number;\n\tminConfidence?: number;\n\tincludeInactive?: boolean;\n\tcategory?: MemoryCategory;\n}\n\nexport interface ConsolidatedMemoryStore {\n\tcreate(memory: NewConsolidatedMemory): Promise<string>;\n\tupdate(id: string, changes: Partial<ConsolidatedMemory>): Promise<void>;\n\treinforce(id: string): Promise<void>;\n\tdeactivate(id: string): Promise<void>;\n\treactivate(id: string): Promise<void>;\n\tsearch(query: string, options?: ConsolidatedSearchOptions): Promise<ConsolidatedMemory[]>;\n\tgetByCategory(category: MemoryCategory): Promise<ConsolidatedMemory[]>;\n\tgetActive(minConfidence?: number): Promise<ConsolidatedMemory[]>;\n}\n\ninterface ConsolidatedMemoryOptions {\n\tstore: MemoryStore;\n\tembeddings: EmbeddingService;\n\tdefaultTopK?: number;\n}\n\ninterface ConsolidatedMemoryRow {\n\tid: string;\n\tcreated_at: string;\n\tupdated_at: string;\n\tcategory: string;\n\tcontent: string;\n\tconfidence: number;\n\tsource_episodes: string | null;\n\tembedding: Uint8Array | null;\n\tactive: number | boolean;\n\treinforcement_count: number | null;\n\tlast_reinforced_at: string | null;\n\tcontradictions: string | null;\n}\n\ninterface SearchQueryPlan {\n\twhereClause: string;\n\tparams: Array<string | number>;\n}\n\ninterface NextMemoryState {\n\tcategory: MemoryCategory;\n\tcontent: string;\n\tconfidence: number;\n\tsourceEpisodes: string[];\n\tembedding: Float32Array | null;\n\tactive: boolean;\n\treinforcementCount: number;\n\tlastReinforcedAt: string | null;\n\tcontradictions: string[];\n}\n\nconst SELECT_MEMORIES = `SELECT id, created_at, updated_at, category, content, confidence, source_episodes, embedding, active,\n\t\t        reinforcement_count, last_reinforced_at, contradictions\n\t\t FROM memories`;\n\nfunction clampConfidence(value: number): number {\n\treturn Math.max(0, Math.min(1, value));\n}\n\nfunction parseJsonArray(value: string | null): string[] {\n\tif (!value) return [];\n\ttry {\n\t\tconst parsed = JSON.parse(value) as unknown;\n\t\tif (!Array.isArray(parsed)) return [];\n\t\treturn parsed.map((item) => String(item));\n\t} catch {\n\t\treturn [];\n\t}\n}\n\nfunction serializeEmbedding(embedding: Float32Array | null): Uint8Array | null {\n\tif (!embedding) return null;\n\treturn Buffer.from(embedding.buffer, embedding.byteOffset, embedding.byteLength);\n}\n\nfunction deserializeEmbedding(value: Uint8Array | null): Float32Array | null {\n\tif (!value || value.byteLength < 4) return null;\n\tconst bytes = new Uint8Array(value.byteLength);\n\tbytes.set(value);\n\treturn new Float32Array(bytes.buffer, 0, Math.floor(bytes.byteLength / 4));\n}\n\nfunction mapRowToMemory(row: ConsolidatedMemoryRow): ConsolidatedMemory {\n\treturn {\n\t\tid: row.id,\n\t\tcreatedAt: new Date(row.created_at),\n\t\tupdatedAt: new Date(row.updated_at),\n\t\tcategory: row.category as MemoryCategory,\n\t\tcontent: row.content,\n\t\tconfidence: row.confidence,\n\t\tsourceEpisodes: parseJsonArray(row.source_episodes),\n\t\tembedding: deserializeEmbedding(row.embedding),\n\t\tactive: Boolean(row.active),\n\t\treinforcementCount: row.reinforcement_count ?? 0,\n\t\tlastReinforcedAt: row.last_reinforced_at ? new Date(row.last_reinforced_at) : null,\n\t\tcontradictions: parseJsonArray(row.contradictions),\n\t};\n}\n\nfunction lexicalScore(content: string, queryTokens: string[]): number {\n\tif (queryTokens.length === 0) return 0;\n\tconst normalized = content.toLowerCase();\n\tlet hits = 0;\n\tfor (const token of queryTokens) {\n\t\tif (normalized.includes(token)) hits++;\n\t}\n\treturn hits / queryTokens.length;\n}\n\nfunction cosineSimilarity(a: Float32Array | null, b: Float32Array): number {\n\tif (!a || a.length === 0 || b.length === 0) return 0;\n\tconst dimensions = Math.min(a.length, b.length);\n\tif (dimensions === 0) return 0;\n\n\tlet dot = 0;\n\tlet normA = 0;\n\tlet normB = 0;\n\n\tfor (let i = 0; i < dimensions; i++) {\n\t\tconst av = a[i] ?? 0;\n\t\tconst bv = b[i] ?? 0;\n\t\tdot += av * bv;\n\t\tnormA += av * av;\n\t\tnormB += bv * bv;\n\t}\n\n\tif (normA === 0 || normB === 0) return 0;\n\treturn dot / (Math.sqrt(normA) * Math.sqrt(normB));\n}\n\nfunction tokenizeQuery(query: string): string[] {\n\treturn query.toLowerCase().match(/[a-z0-9]{3,}/g) ?? [];\n}\n\nfunction buildSearchQuery(options: ConsolidatedSearchOptions): SearchQueryPlan {\n\tconst params: Array<string | number> = [];\n\tconst filters: string[] = [];\n\n\tif (!options.includeInactive) {\n\t\tfilters.push('active = 1');\n\t}\n\tif (options.minConfidence !== undefined) {\n\t\tfilters.push('confidence >= ?');\n\t\tparams.push(clampConfidence(options.minConfidence));\n\t}\n\tif (options.category) {\n\t\tfilters.push('category = ?');\n\t\tparams.push(options.category);\n\t}\n\n\treturn {\n\t\twhereClause: filters.length > 0 ? `WHERE ${filters.join(' AND ')}` : '',\n\t\tparams,\n\t};\n}\n\nexport function createConsolidatedMemoryStore(\n\toptions: ConsolidatedMemoryOptions,\n): ConsolidatedMemoryStore {\n\tconst topKDefault = options.defaultTopK ?? 10;\n\n\tfunction getById(id: string): ConsolidatedMemory | null {\n\t\tconst row = options.store.get<ConsolidatedMemoryRow>(\n\t\t\t`${SELECT_MEMORIES}\n\t\t\t WHERE id = ?`,\n\t\t\t[id],\n\t\t);\n\t\treturn row ? mapRowToMemory(row) : null;\n\t}\n\n\tfunction requireMemory(id: string): ConsolidatedMemory {\n\t\tconst memory = getById(id);\n\t\tif (!memory) {\n\t\t\tthrow new Error(`Memory not found: ${id}`);\n\t\t}\n\t\treturn memory;\n\t}\n\n\tasync function resolveEmbedding(content: string): Promise<Float32Array | null> {\n\t\ttry {\n\t\t\treturn await options.embeddings.embed(content);\n\t\t} catch (error) {\n\t\t\tlogger.warn('Failed to generate consolidated embedding', {\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t});\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tasync function resolveUpdatedEmbedding(\n\t\tcurrent: ConsolidatedMemory,\n\t\tchanges: Partial<ConsolidatedMemory>,\n\t): Promise<Float32Array | null> {\n\t\tif (!changes.content || changes.content === current.content) {\n\t\t\treturn current.embedding;\n\t\t}\n\t\treturn options.embeddings.embed(changes.content);\n\t}\n\n\tfunction buildNextState(\n\t\tcurrent: ConsolidatedMemory,\n\t\tchanges: Partial<ConsolidatedMemory>,\n\t\tembedding: Float32Array | null,\n\t): NextMemoryState {\n\t\treturn {\n\t\t\tcategory: changes.category ?? current.category,\n\t\t\tcontent: changes.content ?? current.content,\n\t\t\tconfidence: clampConfidence(changes.confidence ?? current.confidence),\n\t\t\tsourceEpisodes: changes.sourceEpisodes ?? current.sourceEpisodes,\n\t\t\tembedding,\n\t\t\tactive: changes.active ?? current.active,\n\t\t\treinforcementCount: changes.reinforcementCount ?? current.reinforcementCount,\n\t\t\tlastReinforcedAt: changes.lastReinforcedAt\n\t\t\t\t? changes.lastReinforcedAt.toISOString()\n\t\t\t\t: (current.lastReinforcedAt?.toISOString() ?? null),\n\t\t\tcontradictions: changes.contradictions ?? current.contradictions,\n\t\t};\n\t}\n\n\tasync function resolveQueryEmbedding(query: string): Promise<Float32Array | null> {\n\t\ttry {\n\t\t\treturn await options.embeddings.embed(query);\n\t\t} catch (error) {\n\t\t\tlogger.warn('Failed to generate query embedding for consolidated search', {\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t});\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tfunction rankSearchResults(\n\t\tmemories: ConsolidatedMemory[],\n\t\tqueryEmbedding: Float32Array | null,\n\t\tqueryTokens: string[],\n\t\ttopK: number,\n\t): ConsolidatedMemory[] {\n\t\treturn memories\n\t\t\t.map((memory) => {\n\t\t\t\tconst semantic = queryEmbedding ? cosineSimilarity(memory.embedding, queryEmbedding) : 0;\n\t\t\t\tconst lexical = lexicalScore(memory.content, queryTokens);\n\t\t\t\tconst confidenceBoost = memory.confidence * 0.05;\n\t\t\t\tconst score = semantic * 0.75 + lexical * 0.25 + confidenceBoost;\n\t\t\t\treturn { memory, score };\n\t\t\t})\n\t\t\t.sort((a, b) => b.score - a.score)\n\t\t\t.slice(0, topK)\n\t\t\t.map((item) => item.memory);\n\t}\n\n\tasync function create(memory: NewConsolidatedMemory): Promise<string> {\n\t\tconst id = uuidv4();\n\t\tconst now = new Date().toISOString();\n\t\tconst confidence = clampConfidence(memory.confidence ?? 1);\n\t\tconst embedding = await resolveEmbedding(memory.content);\n\n\t\toptions.store.run(\n\t\t\t`INSERT INTO memories (\n\t\t\t\tid, created_at, updated_at, category, content, confidence, source_episodes,\n\t\t\t\tembedding, active, reinforcement_count, last_reinforced_at, contradictions\n\t\t\t) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,\n\t\t\t[\n\t\t\t\tid,\n\t\t\t\tnow,\n\t\t\t\tnow,\n\t\t\t\tmemory.category,\n\t\t\t\tmemory.content,\n\t\t\t\tconfidence,\n\t\t\t\tJSON.stringify(memory.sourceEpisodes ?? []),\n\t\t\t\tserializeEmbedding(embedding),\n\t\t\t\t(memory.active ?? true) ? 1 : 0,\n\t\t\t\t1,\n\t\t\t\tnow,\n\t\t\t\tJSON.stringify(memory.contradictions ?? []),\n\t\t\t],\n\t\t);\n\n\t\treturn id;\n\t}\n\n\tasync function update(id: string, changes: Partial<ConsolidatedMemory>): Promise<void> {\n\t\tconst current = requireMemory(id);\n\n\t\tconst now = new Date().toISOString();\n\t\tconst nextEmbedding = await resolveUpdatedEmbedding(current, changes);\n\t\tconst next = buildNextState(current, changes, nextEmbedding);\n\n\t\toptions.store.run(\n\t\t\t`UPDATE memories\n\t\t\t SET updated_at = ?,\n\t\t\t     category = ?,\n\t\t\t     content = ?,\n\t\t\t     confidence = ?,\n\t\t\t     source_episodes = ?,\n\t\t\t     embedding = ?,\n\t\t\t     active = ?,\n\t\t\t     reinforcement_count = ?,\n\t\t\t     last_reinforced_at = ?,\n\t\t\t     contradictions = ?\n\t\t\t WHERE id = ?`,\n\t\t\t[\n\t\t\t\tnow,\n\t\t\t\tnext.category,\n\t\t\t\tnext.content,\n\t\t\t\tnext.confidence,\n\t\t\t\tJSON.stringify(next.sourceEpisodes),\n\t\t\t\tserializeEmbedding(next.embedding),\n\t\t\t\tnext.active ? 1 : 0,\n\t\t\t\tnext.reinforcementCount,\n\t\t\t\tnext.lastReinforcedAt,\n\t\t\t\tJSON.stringify(next.contradictions),\n\t\t\t\tid,\n\t\t\t],\n\t\t);\n\t}\n\n\tasync function reinforce(id: string): Promise<void> {\n\t\trequireMemory(id);\n\n\t\tconst now = new Date().toISOString();\n\t\toptions.store.run(\n\t\t\t`UPDATE memories\n\t\t\t SET reinforcement_count = COALESCE(reinforcement_count, 0) + 1,\n\t\t\t     last_reinforced_at = ?,\n\t\t\t     updated_at = ?,\n\t\t\t     confidence = MIN(confidence + 0.05, 1.0)\n\t\t\t WHERE id = ?`,\n\t\t\t[now, now, id],\n\t\t);\n\t}\n\n\tasync function deactivate(id: string): Promise<void> {\n\t\trequireMemory(id);\n\n\t\toptions.store.run(`UPDATE memories SET active = 0, updated_at = ? WHERE id = ?`, [\n\t\t\tnew Date().toISOString(),\n\t\t\tid,\n\t\t]);\n\t}\n\n\tasync function reactivate(id: string): Promise<void> {\n\t\trequireMemory(id);\n\n\t\toptions.store.run(`UPDATE memories SET active = 1, updated_at = ? WHERE id = ?`, [\n\t\t\tnew Date().toISOString(),\n\t\t\tid,\n\t\t]);\n\t}\n\n\tasync function search(\n\t\tquery: string,\n\t\tsearchOptions: ConsolidatedSearchOptions = {},\n\t): Promise<ConsolidatedMemory[]> {\n\t\tconst topK = searchOptions.topK ?? topKDefault;\n\t\tconst queryTokens = tokenizeQuery(query);\n\t\tconst sqlQuery = buildSearchQuery(searchOptions);\n\t\tconst rows = options.store.all<ConsolidatedMemoryRow>(\n\t\t\t`${SELECT_MEMORIES}\n\t\t\t ${sqlQuery.whereClause}\n\t\t\t ORDER BY updated_at DESC\n\t\t\t LIMIT 2000`,\n\t\t\tsqlQuery.params,\n\t\t);\n\t\tconst memories = rows.map(mapRowToMemory);\n\n\t\tif (query.trim().length === 0) {\n\t\t\treturn memories.slice(0, topK);\n\t\t}\n\n\t\tconst queryEmbedding = await resolveQueryEmbedding(query);\n\t\treturn rankSearchResults(memories, queryEmbedding, queryTokens, topK);\n\t}\n\n\tasync function getByCategory(category: MemoryCategory): Promise<ConsolidatedMemory[]> {\n\t\tconst rows = options.store.all<ConsolidatedMemoryRow>(\n\t\t\t`${SELECT_MEMORIES}\n\t\t\t WHERE category = ? AND active = 1\n\t\t\t ORDER BY confidence DESC, updated_at DESC`,\n\t\t\t[category],\n\t\t);\n\t\treturn rows.map(mapRowToMemory);\n\t}\n\n\tasync function getActive(minConfidence = 0): Promise<ConsolidatedMemory[]> {\n\t\tconst rows = options.store.all<ConsolidatedMemoryRow>(\n\t\t\t`${SELECT_MEMORIES}\n\t\t\t WHERE active = 1 AND confidence >= ?\n\t\t\t ORDER BY confidence DESC, updated_at DESC`,\n\t\t\t[clampConfidence(minConfidence)],\n\t\t);\n\t\treturn rows.map(mapRowToMemory);\n\t}\n\n\treturn {\n\t\tcreate,\n\t\tupdate,\n\t\treinforce,\n\t\tdeactivate,\n\t\treactivate,\n\t\tsearch,\n\t\tgetByCategory,\n\t\tgetActive,\n\t};\n}\n","import { v4 as uuidv4 } from 'uuid';\nimport { z } from 'zod';\nimport type { createLLMRouter } from '../llm/router.js';\nimport type { Message } from '../llm/types.js';\nimport { createLogger } from '../utils/logger.js';\nimport type { ConsolidatedMemoryStore, MemoryCategory } from './consolidated.js';\nimport type { DecayReport } from './decay.js';\nimport type { EmbeddingService } from './embeddings.js';\nimport type { Episode, EpisodicMemory } from './episodic.js';\nimport type { createSoul } from './soul.js';\nimport type { MemoryStore } from './store.js';\n\nconst logger = createLogger('memory:consolidation');\n\nconst CATEGORY_VALUES: [MemoryCategory, ...MemoryCategory[]] = [\n\t'fact',\n\t'preference',\n\t'pattern',\n\t'goal',\n\t'relationship',\n\t'skill',\n\t'routine',\n\t'emotional',\n\t'project',\n];\n\nconst MemoryCategorySchema = z.enum(CATEGORY_VALUES);\n\nconst ConsolidationLLMResultSchema = z\n\t.object({\n\t\tnew: z\n\t\t\t.array(\n\t\t\t\tz.object({\n\t\t\t\t\tcategory: MemoryCategorySchema,\n\t\t\t\t\tcontent: z.string().min(1),\n\t\t\t\t\tconfidence: z.number().min(0).max(1).optional(),\n\t\t\t\t\tsourceEpisodes: z.array(z.string()).optional(),\n\t\t\t\t}),\n\t\t\t)\n\t\t\t.default([]),\n\t\treinforce: z\n\t\t\t.array(\n\t\t\t\tz.object({\n\t\t\t\t\tmemoryId: z.string().min(1),\n\t\t\t\t\treason: z.string().optional(),\n\t\t\t\t}),\n\t\t\t)\n\t\t\t.default([]),\n\t\tupdate: z\n\t\t\t.array(\n\t\t\t\tz.object({\n\t\t\t\t\tmemoryId: z.string().min(1),\n\t\t\t\t\tnewContent: z.string().min(1),\n\t\t\t\t\treason: z.string().optional(),\n\t\t\t\t}),\n\t\t\t)\n\t\t\t.default([]),\n\t\tcontradict: z\n\t\t\t.array(\n\t\t\t\tz.object({\n\t\t\t\t\tmemoryId: z.string().min(1),\n\t\t\t\t\tcontradictedBy: z.string().min(1),\n\t\t\t\t\tresolution: z.string().optional(),\n\t\t\t\t}),\n\t\t\t)\n\t\t\t.default([]),\n\t\tdecay: z\n\t\t\t.array(\n\t\t\t\tz.object({\n\t\t\t\t\tmemoryId: z.string().min(1),\n\t\t\t\t\tnewConfidence: z.number().min(0).max(1),\n\t\t\t\t}),\n\t\t\t)\n\t\t\t.default([]),\n\t\tconnect: z\n\t\t\t.array(\n\t\t\t\tz.object({\n\t\t\t\t\tmemoryA: z.string().min(1),\n\t\t\t\t\tmemoryB: z.string().min(1),\n\t\t\t\t\trelationship: z.string().min(1),\n\t\t\t\t}),\n\t\t\t)\n\t\t\t.default([]),\n\t})\n\t.strict();\n\nexport type ConsolidationLLMResult = z.infer<typeof ConsolidationLLMResultSchema>;\n\nexport interface ConsolidationReport {\n\tstartedAt: string;\n\tfinishedAt: string;\n\tskipped: boolean;\n\tskipReason?: string;\n\tpendingEpisodes: number;\n\tprocessedEpisodes: number;\n\tcreated: number;\n\treinforced: number;\n\tupdated: number;\n\tcontradicted: number;\n\tdecayed: number;\n\tdeactivated: number;\n\tconnected: number;\n\terrors: string[];\n\tdecayReport?: DecayReport;\n}\n\nexport interface ConsolidationRunOptions {\n\tforce?: boolean;\n\tminEpisodesToConsolidate?: number;\n\trunDecay?: boolean;\n\tregenerateSoul?: boolean;\n}\n\ninterface ConsolidationEngineOptions {\n\trouter: ReturnType<typeof createLLMRouter>;\n\tstore: MemoryStore;\n\tepisodic: EpisodicMemory;\n\tconsolidated: ConsolidatedMemoryStore;\n\tembeddings: EmbeddingService;\n\tsoul?: ReturnType<typeof createSoul>;\n\tdecay?: { runDecay(): Promise<DecayReport> };\n\tbatchSize?: number;\n\tminEpisodesToConsolidate?: number;\n\tdeactivateThreshold?: number;\n}\n\nexport interface ConsolidationEngine {\n\trunConsolidation(options?: ConsolidationRunOptions): Promise<ConsolidationReport>;\n\tgetPendingEpisodeCount(): number;\n}\n\ninterface ConsolidationSchedulerOptions {\n\tengine: ConsolidationEngine;\n\tintervalHours: number;\n\tminEpisodesToConsolidate: number;\n\tisIdle?: () => boolean;\n\tonReport?: (report: ConsolidationReport) => void;\n}\n\ninterface ConsolidationScheduler {\n\tstart(): void;\n\tstop(): void;\n\trunOnce(): Promise<ConsolidationReport>;\n\tisRunning(): boolean;\n}\n\ninterface EpisodeRow {\n\tid: string;\n\ttimestamp: string;\n\tchannel: string;\n\trole: string;\n\tcontent: string;\n\tmetadata: string | null;\n\tconsolidated: number | boolean;\n}\n\ninterface MemoryRow {\n\tid: string;\n\tcategory: MemoryCategory;\n\tcontent: string;\n\tconfidence: number;\n\tsource_episodes: string | null;\n\treinforcement_count: number | null;\n\tlast_reinforced_at: string | null;\n\tcontradictions: string | null;\n\tactive: number | boolean;\n}\n\ninterface PreparedNewMemory {\n\tid: string;\n\tcategory: MemoryCategory;\n\tcontent: string;\n\tconfidence: number;\n\tsourceEpisodes: string[];\n\tembedding: Float32Array | null;\n}\n\ninterface PreparedUpdate {\n\tmemoryId: string;\n\tnewContent: string;\n\tembedding: Float32Array | null;\n}\n\nconst EMPTY_RESULT: ConsolidationLLMResult = {\n\tnew: [],\n\treinforce: [],\n\tupdate: [],\n\tcontradict: [],\n\tdecay: [],\n\tconnect: [],\n};\n\ntype ReinforceAction = ConsolidationLLMResult['reinforce'][number];\ntype ContradictAction = ConsolidationLLMResult['contradict'][number];\ntype DecayAction = ConsolidationLLMResult['decay'][number];\n\nfunction clampConfidence(value: number): number {\n\treturn Math.max(0, Math.min(1, value));\n}\n\nfunction parseJsonArray(value: string | null): string[] {\n\tif (!value) return [];\n\ttry {\n\t\tconst parsed = JSON.parse(value) as unknown;\n\t\tif (!Array.isArray(parsed)) return [];\n\t\treturn parsed.map((item) => String(item));\n\t} catch {\n\t\treturn [];\n\t}\n}\n\nfunction serializeEmbedding(embedding: Float32Array | null): Uint8Array | null {\n\tif (!embedding) return null;\n\treturn Buffer.from(embedding.buffer, embedding.byteOffset, embedding.byteLength);\n}\n\nfunction insertPreparedNewMemories(\n\tstore: MemoryStore,\n\titems: PreparedNewMemory[],\n\tnowIso: string,\n): void {\n\tfor (const item of items) {\n\t\tstore.run(\n\t\t\t`INSERT INTO memories (\n\t\t\t\tid, created_at, updated_at, category, content, confidence, source_episodes, embedding,\n\t\t\t\tactive, reinforcement_count, last_reinforced_at, contradictions\n\t\t\t) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,\n\t\t\t[\n\t\t\t\titem.id,\n\t\t\t\tnowIso,\n\t\t\t\tnowIso,\n\t\t\t\titem.category,\n\t\t\t\titem.content,\n\t\t\t\titem.confidence,\n\t\t\t\tJSON.stringify(item.sourceEpisodes),\n\t\t\t\tserializeEmbedding(item.embedding),\n\t\t\t\t1,\n\t\t\t\t1,\n\t\t\t\tnowIso,\n\t\t\t\tJSON.stringify([]),\n\t\t\t],\n\t\t);\n\t}\n}\n\nfunction applyReinforcements(store: MemoryStore, items: ReinforceAction[], nowIso: string): void {\n\tfor (const item of items) {\n\t\tstore.run(\n\t\t\t`UPDATE memories\n\t\t\t SET reinforcement_count = COALESCE(reinforcement_count, 0) + 1,\n\t\t\t     confidence = MIN(confidence + 0.05, 1.0),\n\t\t\t     last_reinforced_at = ?,\n\t\t\t     updated_at = ?\n\t\t\t WHERE id = ?`,\n\t\t\t[nowIso, nowIso, item.memoryId],\n\t\t);\n\t}\n}\n\nfunction applyPreparedUpdates(store: MemoryStore, items: PreparedUpdate[], nowIso: string): void {\n\tfor (const item of items) {\n\t\tstore.run(\n\t\t\t`UPDATE memories\n\t\t\t SET content = ?,\n\t\t\t     embedding = ?,\n\t\t\t     updated_at = ?\n\t\t\t WHERE id = ?`,\n\t\t\t[item.newContent, serializeEmbedding(item.embedding), nowIso, item.memoryId],\n\t\t);\n\t}\n}\n\nfunction applyContradictions(\n\tstore: MemoryStore,\n\titems: ContradictAction[],\n\tnowIso: string,\n\terrors: string[],\n): void {\n\tfor (const item of items) {\n\t\tconst row = store.get<MemoryRow>(\n\t\t\t`SELECT id, category, content, confidence, source_episodes, reinforcement_count,\n\t\t\t        last_reinforced_at, contradictions, active\n\t\t\t FROM memories\n\t\t\t WHERE id = ?`,\n\t\t\t[item.memoryId],\n\t\t);\n\n\t\tif (!row) {\n\t\t\terrors.push(`Missing memory for contradiction: ${item.memoryId}`);\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst contradictions = parseJsonArray(row.contradictions);\n\t\tif (!contradictions.includes(item.contradictedBy)) {\n\t\t\tcontradictions.push(item.contradictedBy);\n\t\t}\n\t\tconst loweredConfidence = Math.max(0.1, row.confidence - 0.2);\n\n\t\tstore.run(\n\t\t\t`UPDATE memories\n\t\t\t SET contradictions = ?, confidence = ?, updated_at = ?\n\t\t\t WHERE id = ?`,\n\t\t\t[JSON.stringify(contradictions), loweredConfidence, nowIso, item.memoryId],\n\t\t);\n\t}\n}\n\nfunction applyDecayActions(\n\tstore: MemoryStore,\n\titems: DecayAction[],\n\tnowIso: string,\n\tdeactivateThreshold: number,\n): number {\n\tlet deactivated = 0;\n\n\tfor (const item of items) {\n\t\tconst confidence = clampConfidence(item.newConfidence);\n\t\tstore.run(\n\t\t\t`UPDATE memories\n\t\t\t SET confidence = ?, updated_at = ?\n\t\t\t WHERE id = ?`,\n\t\t\t[confidence, nowIso, item.memoryId],\n\t\t);\n\n\t\tif (confidence < deactivateThreshold) {\n\t\t\tstore.run(\n\t\t\t\t`UPDATE memories\n\t\t\t\t SET active = 0, updated_at = ?\n\t\t\t\t WHERE id = ?`,\n\t\t\t\t[nowIso, item.memoryId],\n\t\t\t);\n\t\t\tdeactivated++;\n\t\t}\n\t}\n\n\treturn deactivated;\n}\n\nfunction markEpisodesConsolidated(store: MemoryStore, episodes: Episode[]): void {\n\tif (episodes.length === 0) return;\n\tconst placeholders = episodes.map(() => '?').join(', ');\n\tstore.run(\n\t\t`UPDATE episodes\n\t\t SET consolidated = 1\n\t\t WHERE id IN (${placeholders})`,\n\t\tepisodes.map((episode) => episode.id),\n\t);\n}\n\nfunction parseEpisodeRow(row: EpisodeRow): Episode {\n\tconst metadata = row.metadata ? (JSON.parse(row.metadata) as Record<string, unknown>) : {};\n\treturn {\n\t\tid: row.id,\n\t\ttimestamp: new Date(row.timestamp),\n\t\tchannel: row.channel,\n\t\trole: row.role,\n\t\tcontent: row.content,\n\t\tembedding: null,\n\t\tmetadata,\n\t\tconsolidated: Boolean(row.consolidated),\n\t};\n}\n\nfunction extractJsonBlock(text: string): string | null {\n\tconst fenced = text.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/i);\n\tif (fenced?.[1]) {\n\t\treturn fenced[1].trim();\n\t}\n\n\tconst firstBrace = text.indexOf('{');\n\tconst lastBrace = text.lastIndexOf('}');\n\tif (firstBrace >= 0 && lastBrace > firstBrace) {\n\t\treturn text.slice(firstBrace, lastBrace + 1).trim();\n\t}\n\n\treturn null;\n}\n\nexport function parseConsolidationResponse(text: string): ConsolidationLLMResult {\n\tconst block = extractJsonBlock(text);\n\tif (!block) {\n\t\treturn EMPTY_RESULT;\n\t}\n\n\ttry {\n\t\tconst raw = JSON.parse(block) as unknown;\n\t\treturn ConsolidationLLMResultSchema.parse(raw);\n\t} catch {\n\t\treturn EMPTY_RESULT;\n\t}\n}\n\nfunction promptMemoryView(memory: MemoryRow): Record<string, unknown> {\n\treturn {\n\t\tid: memory.id,\n\t\tcategory: memory.category,\n\t\tcontent: memory.content,\n\t\tconfidence: memory.confidence,\n\t\tsourceEpisodes: parseJsonArray(memory.source_episodes),\n\t\treinforcementCount: memory.reinforcement_count ?? 0,\n\t\tlastReinforcedAt: memory.last_reinforced_at,\n\t\tcontradictions: parseJsonArray(memory.contradictions),\n\t};\n}\n\nfunction promptEpisodeView(episode: Episode): Record<string, unknown> {\n\treturn {\n\t\tid: episode.id,\n\t\ttimestamp: episode.timestamp.toISOString(),\n\t\tchannel: episode.channel,\n\t\trole: episode.role,\n\t\tcontent: episode.content,\n\t\tmetadata: episode.metadata,\n\t};\n}\n\nexport function buildConsolidationPrompt(params: {\n\texistingMemories: MemoryRow[];\n\tepisodes: Episode[];\n}): string {\n\tconst existing = params.existingMemories.map(promptMemoryView);\n\tconst episodes = params.episodes.map(promptEpisodeView);\n\n\treturn [\n\t\t'You are the memory consolidation system for Mama.',\n\t\t'Analyze the new episodes and return strict JSON only.',\n\t\t'Prefer updating/reinforcing existing memories instead of duplicates.',\n\t\t'Categories allowed: fact, preference, pattern, goal, relationship, skill, routine, emotional, project.',\n\t\t'',\n\t\t'Output schema:',\n\t\t'{',\n\t\t'  \"new\": [{ \"category\": \"...\", \"content\": \"...\", \"confidence\": 0-1, \"sourceEpisodes\": [\"...\"] }],',\n\t\t'  \"reinforce\": [{ \"memoryId\": \"...\", \"reason\": \"...\" }],',\n\t\t'  \"update\": [{ \"memoryId\": \"...\", \"newContent\": \"...\", \"reason\": \"...\" }],',\n\t\t'  \"contradict\": [{ \"memoryId\": \"...\", \"contradictedBy\": \"...\", \"resolution\": \"...\" }],',\n\t\t'  \"decay\": [{ \"memoryId\": \"...\", \"newConfidence\": 0-1 }],',\n\t\t'  \"connect\": [{ \"memoryA\": \"...\", \"memoryB\": \"...\", \"relationship\": \"...\" }]',\n\t\t'}',\n\t\t'',\n\t\t`Current consolidated memories (${existing.length}):`,\n\t\tJSON.stringify(existing, null, 2),\n\t\t'',\n\t\t`New episodes (${episodes.length}):`,\n\t\tJSON.stringify(episodes, null, 2),\n\t].join('\\n');\n}\n\nexport function createConsolidationEngine(\n\toptions: ConsolidationEngineOptions,\n): ConsolidationEngine {\n\tconst batchSize = options.batchSize ?? 100;\n\tconst minEpisodesDefault = options.minEpisodesToConsolidate ?? 10;\n\tconst deactivateThreshold = options.deactivateThreshold ?? 0.1;\n\n\tfunction getPendingEpisodeCount(): number {\n\t\tconst row = options.store.get<{ count: number }>(\n\t\t\t'SELECT COUNT(*) AS count FROM episodes WHERE consolidated = 0',\n\t\t);\n\t\treturn row?.count ?? 0;\n\t}\n\n\tfunction loadPendingEpisodes(limit: number): Episode[] {\n\t\tconst rows = options.store.all<EpisodeRow>(\n\t\t\t`SELECT id, timestamp, channel, role, content, metadata, consolidated\n\t\t\t FROM episodes\n\t\t\t WHERE consolidated = 0\n\t\t\t ORDER BY timestamp ASC\n\t\t\t LIMIT ?`,\n\t\t\t[limit],\n\t\t);\n\t\treturn rows.map(parseEpisodeRow);\n\t}\n\n\tfunction loadExistingMemories(): MemoryRow[] {\n\t\treturn options.store.all<MemoryRow>(\n\t\t\t`SELECT id, category, content, confidence, source_episodes, reinforcement_count,\n\t\t\t        last_reinforced_at, contradictions, active\n\t\t\t FROM memories\n\t\t\t WHERE active = 1\n\t\t\t ORDER BY confidence DESC, updated_at DESC\n\t\t\t LIMIT 300`,\n\t\t);\n\t}\n\n\tasync function embedOrNull(text: string): Promise<Float32Array | null> {\n\t\ttry {\n\t\t\treturn await options.embeddings.embed(text);\n\t\t} catch (error) {\n\t\t\tlogger.warn('Failed to embed consolidation content', {\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t});\n\t\t\treturn null;\n\t\t}\n\t}\n\n\tasync function prepareNewMemories(\n\t\titems: ConsolidationLLMResult['new'],\n\t): Promise<PreparedNewMemory[]> {\n\t\tconst prepared: PreparedNewMemory[] = [];\n\t\tfor (const item of items) {\n\t\t\tprepared.push({\n\t\t\t\tid: uuidv4(),\n\t\t\t\tcategory: item.category,\n\t\t\t\tcontent: item.content,\n\t\t\t\tconfidence: clampConfidence(item.confidence ?? 0.75),\n\t\t\t\tsourceEpisodes: item.sourceEpisodes ?? [],\n\t\t\t\tembedding: await embedOrNull(item.content),\n\t\t\t});\n\t\t}\n\t\treturn prepared;\n\t}\n\n\tasync function prepareUpdates(\n\t\titems: ConsolidationLLMResult['update'],\n\t): Promise<PreparedUpdate[]> {\n\t\tconst prepared: PreparedUpdate[] = [];\n\t\tfor (const item of items) {\n\t\t\tprepared.push({\n\t\t\t\tmemoryId: item.memoryId,\n\t\t\t\tnewContent: item.newContent,\n\t\t\t\tembedding: await embedOrNull(item.newContent),\n\t\t\t});\n\t\t}\n\t\treturn prepared;\n\t}\n\n\tasync function runConsolidation(\n\t\trunOptions: ConsolidationRunOptions = {},\n\t): Promise<ConsolidationReport> {\n\t\tconst startedAt = new Date();\n\t\tconst pendingCount = getPendingEpisodeCount();\n\t\tconst threshold = runOptions.minEpisodesToConsolidate ?? minEpisodesDefault;\n\t\tif (!runOptions.force && pendingCount < threshold) {\n\t\t\treturn {\n\t\t\t\tstartedAt: startedAt.toISOString(),\n\t\t\t\tfinishedAt: new Date().toISOString(),\n\t\t\t\tskipped: true,\n\t\t\t\tskipReason: `Only ${pendingCount} pending episodes (min ${threshold})`,\n\t\t\t\tpendingEpisodes: pendingCount,\n\t\t\t\tprocessedEpisodes: 0,\n\t\t\t\tcreated: 0,\n\t\t\t\treinforced: 0,\n\t\t\t\tupdated: 0,\n\t\t\t\tcontradicted: 0,\n\t\t\t\tdecayed: 0,\n\t\t\t\tdeactivated: 0,\n\t\t\t\tconnected: 0,\n\t\t\t\terrors: [],\n\t\t\t};\n\t\t}\n\n\t\tconst episodes = loadPendingEpisodes(batchSize);\n\t\tif (episodes.length === 0) {\n\t\t\treturn {\n\t\t\t\tstartedAt: startedAt.toISOString(),\n\t\t\t\tfinishedAt: new Date().toISOString(),\n\t\t\t\tskipped: true,\n\t\t\t\tskipReason: 'No unconsolidated episodes',\n\t\t\t\tpendingEpisodes: pendingCount,\n\t\t\t\tprocessedEpisodes: 0,\n\t\t\t\tcreated: 0,\n\t\t\t\treinforced: 0,\n\t\t\t\tupdated: 0,\n\t\t\t\tcontradicted: 0,\n\t\t\t\tdecayed: 0,\n\t\t\t\tdeactivated: 0,\n\t\t\t\tconnected: 0,\n\t\t\t\terrors: [],\n\t\t\t};\n\t\t}\n\n\t\tconst existingMemories = loadExistingMemories();\n\t\tconst prompt = buildConsolidationPrompt({ existingMemories, episodes });\n\t\tconst request: Message = { role: 'user', content: prompt };\n\t\tconst response = await options.router.complete({\n\t\t\tmessages: [request],\n\t\t\ttaskType: 'memory_consolidation',\n\t\t\ttemperature: 0.1,\n\t\t\tmaxTokens: 4096,\n\t\t});\n\t\tconst parsed = parseConsolidationResponse(response.content);\n\t\tconst preparedNew = await prepareNewMemories(parsed.new);\n\t\tconst preparedUpdate = await prepareUpdates(parsed.update);\n\t\tconst errors: string[] = [];\n\t\tlet deactivated = 0;\n\t\tconst nowIso = new Date().toISOString();\n\n\t\toptions.store.transaction(() => {\n\t\t\tinsertPreparedNewMemories(options.store, preparedNew, nowIso);\n\t\t\tapplyReinforcements(options.store, parsed.reinforce, nowIso);\n\t\t\tapplyPreparedUpdates(options.store, preparedUpdate, nowIso);\n\t\t\tapplyContradictions(options.store, parsed.contradict, nowIso, errors);\n\t\t\tdeactivated = applyDecayActions(options.store, parsed.decay, nowIso, deactivateThreshold);\n\t\t\tmarkEpisodesConsolidated(options.store, episodes);\n\t\t});\n\n\t\tlet decayReport: DecayReport | undefined;\n\t\tif (runOptions.runDecay !== false && options.decay) {\n\t\t\tdecayReport = await options.decay.runDecay();\n\t\t}\n\n\t\tif (runOptions.regenerateSoul !== false && options.soul) {\n\t\t\tconst memories = await options.consolidated.getActive(0);\n\t\t\toptions.soul.regenerateFromMemories(memories);\n\t\t}\n\n\t\tconst report: ConsolidationReport = {\n\t\t\tstartedAt: startedAt.toISOString(),\n\t\t\tfinishedAt: new Date().toISOString(),\n\t\t\tskipped: false,\n\t\t\tpendingEpisodes: pendingCount,\n\t\t\tprocessedEpisodes: episodes.length,\n\t\t\tcreated: preparedNew.length,\n\t\t\treinforced: parsed.reinforce.length,\n\t\t\tupdated: preparedUpdate.length,\n\t\t\tcontradicted: parsed.contradict.length,\n\t\t\tdecayed: parsed.decay.length,\n\t\t\tdeactivated,\n\t\t\tconnected: parsed.connect.length,\n\t\t\terrors,\n\t\t\tdecayReport,\n\t\t};\n\n\t\tlogger.info('Consolidation run finished', { ...report });\n\t\treturn report;\n\t}\n\n\treturn {\n\t\trunConsolidation,\n\t\tgetPendingEpisodeCount,\n\t};\n}\n\nexport function createConsolidationScheduler(\n\toptions: ConsolidationSchedulerOptions,\n): ConsolidationScheduler {\n\tconst intervalMs = Math.max(60_000, options.intervalHours * 60 * 60 * 1000);\n\tlet timer: NodeJS.Timeout | null = null;\n\tlet running = false;\n\n\tasync function tick(): Promise<ConsolidationReport> {\n\t\tif (running) {\n\t\t\treturn {\n\t\t\t\tstartedAt: new Date().toISOString(),\n\t\t\t\tfinishedAt: new Date().toISOString(),\n\t\t\t\tskipped: true,\n\t\t\t\tskipReason: 'Consolidation already running',\n\t\t\t\tpendingEpisodes: options.engine.getPendingEpisodeCount(),\n\t\t\t\tprocessedEpisodes: 0,\n\t\t\t\tcreated: 0,\n\t\t\t\treinforced: 0,\n\t\t\t\tupdated: 0,\n\t\t\t\tcontradicted: 0,\n\t\t\t\tdecayed: 0,\n\t\t\t\tdeactivated: 0,\n\t\t\t\tconnected: 0,\n\t\t\t\terrors: [],\n\t\t\t};\n\t\t}\n\n\t\tif (options.isIdle && !options.isIdle()) {\n\t\t\treturn {\n\t\t\t\tstartedAt: new Date().toISOString(),\n\t\t\t\tfinishedAt: new Date().toISOString(),\n\t\t\t\tskipped: true,\n\t\t\t\tskipReason: 'Agent is active',\n\t\t\t\tpendingEpisodes: options.engine.getPendingEpisodeCount(),\n\t\t\t\tprocessedEpisodes: 0,\n\t\t\t\tcreated: 0,\n\t\t\t\treinforced: 0,\n\t\t\t\tupdated: 0,\n\t\t\t\tcontradicted: 0,\n\t\t\t\tdecayed: 0,\n\t\t\t\tdeactivated: 0,\n\t\t\t\tconnected: 0,\n\t\t\t\terrors: [],\n\t\t\t};\n\t\t}\n\n\t\trunning = true;\n\t\ttry {\n\t\t\tconst report = await options.engine.runConsolidation({\n\t\t\t\tminEpisodesToConsolidate: options.minEpisodesToConsolidate,\n\t\t\t});\n\t\t\toptions.onReport?.(report);\n\t\t\treturn report;\n\t\t} finally {\n\t\t\trunning = false;\n\t\t}\n\t}\n\n\tfunction start(): void {\n\t\tif (timer) return;\n\t\ttimer = setInterval(() => {\n\t\t\tvoid tick();\n\t\t}, intervalMs);\n\t}\n\n\tfunction stop(): void {\n\t\tif (timer) {\n\t\t\tclearInterval(timer);\n\t\t\ttimer = null;\n\t\t}\n\t}\n\n\treturn {\n\t\tstart,\n\t\tstop,\n\t\trunOnce: tick,\n\t\tisRunning: () => running,\n\t};\n}\n","import { createLogger } from '../utils/logger.js';\nimport type { ConsolidatedMemoryStore } from './consolidated.js';\nimport type { MemoryStore } from './store.js';\n\nconst logger = createLogger('memory:decay');\n\nexport interface DecayReport {\n\tchecked: number;\n\tdecayed: number;\n\tdeactivated: number;\n}\n\nexport interface DecayOptions {\n\tstore: MemoryStore;\n\tconsolidated: ConsolidatedMemoryStore;\n\tinactiveDaysThreshold?: number;\n\tdecayFactor?: number;\n\tdeactivateThreshold?: number;\n\tnow?: Date;\n}\n\ninterface DecayCandidate {\n\tid: string;\n\tcreated_at: string;\n\tlast_reinforced_at: string | null;\n\tconfidence: number;\n}\n\nfunction clampConfidence(value: number): number {\n\treturn Math.max(0, Math.min(1, value));\n}\n\nfunction daysBetween(older: Date, newer: Date): number {\n\treturn Math.max(0, (newer.getTime() - older.getTime()) / (24 * 60 * 60 * 1000));\n}\n\n/**\n * Creates a decay runner for consolidated memories.\n */\nexport function createDecayEngine(options: DecayOptions) {\n\tconst inactiveDaysThreshold = options.inactiveDaysThreshold ?? 30;\n\tconst decayFactor = options.decayFactor ?? 0.9;\n\tconst deactivateThreshold = options.deactivateThreshold ?? 0.1;\n\n\tasync function runDecay(): Promise<DecayReport> {\n\t\tconst now = options.now ?? new Date();\n\t\tconst candidates = options.store.all<DecayCandidate>(\n\t\t\t`SELECT id, created_at, last_reinforced_at, confidence\n\t\t\t FROM memories\n\t\t\t WHERE active = 1`,\n\t\t);\n\n\t\tlet decayed = 0;\n\t\tlet deactivated = 0;\n\n\t\tfor (const candidate of candidates) {\n\t\t\tconst reference = candidate.last_reinforced_at\n\t\t\t\t? new Date(candidate.last_reinforced_at)\n\t\t\t\t: new Date(candidate.created_at);\n\t\t\tconst ageDays = daysBetween(reference, now);\n\n\t\t\tif (ageDays < inactiveDaysThreshold) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst newConfidence = clampConfidence(candidate.confidence * decayFactor);\n\t\t\tif (newConfidence !== candidate.confidence) {\n\t\t\t\tawait options.consolidated.update(candidate.id, { confidence: newConfidence });\n\t\t\t\tdecayed++;\n\t\t\t}\n\n\t\t\tif (newConfidence < deactivateThreshold) {\n\t\t\t\tawait options.consolidated.deactivate(candidate.id);\n\t\t\t\tdeactivated++;\n\t\t\t}\n\t\t}\n\n\t\tlogger.info('Decay run completed', {\n\t\t\tchecked: candidates.length,\n\t\t\tdecayed,\n\t\t\tdeactivated,\n\t\t});\n\n\t\treturn {\n\t\t\tchecked: candidates.length,\n\t\t\tdecayed,\n\t\t\tdeactivated,\n\t\t};\n\t}\n\n\treturn {\n\t\trunDecay,\n\t};\n}\n","import { createLogger } from '../utils/logger.js';\n\nconst logger = createLogger('memory:embeddings');\n\nexport interface EmbeddingService {\n\tembed(text: string): Promise<Float32Array>;\n\tembedBatch(texts: string[]): Promise<Float32Array[]>;\n\tclearCache(): void;\n\tgetCacheSize(): number;\n}\n\ninterface EmbeddingServiceOptions {\n\tembedder: (text: string) => Promise<number[] | Float32Array>;\n}\n\nfunction normalizeEmbedding(value: number[] | Float32Array): Float32Array {\n\treturn value instanceof Float32Array ? value : Float32Array.from(value);\n}\n\n/**\n * Creates an embedding helper with memoization for repeated strings.\n */\nexport function createEmbeddingService(options: EmbeddingServiceOptions): EmbeddingService {\n\tconst cache = new Map<string, Float32Array>();\n\n\tasync function embed(text: string): Promise<Float32Array> {\n\t\tconst key = text.trim();\n\t\tif (cache.has(key)) {\n\t\t\tconst cached = cache.get(key);\n\t\t\tif (cached) {\n\t\t\t\treturn cached;\n\t\t\t}\n\t\t}\n\n\t\tconst value = await options.embedder(key);\n\t\tconst embedding = normalizeEmbedding(value);\n\t\tcache.set(key, embedding);\n\n\t\tlogger.debug('Embedding generated', {\n\t\t\ttextLength: key.length,\n\t\t\tdimensions: embedding.length,\n\t\t\tcacheSize: cache.size,\n\t\t});\n\n\t\treturn embedding;\n\t}\n\n\tasync function embedBatch(texts: string[]): Promise<Float32Array[]> {\n\t\tconst unique = [...new Set(texts.map((item) => item.trim()))];\n\t\tawait Promise.all(unique.map((text) => embed(text)));\n\t\treturn texts.map((text) => {\n\t\t\tconst cached = cache.get(text.trim());\n\t\t\tif (!cached) {\n\t\t\t\tthrow new Error('Embedding cache inconsistency');\n\t\t\t}\n\t\t\treturn cached;\n\t\t});\n\t}\n\n\tfunction clearCache(): void {\n\t\tcache.clear();\n\t}\n\n\tfunction getCacheSize(): number {\n\t\treturn cache.size;\n\t}\n\n\treturn {\n\t\tembed,\n\t\tembedBatch,\n\t\tclearCache,\n\t\tgetCacheSize,\n\t};\n}\n","import type { SQLInputValue } from 'node:sqlite';\nimport { v4 as uuidv4 } from 'uuid';\nimport { createLogger } from '../utils/logger.js';\nimport type { EmbeddingService } from './embeddings.js';\nimport type { MemoryStore } from './store.js';\n\nconst logger = createLogger('memory:episodic');\n\nconst STOPWORDS = new Set([\n\t'the',\n\t'this',\n\t'that',\n\t'with',\n\t'from',\n\t'have',\n\t'what',\n\t'when',\n\t'where',\n\t'which',\n\t'while',\n\t'about',\n\t'there',\n\t'their',\n\t'your',\n\t'you',\n\t'and',\n\t'for',\n\t'into',\n\t'just',\n\t'than',\n\t'then',\n\t'were',\n\t'will',\n\t'would',\n\t'could',\n\t'should',\n\t'been',\n\t'they',\n\t'them',\n\t'also',\n\t'please',\n]);\n\nexport type EpisodeRole = 'system' | 'user' | 'assistant' | 'tool';\nexport type Importance = 'low' | 'medium' | 'high';\nexport type EmotionalTone = 'neutral' | 'positive' | 'negative';\n\nexport interface EpisodeMetadata {\n\ttopics?: string[];\n\tentities?: string[];\n\timportance?: Importance;\n\temotionalTone?: EmotionalTone;\n\t[key: string]: unknown;\n}\n\nexport interface Episode {\n\tid: string;\n\ttimestamp: Date;\n\tchannel: string;\n\trole: string;\n\tcontent: string;\n\tembedding: Float32Array | null;\n\tmetadata: EpisodeMetadata;\n\tconsolidated: boolean;\n}\n\nexport interface NewEpisode {\n\ttimestamp?: Date;\n\tchannel: string;\n\trole: EpisodeRole | string;\n\tcontent: string;\n\tmetadata?: EpisodeMetadata;\n\tconsolidated?: boolean;\n}\n\nexport interface SearchOptions {\n\ttopK?: number;\n\tstart?: Date;\n\tend?: Date;\n\tchannel?: string;\n\trole?: string;\n}\n\nexport interface HybridOptions extends SearchOptions {\n\tsemanticWeight?: number;\n\ttemporalWeight?: number;\n\ttopicWeight?: number;\n}\n\nexport interface EpisodicMemory {\n\tstoreEpisode(episode: NewEpisode): Promise<string>;\n\tsearchSemantic(query: string, options?: SearchOptions): Promise<Episode[]>;\n\tsearchTemporal(start: Date, end: Date): Promise<Episode[]>;\n\tsearchHybrid(query: string, options?: HybridOptions): Promise<Episode[]>;\n\tgetRecent(limit: number): Promise<Episode[]>;\n\tmarkConsolidated(ids: string[]): Promise<void>;\n}\n\ninterface EpisodicMemoryOptions {\n\tstore: MemoryStore;\n\tembeddings: EmbeddingService;\n\tdefaultTopK?: number;\n}\n\ninterface EpisodeRow {\n\tid: string;\n\ttimestamp: string;\n\tchannel: string;\n\trole: string;\n\tcontent: string;\n\tembedding: Uint8Array | null;\n\tmetadata: string | null;\n\tconsolidated: number | boolean;\n}\n\nfunction serializeEmbedding(embedding: Float32Array | null): Uint8Array | null {\n\tif (!embedding) return null;\n\treturn Buffer.from(embedding.buffer, embedding.byteOffset, embedding.byteLength);\n}\n\nfunction deserializeEmbedding(value: Uint8Array | null): Float32Array | null {\n\tif (!value || value.byteLength < 4) return null;\n\tconst bytes = new Uint8Array(value.byteLength);\n\tbytes.set(value);\n\tconst dimensions = Math.floor(bytes.byteLength / 4);\n\treturn new Float32Array(bytes.buffer, 0, dimensions);\n}\n\nfunction parseMetadata(value: string | null): EpisodeMetadata {\n\tif (!value) return {};\n\ttry {\n\t\treturn JSON.parse(value) as EpisodeMetadata;\n\t} catch {\n\t\treturn {};\n\t}\n}\n\nfunction mapRowToEpisode(row: EpisodeRow): Episode {\n\treturn {\n\t\tid: row.id,\n\t\ttimestamp: new Date(row.timestamp),\n\t\tchannel: row.channel,\n\t\trole: row.role,\n\t\tcontent: row.content,\n\t\tembedding: deserializeEmbedding(row.embedding),\n\t\tmetadata: parseMetadata(row.metadata),\n\t\tconsolidated: Boolean(row.consolidated),\n\t};\n}\n\nfunction normalizeTopicToken(token: string): string {\n\treturn token.toLowerCase();\n}\n\nfunction extractTopics(content: string): string[] {\n\tconst tokens = content\n\t\t.toLowerCase()\n\t\t.match(/[a-z0-9]{4,}/g)\n\t\t?.map((token) => token.trim())\n\t\t.filter((token) => token.length >= 4 && !STOPWORDS.has(token))\n\t\t.map((token) => normalizeTopicToken(token));\n\tif (!tokens) return [];\n\n\tconst frequencies = new Map<string, number>();\n\tfor (const token of tokens) {\n\t\tfrequencies.set(token, (frequencies.get(token) ?? 0) + 1);\n\t}\n\n\treturn [...frequencies.entries()]\n\t\t.sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]))\n\t\t.slice(0, 6)\n\t\t.map(([token]) => token);\n}\n\nfunction extractEntities(content: string): string[] {\n\tconst entities = content.match(/\\b[A-Z][a-zA-Z0-9_-]{2,}\\b/g) ?? [];\n\treturn [...new Set(entities)].slice(0, 8);\n}\n\nfunction detectImportance(content: string): Importance {\n\tconst normalized = content.toLowerCase();\n\tif (\n\t\tnormalized.includes('urgent') ||\n\t\tnormalized.includes('critical') ||\n\t\tnormalized.includes('security') ||\n\t\tnormalized.includes('incident')\n\t) {\n\t\treturn 'high';\n\t}\n\tif (content.length > 280) {\n\t\treturn 'high';\n\t}\n\tif (content.length > 120) {\n\t\treturn 'medium';\n\t}\n\treturn 'low';\n}\n\nfunction detectEmotionalTone(content: string): EmotionalTone {\n\tconst normalized = content.toLowerCase();\n\tconst positive = ['great', 'thanks', 'good', 'awesome', 'love', 'nice', 'perfect'];\n\tconst negative = ['error', 'fail', 'broken', 'angry', 'upset', 'problem', 'issue'];\n\n\tif (positive.some((token) => normalized.includes(token))) return 'positive';\n\tif (negative.some((token) => normalized.includes(token))) return 'negative';\n\treturn 'neutral';\n}\n\nfunction enrichMetadata(content: string, metadata: EpisodeMetadata | undefined): EpisodeMetadata {\n\tconst providedTopics = Array.isArray(metadata?.topics)\n\t\t? metadata.topics.map((topic) => normalizeTopicToken(String(topic)))\n\t\t: [];\n\tconst providedEntities = Array.isArray(metadata?.entities)\n\t\t? metadata.entities.map((entity) => String(entity))\n\t\t: [];\n\n\tconst topics = [...new Set([...providedTopics, ...extractTopics(content)])].slice(0, 10);\n\tconst entities = [...new Set([...providedEntities, ...extractEntities(content)])].slice(0, 10);\n\n\treturn {\n\t\t...metadata,\n\t\ttopics,\n\t\tentities,\n\t\timportance: metadata?.importance ?? detectImportance(content),\n\t\temotionalTone: metadata?.emotionalTone ?? detectEmotionalTone(content),\n\t};\n}\n\nfunction cosineSimilarity(a: Float32Array | null, b: Float32Array): number {\n\tif (!a || a.length === 0 || b.length === 0) return 0;\n\tconst dimensions = Math.min(a.length, b.length);\n\tif (dimensions === 0) return 0;\n\n\tlet dot = 0;\n\tlet normA = 0;\n\tlet normB = 0;\n\n\tfor (let i = 0; i < dimensions; i++) {\n\t\tconst av = a[i] ?? 0;\n\t\tconst bv = b[i] ?? 0;\n\t\tdot += av * bv;\n\t\tnormA += av * av;\n\t\tnormB += bv * bv;\n\t}\n\n\tif (normA === 0 || normB === 0) return 0;\n\treturn dot / (Math.sqrt(normA) * Math.sqrt(normB));\n}\n\nfunction buildQueryFilters(options: SearchOptions): {\n\twhereClause: string;\n\tparams: SQLInputValue[];\n} {\n\tconst filters: string[] = [];\n\tconst params: SQLInputValue[] = [];\n\n\tif (options.start) {\n\t\tfilters.push('timestamp >= ?');\n\t\tparams.push(options.start.toISOString());\n\t}\n\tif (options.end) {\n\t\tfilters.push('timestamp <= ?');\n\t\tparams.push(options.end.toISOString());\n\t}\n\tif (options.channel) {\n\t\tfilters.push('channel = ?');\n\t\tparams.push(options.channel);\n\t}\n\tif (options.role) {\n\t\tfilters.push('role = ?');\n\t\tparams.push(options.role);\n\t}\n\n\treturn {\n\t\twhereClause: filters.length > 0 ? `WHERE ${filters.join(' AND ')}` : '',\n\t\tparams,\n\t};\n}\n\nfunction queryTokens(query: string): string[] {\n\treturn (\n\t\tquery\n\t\t\t.toLowerCase()\n\t\t\t.match(/[a-z0-9]{3,}/g)\n\t\t\t?.filter((token) => !STOPWORDS.has(token))\n\t\t\t.slice(0, 8) ?? []\n\t);\n}\n\nexport function createEpisodicMemory(options: EpisodicMemoryOptions): EpisodicMemory {\n\tconst topKDefault = options.defaultTopK ?? 10;\n\n\tfunction getCandidates(searchOptions: SearchOptions = {}): Episode[] {\n\t\tconst filters = buildQueryFilters(searchOptions);\n\t\tconst rows = options.store.all<EpisodeRow>(\n\t\t\t`SELECT id, timestamp, channel, role, content, embedding, metadata, consolidated\n\t\t\t FROM episodes\n\t\t\t ${filters.whereClause}\n\t\t\t ORDER BY timestamp DESC\n\t\t\t LIMIT 3000`,\n\t\t\tfilters.params,\n\t\t);\n\n\t\treturn rows.map(mapRowToEpisode);\n\t}\n\n\tasync function storeEpisode(episode: NewEpisode): Promise<string> {\n\t\tconst id = uuidv4();\n\t\tconst timestamp = (episode.timestamp ?? new Date()).toISOString();\n\t\tconst metadata = enrichMetadata(episode.content, episode.metadata);\n\n\t\tlet embedding: Float32Array | null = null;\n\t\ttry {\n\t\t\tembedding = await options.embeddings.embed(episode.content);\n\t\t} catch (error) {\n\t\t\tlogger.warn('Failed to generate embedding for episode', {\n\t\t\t\tid,\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t});\n\t\t}\n\n\t\toptions.store.run(\n\t\t\t`INSERT INTO episodes (id, timestamp, channel, role, content, embedding, metadata, consolidated)\n\t\t\t VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,\n\t\t\t[\n\t\t\t\tid,\n\t\t\t\ttimestamp,\n\t\t\t\tepisode.channel,\n\t\t\t\tepisode.role,\n\t\t\t\tepisode.content,\n\t\t\t\tserializeEmbedding(embedding),\n\t\t\t\tJSON.stringify(metadata),\n\t\t\t\tepisode.consolidated ? 1 : 0,\n\t\t\t],\n\t\t);\n\n\t\treturn id;\n\t}\n\n\tasync function searchSemantic(\n\t\tquery: string,\n\t\tsearchOptions: SearchOptions = {},\n\t): Promise<Episode[]> {\n\t\tconst queryEmbedding = await options.embeddings.embed(query);\n\t\tconst topK = searchOptions.topK ?? topKDefault;\n\t\tconst candidates = getCandidates(searchOptions);\n\n\t\treturn candidates\n\t\t\t.map((episode) => ({\n\t\t\t\tepisode,\n\t\t\t\tscore: cosineSimilarity(episode.embedding, queryEmbedding),\n\t\t\t}))\n\t\t\t.sort((a, b) => b.score - a.score)\n\t\t\t.slice(0, topK)\n\t\t\t.map((item) => item.episode);\n\t}\n\n\tasync function searchTemporal(start: Date, end: Date): Promise<Episode[]> {\n\t\tconst rows = options.store.all<EpisodeRow>(\n\t\t\t`SELECT id, timestamp, channel, role, content, embedding, metadata, consolidated\n\t\t\t FROM episodes\n\t\t\t WHERE timestamp >= ? AND timestamp <= ?\n\t\t\t ORDER BY timestamp DESC`,\n\t\t\t[start.toISOString(), end.toISOString()],\n\t\t);\n\n\t\treturn rows.map(mapRowToEpisode);\n\t}\n\n\tasync function searchHybrid(\n\t\tquery: string,\n\t\thybridOptions: HybridOptions = {},\n\t): Promise<Episode[]> {\n\t\tconst queryEmbedding = await options.embeddings.embed(query);\n\t\tconst nowMs = Date.now();\n\t\tconst topicTokens = queryTokens(query);\n\t\tconst topK = hybridOptions.topK ?? topKDefault;\n\t\tconst semanticWeight = hybridOptions.semanticWeight ?? 0.65;\n\t\tconst temporalWeight = hybridOptions.temporalWeight ?? 0.25;\n\t\tconst topicWeight = hybridOptions.topicWeight ?? 0.1;\n\t\tconst candidates = getCandidates(hybridOptions);\n\n\t\treturn candidates\n\t\t\t.map((episode) => {\n\t\t\t\tconst semanticScore = cosineSimilarity(episode.embedding, queryEmbedding);\n\t\t\t\tconst ageDays = Math.max(0, (nowMs - episode.timestamp.getTime()) / (24 * 60 * 60 * 1000));\n\t\t\t\tconst temporalScore = 1 / (1 + ageDays);\n\t\t\t\tconst topics = episode.metadata.topics ?? [];\n\t\t\t\tconst topicHits = topicTokens.filter((token) => topics.includes(token)).length;\n\t\t\t\tconst topicScore = topicTokens.length > 0 ? topicHits / topicTokens.length : 0;\n\t\t\t\tconst score =\n\t\t\t\t\tsemanticWeight * semanticScore +\n\t\t\t\t\ttemporalWeight * temporalScore +\n\t\t\t\t\ttopicWeight * topicScore;\n\t\t\t\treturn {\n\t\t\t\t\tepisode,\n\t\t\t\t\tscore,\n\t\t\t\t};\n\t\t\t})\n\t\t\t.sort((a, b) => b.score - a.score)\n\t\t\t.slice(0, topK)\n\t\t\t.map((item) => item.episode);\n\t}\n\n\tasync function getRecent(limit: number): Promise<Episode[]> {\n\t\tconst rows = options.store.all<EpisodeRow>(\n\t\t\t`SELECT id, timestamp, channel, role, content, embedding, metadata, consolidated\n\t\t\t FROM episodes\n\t\t\t ORDER BY timestamp DESC\n\t\t\t LIMIT ?`,\n\t\t\t[Math.max(1, limit)],\n\t\t);\n\t\treturn rows.map(mapRowToEpisode);\n\t}\n\n\tasync function markConsolidated(ids: string[]): Promise<void> {\n\t\tif (ids.length === 0) return;\n\t\tconst placeholders = ids.map(() => '?').join(', ');\n\t\toptions.store.run(`UPDATE episodes SET consolidated = 1 WHERE id IN (${placeholders})`, ids);\n\t}\n\n\treturn {\n\t\tstoreEpisode,\n\t\tsearchSemantic,\n\t\tsearchTemporal,\n\t\tsearchHybrid,\n\t\tgetRecent,\n\t\tmarkConsolidated,\n\t};\n}\n","import type { Message } from '../llm/types.js';\nimport { createLogger } from '../utils/logger.js';\n\nconst logger = createLogger('memory:working');\n\n/** Simple token estimation: ~4 chars per token (rough approximation) */\nfunction estimateTokens(text: string): number {\n\treturn Math.ceil(text.length / 4);\n}\n\nfunction estimateMessageTokens(msg: Message): number {\n\tlet tokens = estimateTokens(msg.content);\n\ttokens += 4; // Role overhead\n\tif (msg.toolCalls) {\n\t\tfor (const tc of msg.toolCalls) {\n\t\t\ttokens += estimateTokens(JSON.stringify(tc));\n\t\t}\n\t}\n\treturn tokens;\n}\n\ninterface WorkingMemoryOptions {\n\tmaxTokens: number;\n\tcompressThreshold?: number; // Percentage (0-1) of maxTokens to trigger compression\n}\n\ninterface WorkingMemory {\n\taddMessage(msg: Message): void;\n\tgetMessages(): Message[];\n\tgetTokenCount(): number;\n\tcompress(summarizer: (messages: Message[]) => Promise<string>): Promise<void>;\n\tsetSystemInjection(entries: string[]): void;\n\tclear(): void;\n\tgetSystemInjection(): string[];\n}\n\n/**\n * Manages the conversation context window for LLM requests.\n * Handles token counting and progressive summarization.\n */\nexport function createWorkingMemory(options: WorkingMemoryOptions): WorkingMemory {\n\tconst maxTokens = options.maxTokens;\n\tconst compressThreshold = options.compressThreshold ?? 0.75;\n\tconst messages: Message[] = [];\n\tconst memoryInjections: string[] = []; // Injected from episodic/consolidated memory\n\tlet totalTokens = 0;\n\n\tfunction addMessage(msg: Message): void {\n\t\tconst tokens = estimateMessageTokens(msg);\n\t\tmessages.push(msg);\n\t\ttotalTokens += tokens;\n\n\t\tlogger.debug('Message added to working memory', {\n\t\t\trole: msg.role,\n\t\t\ttokens,\n\t\t\ttotalTokens,\n\t\t\tmessageCount: messages.length,\n\t\t});\n\t}\n\n\tfunction getMessages(): Message[] {\n\t\treturn [...messages];\n\t}\n\n\tfunction getTokenCount(): number {\n\t\treturn totalTokens;\n\t}\n\n\tasync function compress(summarizer: (messages: Message[]) => Promise<string>): Promise<void> {\n\t\tif (totalTokens < maxTokens * compressThreshold) return;\n\n\t\t// Keep the last few messages intact, compress older ones\n\t\tconst keepCount = Math.min(4, messages.length);\n\t\tconst toCompress = messages.slice(0, messages.length - keepCount);\n\t\tconst toKeep = messages.slice(messages.length - keepCount);\n\n\t\tif (toCompress.length === 0) return;\n\n\t\tlogger.info('Compressing working memory', {\n\t\t\tcompressing: toCompress.length,\n\t\t\tkeeping: toKeep.length,\n\t\t});\n\n\t\tconst summary = await summarizer(toCompress);\n\n\t\t// Replace with summary message + kept messages\n\t\tmessages.length = 0;\n\t\tmessages.push({\n\t\t\trole: 'system',\n\t\t\tcontent: `[Previous conversation summary]: ${summary}`,\n\t\t});\n\t\tmessages.push(...toKeep);\n\n\t\t// Recalculate tokens\n\t\ttotalTokens = messages.reduce((sum, msg) => sum + estimateMessageTokens(msg), 0);\n\n\t\tlogger.info('Working memory compressed', {\n\t\t\tnewTokenCount: totalTokens,\n\t\t\tmessageCount: messages.length,\n\t\t});\n\t}\n\n\tfunction clear(): void {\n\t\tmessages.length = 0;\n\t\tmemoryInjections.length = 0;\n\t\ttotalTokens = 0;\n\t}\n\n\tfunction setSystemInjection(entries: string[]): void {\n\t\tmemoryInjections.length = 0;\n\t\tfor (const entry of entries) {\n\t\t\tconst trimmed = entry.trim();\n\t\t\tif (trimmed.length > 0) {\n\t\t\t\tmemoryInjections.push(trimmed);\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction getSystemInjection(): string[] {\n\t\treturn [...memoryInjections];\n\t}\n\n\treturn {\n\t\taddMessage,\n\t\tgetMessages,\n\t\tgetTokenCount,\n\t\tcompress,\n\t\tsetSystemInjection,\n\t\tclear,\n\t\tgetSystemInjection,\n\t};\n}\n\nexport { estimateTokens };\n","import { createLogger } from '../utils/logger.js';\nimport type { ConsolidatedMemory, ConsolidatedMemoryStore } from './consolidated.js';\nimport type { Episode, EpisodicMemory } from './episodic.js';\nimport type { MemoryStore } from './store.js';\nimport { estimateTokens } from './working.js';\n\nconst logger = createLogger('memory:retrieval');\n\nconst STOPWORDS = new Set([\n\t'the',\n\t'this',\n\t'that',\n\t'with',\n\t'from',\n\t'have',\n\t'what',\n\t'when',\n\t'where',\n\t'which',\n\t'while',\n\t'about',\n\t'there',\n\t'their',\n\t'your',\n\t'you',\n\t'and',\n\t'for',\n\t'into',\n\t'just',\n\t'than',\n\t'then',\n\t'were',\n\t'will',\n\t'would',\n\t'could',\n\t'should',\n\t'been',\n\t'they',\n\t'them',\n\t'also',\n\t'please',\n\t'need',\n\t'want',\n]);\n\ninterface RetrievalPipelineOptions {\n\tstore: MemoryStore;\n\tepisodic: EpisodicMemory;\n\tconsolidated: ConsolidatedMemoryStore;\n\tmaxMemoryResults?: number;\n\tmaxRecentEpisodes?: number;\n\trecentWindowHours?: number;\n\tminConfidence?: number;\n}\n\nexport interface RetrievedContext {\n\tentries: string[];\n\tformatted: string;\n\ttokenCount: number;\n\tstats: {\n\t\ttokenBudget: number;\n\t\tcandidates: number;\n\t\tincluded: number;\n\t\tmemories: number;\n\t\tepisodes: number;\n\t\tgoals: number;\n\t};\n}\n\nexport interface MemoryRetrievalPipeline {\n\tretrieveContext(query: string, tokenBudget: number): Promise<RetrievedContext>;\n}\n\ninterface JobRow {\n\tid: string;\n\tname: string;\n\ttask: string;\n\tnext_run: string | null;\n}\n\ntype CandidateType = 'memory' | 'episode' | 'goal';\n\ninterface Candidate {\n\ttype: CandidateType;\n\tscore: number;\n\tentry: string;\n\ttokenCount: number;\n}\n\nfunction tokenizeQuery(query: string): string[] {\n\treturn (\n\t\tquery\n\t\t\t.toLowerCase()\n\t\t\t.match(/[a-z0-9]{3,}/g)\n\t\t\t?.filter((token) => !STOPWORDS.has(token))\n\t\t\t.slice(0, 10) ?? []\n\t);\n}\n\nfunction lexicalScore(value: string, queryTokens: string[]): number {\n\tif (queryTokens.length === 0) return 0;\n\tconst normalized = value.toLowerCase();\n\tlet hits = 0;\n\tfor (const token of queryTokens) {\n\t\tif (normalized.includes(token)) hits += 1;\n\t}\n\treturn hits / queryTokens.length;\n}\n\nfunction clampUnit(value: number): number {\n\treturn Math.max(0, Math.min(1, value));\n}\n\nfunction hoursSince(date: Date, now: Date): number {\n\treturn Math.max(0, (now.getTime() - date.getTime()) / (1000 * 60 * 60));\n}\n\nfunction scoreMemory(memory: ConsolidatedMemory, queryTokens: string[], now: Date): number {\n\tconst lexical = lexicalScore(memory.content, queryTokens);\n\tconst freshness = clampUnit(1 - hoursSince(memory.updatedAt, now) / (24 * 14));\n\treturn lexical * 0.5 + memory.confidence * 0.35 + freshness * 0.15;\n}\n\nfunction scoreEpisode(\n\tepisode: Episode,\n\tqueryTokens: string[],\n\tnow: Date,\n\twindowHours: number,\n): number {\n\tconst lexical = lexicalScore(episode.content, queryTokens);\n\tconst recency = clampUnit(1 - hoursSince(episode.timestamp, now) / windowHours);\n\tconst importanceBoost = episode.metadata.importance === 'high' ? 0.15 : 0;\n\treturn lexical * 0.55 + recency * 0.45 + importanceBoost;\n}\n\nfunction scoreGoal(job: JobRow, queryTokens: string[], now: Date): number {\n\tconst lexical = lexicalScore(`${job.name} ${job.task}`, queryTokens);\n\tif (!job.next_run) {\n\t\treturn lexical * 0.7 + 0.15;\n\t}\n\tconst nextRun = new Date(job.next_run);\n\tconst hoursUntil = (nextRun.getTime() - now.getTime()) / (1000 * 60 * 60);\n\tconst urgency = hoursUntil <= 0 ? 1 : clampUnit(1 - hoursUntil / 24);\n\treturn lexical * 0.6 + urgency * 0.4;\n}\n\nfunction truncate(text: string, maxLength: number): string {\n\tif (text.length <= maxLength) return text;\n\treturn `${text.slice(0, maxLength - 3)}...`;\n}\n\nfunction formatMemoryEntry(memory: ConsolidatedMemory): string {\n\treturn `[memory/${memory.category}/c=${memory.confidence.toFixed(2)}] ${truncate(memory.content, 220)}`;\n}\n\nfunction formatEpisodeEntry(episode: Episode): string {\n\treturn `[recent/${episode.role}] ${truncate(episode.content, 180)}`;\n}\n\nfunction formatGoalEntry(job: JobRow): string {\n\tconst nextRun = job.next_run ? ` (next: ${new Date(job.next_run).toISOString()})` : '';\n\treturn `[goal/${job.name}] ${truncate(job.task, 160)}${nextRun}`;\n}\n\nfunction selectWithinBudget(\n\tcandidates: Candidate[],\n\ttokenBudget: number,\n): {\n\tentries: string[];\n\ttokenCount: number;\n} {\n\tconst entries: string[] = [];\n\tlet usedTokens = 0;\n\n\tfor (const candidate of candidates) {\n\t\tif (usedTokens + candidate.tokenCount > tokenBudget) {\n\t\t\tcontinue;\n\t\t}\n\t\tentries.push(candidate.entry);\n\t\tusedTokens += candidate.tokenCount;\n\t}\n\n\treturn { entries, tokenCount: usedTokens };\n}\n\nexport function createMemoryRetrievalPipeline(\n\toptions: RetrievalPipelineOptions,\n): MemoryRetrievalPipeline {\n\tconst maxMemoryResults = options.maxMemoryResults ?? 10;\n\tconst maxRecentEpisodes = options.maxRecentEpisodes ?? 20;\n\tconst recentWindowHours = options.recentWindowHours ?? 24;\n\tconst minConfidence = options.minConfidence ?? 0.3;\n\n\tfunction loadActiveJobs(limit = 20): JobRow[] {\n\t\treturn options.store.all<JobRow>(\n\t\t\t`SELECT id, name, task, next_run\n\t\t\t FROM jobs\n\t\t\t WHERE enabled = 1\n\t\t\t ORDER BY COALESCE(next_run, '9999-12-31T00:00:00.000Z') ASC\n\t\t\t LIMIT ?`,\n\t\t\t[limit],\n\t\t);\n\t}\n\n\tasync function retrieveContext(query: string, tokenBudget: number): Promise<RetrievedContext> {\n\t\tif (tokenBudget <= 0) {\n\t\t\treturn {\n\t\t\t\tentries: [],\n\t\t\t\tformatted: '',\n\t\t\t\ttokenCount: 0,\n\t\t\t\tstats: {\n\t\t\t\t\ttokenBudget,\n\t\t\t\t\tcandidates: 0,\n\t\t\t\t\tincluded: 0,\n\t\t\t\t\tmemories: 0,\n\t\t\t\t\tepisodes: 0,\n\t\t\t\t\tgoals: 0,\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tconst now = new Date();\n\t\tconst queryTokens = tokenizeQuery(query);\n\t\tconst [memories, recentEpisodes] = await Promise.all([\n\t\t\toptions.consolidated.search(query, {\n\t\t\t\ttopK: maxMemoryResults,\n\t\t\t\tminConfidence,\n\t\t\t}),\n\t\t\toptions.episodic.getRecent(maxRecentEpisodes),\n\t\t]);\n\n\t\tconst recentThreshold = now.getTime() - recentWindowHours * 60 * 60 * 1000;\n\t\tconst episodes = recentEpisodes.filter(\n\t\t\t(episode) => episode.timestamp.getTime() >= recentThreshold,\n\t\t);\n\t\tconst goals = loadActiveJobs();\n\t\tconst candidates: Candidate[] = [];\n\n\t\tfor (const memory of memories) {\n\t\t\tconst entry = formatMemoryEntry(memory);\n\t\t\tcandidates.push({\n\t\t\t\ttype: 'memory',\n\t\t\t\tscore: scoreMemory(memory, queryTokens, now),\n\t\t\t\tentry,\n\t\t\t\ttokenCount: estimateTokens(entry),\n\t\t\t});\n\t\t}\n\n\t\tfor (const episode of episodes) {\n\t\t\tconst entry = formatEpisodeEntry(episode);\n\t\t\tcandidates.push({\n\t\t\t\ttype: 'episode',\n\t\t\t\tscore: scoreEpisode(episode, queryTokens, now, recentWindowHours),\n\t\t\t\tentry,\n\t\t\t\ttokenCount: estimateTokens(entry),\n\t\t\t});\n\t\t}\n\n\t\tfor (const goal of goals) {\n\t\t\tconst entry = formatGoalEntry(goal);\n\t\t\tcandidates.push({\n\t\t\t\ttype: 'goal',\n\t\t\t\tscore: scoreGoal(goal, queryTokens, now),\n\t\t\t\tentry,\n\t\t\t\ttokenCount: estimateTokens(entry),\n\t\t\t});\n\t\t}\n\n\t\tcandidates.sort((a, b) => b.score - a.score || a.tokenCount - b.tokenCount);\n\t\tconst selected = selectWithinBudget(candidates, tokenBudget);\n\t\tconst formatted = selected.entries.join('\\n');\n\n\t\tlogger.debug('Retrieved context from memory pipeline', {\n\t\t\tqueryLength: query.length,\n\t\t\ttokenBudget,\n\t\t\tcandidateCount: candidates.length,\n\t\t\tincludedCount: selected.entries.length,\n\t\t\tselectedTokens: selected.tokenCount,\n\t\t\tmemories: memories.length,\n\t\t\tepisodes: episodes.length,\n\t\t\tgoals: goals.length,\n\t\t});\n\n\t\treturn {\n\t\t\tentries: selected.entries,\n\t\t\tformatted,\n\t\t\ttokenCount: selected.tokenCount,\n\t\t\tstats: {\n\t\t\t\ttokenBudget,\n\t\t\t\tcandidates: candidates.length,\n\t\t\t\tincluded: selected.entries.length,\n\t\t\t\tmemories: memories.length,\n\t\t\t\tepisodes: episodes.length,\n\t\t\t\tgoals: goals.length,\n\t\t\t},\n\t\t};\n\t}\n\n\treturn {\n\t\tretrieveContext,\n\t};\n}\n","import { existsSync, mkdirSync, readFileSync, writeFileSync } from 'node:fs';\nimport { dirname } from 'node:path';\nimport { createLogger } from '../utils/logger.js';\nimport type { ConsolidatedMemory } from './consolidated.js';\n\nconst logger = createLogger('memory:soul');\n\ninterface SoulConfig {\n\tsoulPath: string;\n\tuserName: string;\n\tagentName: string;\n}\n\ninterface Soul {\n\tgetSoulPrompt(): string;\n\treload(): void;\n\tregenerateFromMemories(memories: ConsolidatedMemory[]): void;\n}\n\nconst DEFAULT_SOUL = `# {agentName} ‚Äî Soul Definition\n\n## Identity\nYou are {agentName}, a personal AI agent owned by {userName}.\nYour job is to take care of {userName}'s digital life.\n\n## Personality\n- Proactive but not intrusive\n- Honest ‚Äî if you can't do something, say so\n- Security-conscious ‚Äî always explain what you're about to do\n- Efficient ‚Äî minimal steps, maximum result\n\n## Knowledge\n(No consolidated memories yet)\n\n## Active Goals\n(No active goals yet)\n\n## Preferences\n(No learned preferences yet)\n\n## Boundaries\n(Configured via sandbox permissions)\n`;\n\nfunction escapeRegExp(value: string): string {\n\treturn value.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n}\n\nfunction uniqueByContent(memories: ConsolidatedMemory[]): ConsolidatedMemory[] {\n\tconst seen = new Set<string>();\n\tconst result: ConsolidatedMemory[] = [];\n\tfor (const memory of memories) {\n\t\tconst key = memory.content.trim().toLowerCase();\n\t\tif (seen.has(key)) continue;\n\t\tseen.add(key);\n\t\tresult.push(memory);\n\t}\n\treturn result;\n}\n\nfunction upsertSection(document: string, title: string, body: string): string {\n\tconst sectionHeader = `## ${title}`;\n\tconst sectionText = `${sectionHeader}\\n${body}`;\n\tconst pattern = new RegExp(`## ${escapeRegExp(title)}\\\\n[\\\\s\\\\S]*?(?=\\\\n## |$)`, 'm');\n\n\tif (pattern.test(document)) {\n\t\treturn document.replace(pattern, sectionText);\n\t}\n\n\tconst trimmed = document.trimEnd();\n\treturn `${trimmed}\\n\\n${sectionText}\\n`;\n}\n\nfunction toBulletedList(memories: ConsolidatedMemory[], emptyLabel: string): string {\n\tif (memories.length === 0) return emptyLabel;\n\treturn memories\n\t\t.map((memory) => `- ${memory.content} (confidence ${memory.confidence.toFixed(2)})`)\n\t\t.join('\\n');\n}\n\n/**\n * Loads and manages the agent's soul definition (identity prompt).\n */\nexport function createSoul(config: SoulConfig): Soul {\n\tlet soulContent: string;\n\n\tfunction load(): string {\n\t\tif (existsSync(config.soulPath)) {\n\t\t\tlogger.info('Loading soul from file', { path: config.soulPath });\n\t\t\tconst raw = readFileSync(config.soulPath, 'utf-8');\n\t\t\treturn raw\n\t\t\t\t.replace(/\\{userName\\}/g, config.userName)\n\t\t\t\t.replace(/\\{agentName\\}/g, config.agentName);\n\t\t}\n\n\t\tlogger.info('Using default soul template');\n\t\treturn DEFAULT_SOUL.replace(/\\{userName\\}/g, config.userName).replace(\n\t\t\t/\\{agentName\\}/g,\n\t\t\tconfig.agentName,\n\t\t);\n\t}\n\n\tsoulContent = load();\n\n\treturn {\n\t\tgetSoulPrompt: () => soulContent,\n\t\treload: () => {\n\t\t\tsoulContent = load();\n\t\t},\n\t\tregenerateFromMemories(memories: ConsolidatedMemory[]): void {\n\t\t\tconst activeMemories = uniqueByContent(\n\t\t\t\tmemories\n\t\t\t\t\t.filter((memory) => memory.active)\n\t\t\t\t\t.sort(\n\t\t\t\t\t\t(a, b) => b.confidence - a.confidence || b.updatedAt.getTime() - a.updatedAt.getTime(),\n\t\t\t\t\t),\n\t\t\t);\n\n\t\t\tconst knowledge = activeMemories.filter((memory) =>\n\t\t\t\t['fact', 'pattern', 'relationship', 'skill', 'project'].includes(memory.category),\n\t\t\t);\n\t\t\tconst goals = activeMemories.filter((memory) => memory.category === 'goal');\n\t\t\tconst preferences = activeMemories.filter((memory) =>\n\t\t\t\t['preference', 'routine', 'emotional'].includes(memory.category),\n\t\t\t);\n\n\t\t\tlet nextSoul = soulContent;\n\t\t\tnextSoul = upsertSection(\n\t\t\t\tnextSoul,\n\t\t\t\t'Knowledge',\n\t\t\t\ttoBulletedList(knowledge.slice(0, 12), '(No consolidated memories yet)'),\n\t\t\t);\n\t\t\tnextSoul = upsertSection(\n\t\t\t\tnextSoul,\n\t\t\t\t'Active Goals',\n\t\t\t\ttoBulletedList(goals.slice(0, 8), '(No active goals yet)'),\n\t\t\t);\n\t\t\tnextSoul = upsertSection(\n\t\t\t\tnextSoul,\n\t\t\t\t'Preferences',\n\t\t\t\ttoBulletedList(preferences.slice(0, 8), '(No learned preferences yet)'),\n\t\t\t);\n\n\t\t\tmkdirSync(dirname(config.soulPath), { recursive: true });\n\t\t\twriteFileSync(config.soulPath, nextSoul, 'utf-8');\n\t\t\tsoulContent = nextSoul;\n\t\t\tlogger.info('Soul regenerated from consolidated memories', {\n\t\t\t\tpath: config.soulPath,\n\t\t\t\ttotalMemories: activeMemories.length,\n\t\t\t});\n\t\t},\n\t};\n}\n","import { mkdirSync, readdirSync, readFileSync } from 'node:fs';\nimport { dirname, join } from 'node:path';\nimport { DatabaseSync, type SQLInputValue } from 'node:sqlite';\nimport { fileURLToPath } from 'node:url';\nimport { getMamaHome } from '../config/defaults.js';\nimport { createLogger } from '../utils/logger.js';\n\nconst logger = createLogger('memory:store');\n\nexport interface AppliedMigration {\n\tversion: number;\n\tname: string;\n\tappliedAt: string;\n}\n\nexport interface MigrationRunResult {\n\tapplied: string[];\n\tskipped: string[];\n}\n\ninterface MigrationFile {\n\tversion: number;\n\tname: string;\n\tpath: string;\n}\n\ninterface CreateMemoryStoreOptions {\n\tdbPath?: string;\n\tmigrationsDir?: string;\n}\n\nexport interface MemoryStore {\n\tgetDbPath(): string;\n\trunMigrations(): MigrationRunResult;\n\tgetAppliedMigrations(): AppliedMigration[];\n\tlistTables(): string[];\n\trun(sql: string, params?: SQLInputValue[]): void;\n\tall<T>(sql: string, params?: SQLInputValue[]): T[];\n\tget<T>(sql: string, params?: SQLInputValue[]): T | undefined;\n\ttransaction<T>(fn: () => T): T;\n\tclose(): void;\n}\n\nfunction defaultDbPath(): string {\n\treturn join(getMamaHome(), 'mama.db');\n}\n\nfunction defaultMigrationsDir(): string {\n\tconst currentFile = fileURLToPath(import.meta.url);\n\treturn join(dirname(currentFile), 'migrations');\n}\n\nfunction parseMigrationVersion(fileName: string): number {\n\tconst match = fileName.match(/^(\\d+)_.*\\.sql$/);\n\tif (!match?.[1]) {\n\t\tthrow new Error(`Invalid migration filename: ${fileName}`);\n\t}\n\treturn Number.parseInt(match[1], 10);\n}\n\nfunction loadMigrationFiles(migrationsDir: string): MigrationFile[] {\n\tconst files = readdirSync(migrationsDir).filter((name) => name.endsWith('.sql'));\n\n\tconst migrations = files.map((name) => ({\n\t\tversion: parseMigrationVersion(name),\n\t\tname,\n\t\tpath: join(migrationsDir, name),\n\t}));\n\n\tmigrations.sort((a, b) => a.version - b.version || a.name.localeCompare(b.name));\n\treturn migrations;\n}\n\nfunction ensureMigrationTable(db: DatabaseSync): void {\n\tdb.exec(`\n\t\tCREATE TABLE IF NOT EXISTS _migrations (\n\t\t\tversion INTEGER PRIMARY KEY,\n\t\t\tname TEXT NOT NULL UNIQUE,\n\t\t\tapplied_at DATETIME NOT NULL\n\t\t)\n\t`);\n}\n\nfunction withTransaction(db: DatabaseSync, fn: () => void): void {\n\tdb.exec('BEGIN');\n\ttry {\n\t\tfn();\n\t\tdb.exec('COMMIT');\n\t} catch (error) {\n\t\tdb.exec('ROLLBACK');\n\t\tthrow error;\n\t}\n}\n\nfunction runPendingMigrations(db: DatabaseSync, migrationsDir: string): MigrationRunResult {\n\tconst migrations = loadMigrationFiles(migrationsDir);\n\tconst appliedRows = db\n\t\t.prepare('SELECT version, name FROM _migrations ORDER BY version ASC')\n\t\t.all() as Array<{ version: number; name: string }>;\n\tconst appliedVersions = new Set(appliedRows.map((row) => row.version));\n\n\tconst insertMigration = db.prepare(\n\t\t'INSERT INTO _migrations (version, name, applied_at) VALUES (?, ?, ?)',\n\t);\n\n\tconst result: MigrationRunResult = { applied: [], skipped: [] };\n\n\tfor (const migration of migrations) {\n\t\tif (appliedVersions.has(migration.version)) {\n\t\t\tresult.skipped.push(migration.name);\n\t\t\tcontinue;\n\t\t}\n\n\t\tconst sql = readFileSync(migration.path, 'utf-8');\n\t\twithTransaction(db, () => {\n\t\t\tdb.exec(sql);\n\t\t\tinsertMigration.run(migration.version, migration.name, new Date().toISOString());\n\t\t});\n\n\t\tresult.applied.push(migration.name);\n\t\tlogger.info('Applied migration', {\n\t\t\tversion: migration.version,\n\t\t\tname: migration.name,\n\t\t});\n\t}\n\n\treturn result;\n}\n\n/**\n * Creates the memory SQLite store and applies schema migrations.\n */\nexport function createMemoryStore(options: CreateMemoryStoreOptions = {}): MemoryStore {\n\tconst dbPath = options.dbPath ?? defaultDbPath();\n\tconst migrationsDir = options.migrationsDir ?? defaultMigrationsDir();\n\n\tif (dbPath !== ':memory:') {\n\t\tmkdirSync(dirname(dbPath), { recursive: true });\n\t}\n\n\tconst db = new DatabaseSync(dbPath);\n\tdb.exec('PRAGMA journal_mode = WAL');\n\tdb.exec('PRAGMA foreign_keys = ON');\n\tensureMigrationTable(db);\n\trunPendingMigrations(db, migrationsDir);\n\n\tfunction runMigrations(): MigrationRunResult {\n\t\treturn runPendingMigrations(db, migrationsDir);\n\t}\n\n\tfunction getAppliedMigrations(): AppliedMigration[] {\n\t\tconst rows = db\n\t\t\t.prepare('SELECT version, name, applied_at FROM _migrations ORDER BY version ASC')\n\t\t\t.all() as Array<{\n\t\t\tversion: number;\n\t\t\tname: string;\n\t\t\tapplied_at: string;\n\t\t}>;\n\t\treturn rows.map((row) => ({\n\t\t\tversion: row.version,\n\t\t\tname: row.name,\n\t\t\tappliedAt: row.applied_at,\n\t\t}));\n\t}\n\n\tfunction listTables(): string[] {\n\t\tconst rows = db\n\t\t\t.prepare(\n\t\t\t\t\"SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name ASC\",\n\t\t\t)\n\t\t\t.all() as Array<{ name: string }>;\n\t\treturn rows.map((row) => row.name);\n\t}\n\n\tfunction run(sql: string, params: SQLInputValue[] = []): void {\n\t\tdb.prepare(sql).run(...params);\n\t}\n\n\tfunction all<T>(sql: string, params: SQLInputValue[] = []): T[] {\n\t\treturn db.prepare(sql).all(...params) as T[];\n\t}\n\n\tfunction get<T>(sql: string, params: SQLInputValue[] = []): T | undefined {\n\t\treturn db.prepare(sql).get(...params) as T | undefined;\n\t}\n\n\tfunction transaction<T>(fn: () => T): T {\n\t\tlet result: T | undefined;\n\t\twithTransaction(db, () => {\n\t\t\tresult = fn();\n\t\t});\n\t\treturn result as T;\n\t}\n\n\tfunction close(): void {\n\t\tdb.close();\n\t}\n\n\treturn {\n\t\tgetDbPath: () => dbPath,\n\t\trunMigrations,\n\t\tgetAppliedMigrations,\n\t\tlistTables,\n\t\trun,\n\t\tall,\n\t\tget,\n\t\ttransaction,\n\t\tclose,\n\t};\n}\n","import Database from 'better-sqlite3';\nimport { createLogger } from '../utils/logger.js';\nimport type { AuditEntry } from './types.js';\n\nconst logger = createLogger('sandbox:audit');\n\ninterface AuditFilters {\n\tcapability?: string;\n\taction?: string;\n\tresult?: string;\n\tsince?: Date;\n\tuntil?: Date;\n\trequestedBy?: string;\n}\n\ninterface AuditStore {\n\tlog(entry: AuditEntry): void;\n\tquery(filters: AuditFilters): AuditEntry[];\n\tgetRecent(limit: number): AuditEntry[];\n\tclose(): void;\n}\n\nfunction createInMemoryAuditStore(): AuditStore {\n\tconst entries: AuditEntry[] = [];\n\n\tfunction toStoredEntry(entry: AuditEntry): AuditEntry {\n\t\treturn {\n\t\t\t...entry,\n\t\t\toutput: entry.output?.slice(0, 1024),\n\t\t\tparams: entry.params ? JSON.parse(JSON.stringify(entry.params)) : undefined,\n\t\t};\n\t}\n\n\tfunction sortNewest(items: AuditEntry[]): AuditEntry[] {\n\t\treturn [...items].sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());\n\t}\n\n\treturn {\n\t\tlog(entry: AuditEntry): void {\n\t\t\tentries.push(toStoredEntry(entry));\n\t\t},\n\t\tquery(filters: AuditFilters): AuditEntry[] {\n\t\t\tconst filtered = entries.filter((entry) => {\n\t\t\t\tif (filters.capability && entry.capability !== filters.capability) return false;\n\t\t\t\tif (filters.action && entry.action !== filters.action) return false;\n\t\t\t\tif (filters.result && entry.result !== filters.result) return false;\n\t\t\t\tif (filters.requestedBy && entry.requestedBy !== filters.requestedBy) return false;\n\t\t\t\tif (filters.since && entry.timestamp < filters.since) return false;\n\t\t\t\tif (filters.until && entry.timestamp > filters.until) return false;\n\t\t\t\treturn true;\n\t\t\t});\n\t\t\treturn sortNewest(filtered).slice(0, 1000);\n\t\t},\n\t\tgetRecent(limit: number): AuditEntry[] {\n\t\t\treturn sortNewest(entries).slice(0, limit);\n\t\t},\n\t\tclose(): void {\n\t\t\t// No-op for in-memory store\n\t\t},\n\t};\n}\n\n/**\n * Creates an append-only audit log backed by SQLite.\n * Uses WAL mode for crash safety.\n */\nexport function createAuditStore(dbPath: string): AuditStore {\n\tlet db: InstanceType<typeof Database>;\n\ttry {\n\t\tdb = new Database(dbPath);\n\t} catch (err: unknown) {\n\t\tconst reason = err instanceof Error ? err.message : String(err);\n\t\tlogger.warn('SQLite audit store unavailable, using in-memory fallback', { reason });\n\t\treturn createInMemoryAuditStore();\n\t}\n\n\t// Enable WAL mode for crash safety\n\tdb.pragma('journal_mode = WAL');\n\n\t// Create table\n\tdb.exec(`\n\t\tCREATE TABLE IF NOT EXISTS audit_log (\n\t\t\tid TEXT PRIMARY KEY,\n\t\t\ttimestamp TEXT NOT NULL,\n\t\t\tcapability TEXT NOT NULL,\n\t\t\taction TEXT NOT NULL,\n\t\t\tresource TEXT,\n\t\t\tparams TEXT,\n\t\t\tdecision TEXT NOT NULL,\n\t\t\tresult TEXT NOT NULL,\n\t\t\toutput TEXT,\n\t\t\terror TEXT,\n\t\t\tduration_ms INTEGER,\n\t\t\trequested_by TEXT\n\t\t)\n\t`);\n\n\t// Create indexes for common queries\n\tdb.exec(`\n\t\tCREATE INDEX IF NOT EXISTS idx_audit_timestamp ON audit_log(timestamp);\n\t\tCREATE INDEX IF NOT EXISTS idx_audit_capability ON audit_log(capability);\n\t\tCREATE INDEX IF NOT EXISTS idx_audit_result ON audit_log(result);\n\t`);\n\n\tconst insertStmt = db.prepare(`\n\t\tINSERT INTO audit_log (id, timestamp, capability, action, resource, params, decision, result, output, error, duration_ms, requested_by)\n\t\tVALUES (@id, @timestamp, @capability, @action, @resource, @params, @decision, @result, @output, @error, @durationMs, @requestedBy)\n\t`);\n\n\tconst queryStmt = db.prepare(`\n\t\tSELECT * FROM audit_log\n\t\tWHERE (@capability IS NULL OR capability = @capability)\n\t\tAND (@action IS NULL OR action = @action)\n\t\tAND (@result IS NULL OR result = @result)\n\t\tAND (@since IS NULL OR timestamp >= @since)\n\t\tAND (@until IS NULL OR timestamp <= @until)\n\t\tAND (@requestedBy IS NULL OR requested_by = @requestedBy)\n\t\tORDER BY timestamp DESC\n\t\tLIMIT 1000\n\t`);\n\n\tconst recentStmt = db.prepare(`\n\t\tSELECT * FROM audit_log ORDER BY timestamp DESC LIMIT ?\n\t`);\n\n\tfunction log(entry: AuditEntry): void {\n\t\t// Truncate output to 1KB for storage\n\t\tconst truncatedOutput = entry.output?.slice(0, 1024);\n\n\t\tinsertStmt.run({\n\t\t\tid: entry.id,\n\t\t\ttimestamp: entry.timestamp.toISOString(),\n\t\t\tcapability: entry.capability,\n\t\t\taction: entry.action,\n\t\t\tresource: entry.resource ?? '',\n\t\t\tparams: entry.params ? JSON.stringify(entry.params) : null,\n\t\t\tdecision: entry.decision,\n\t\t\tresult: entry.result,\n\t\t\toutput: truncatedOutput ?? null,\n\t\t\terror: entry.error ?? null,\n\t\t\tdurationMs: entry.durationMs,\n\t\t\trequestedBy: entry.requestedBy,\n\t\t});\n\n\t\tlogger.debug('Audit entry logged', {\n\t\t\tid: entry.id,\n\t\t\tcapability: entry.capability,\n\t\t\taction: entry.action,\n\t\t\tdecision: entry.decision,\n\t\t\tresult: entry.result,\n\t\t});\n\t}\n\n\tfunction rowToEntry(row: Record<string, unknown>): AuditEntry {\n\t\treturn {\n\t\t\tid: row.id as string,\n\t\t\ttimestamp: new Date(row.timestamp as string),\n\t\t\tcapability: row.capability as string,\n\t\t\taction: row.action as string,\n\t\t\tresource: row.resource as string,\n\t\t\tparams: row.params ? JSON.parse(row.params as string) : undefined,\n\t\t\tdecision: row.decision as AuditEntry['decision'],\n\t\t\tresult: row.result as AuditEntry['result'],\n\t\t\toutput: (row.output as string) ?? undefined,\n\t\t\terror: (row.error as string) ?? undefined,\n\t\t\tdurationMs: row.duration_ms as number,\n\t\t\trequestedBy: row.requested_by as string,\n\t\t};\n\t}\n\n\tfunction query(filters: AuditFilters): AuditEntry[] {\n\t\tconst rows = queryStmt.all({\n\t\t\tcapability: filters.capability ?? null,\n\t\t\taction: filters.action ?? null,\n\t\t\tresult: filters.result ?? null,\n\t\t\tsince: filters.since?.toISOString() ?? null,\n\t\t\tuntil: filters.until?.toISOString() ?? null,\n\t\t\trequestedBy: filters.requestedBy ?? null,\n\t\t}) as Record<string, unknown>[];\n\n\t\treturn rows.map(rowToEntry);\n\t}\n\n\tfunction getRecent(limit: number): AuditEntry[] {\n\t\tconst rows = recentStmt.all(limit) as Record<string, unknown>[];\n\t\treturn rows.map(rowToEntry);\n\t}\n\n\tfunction close(): void {\n\t\tdb.close();\n\t}\n\n\treturn { log, query, getRecent, close };\n}\n","import {\n\texistsSync,\n\treaddirSync,\n\treadFileSync,\n\trealpathSync,\n\tunlinkSync,\n\twriteFileSync,\n} from 'node:fs';\nimport path from 'node:path';\nimport micromatch from 'micromatch';\nimport { v4 as uuidv4 } from 'uuid';\nimport { createLogger } from '../utils/logger.js';\nimport type {\n\tAuditEntry,\n\tCapability,\n\tCapabilityResult,\n\tPermissionDecision,\n\tPermissionRequest,\n} from './types.js';\n\nconst logger = createLogger('sandbox:fs');\n\n/** Max bytes to store in audit output field */\nconst AUDIT_OUTPUT_MAX_BYTES = 1024;\n\ninterface FsPathRule {\n\tpath: string;\n\tactions: string[];\n\tlevel: 'auto' | 'ask' | 'deny';\n}\n\ninterface FilesystemSandboxConfig {\n\tworkspace: string;\n\tallowedPaths: FsPathRule[];\n\tdeniedPaths: string[];\n}\n\n/**\n * Resolves `~` at the start of a path to the given home directory.\n */\nfunction expandTilde(filePath: string, homePath: string): string {\n\tif (filePath === '~') {\n\t\treturn homePath;\n\t}\n\tif (filePath.startsWith('~/')) {\n\t\treturn path.join(homePath, filePath.slice(2));\n\t}\n\treturn filePath;\n}\n\n/**\n * Truncates a string to the given max byte length.\n * Ensures we don't cut in the middle of a multi-byte character.\n */\nfunction truncateOutput(value: string, maxBytes: number): string {\n\tif (Buffer.byteLength(value, 'utf-8') <= maxBytes) {\n\t\treturn value;\n\t}\n\tconst buf = Buffer.from(value, 'utf-8');\n\t// Slice to maxBytes and decode back; invalid trailing bytes are replaced\n\tconst truncated = buf.subarray(0, maxBytes).toString('utf-8');\n\treturn `${truncated}... [truncated]`;\n}\n\n/**\n * Detects suspicious path traversal.\n * If the raw path contains `..` segments and the resolved path escapes what\n * we would expect from the raw path's starting directory, flag it.\n */\nfunction isPathTraversal(rawPath: string, resolvedPath: string, homePath: string): boolean {\n\tif (!rawPath.includes('..')) {\n\t\treturn false;\n\t}\n\t// Expand tilde in the raw path to get the \"intended\" starting point\n\tconst expanded = expandTilde(rawPath, homePath);\n\t// The resolved path should be a descendant of the raw path's parent directory\n\tconst expectedParent = path.dirname(path.resolve(expanded.split('..')[0] ?? expanded));\n\t// If the resolved path is not under the expected parent, it's suspicious\n\tif (!resolvedPath.startsWith(expectedParent)) {\n\t\treturn true;\n\t}\n\treturn false;\n}\n\n/**\n * Creates a Filesystem Capability for the sandbox.\n *\n * All file system access from the agent routes through this capability,\n * which enforces path-based permissions and generates audit entries.\n */\nexport function createFsCapability(config: FilesystemSandboxConfig, homePath: string): Capability {\n\t// Pre-resolve config paths\n\tconst resolvedWorkspace = path.resolve(expandTilde(config.workspace, homePath));\n\tconst resolvedDeniedPatterns = config.deniedPaths.map((p) =>\n\t\tpath.resolve(expandTilde(p, homePath)),\n\t);\n\tconst resolvedAllowedRules = config.allowedPaths.map((rule) => ({\n\t\t...rule,\n\t\tresolvedPattern: path.resolve(expandTilde(rule.path, homePath)),\n\t}));\n\n\tfunction resolveFsPath(rawPath: string): string {\n\t\tconst expanded = expandTilde(rawPath, homePath);\n\t\treturn path.resolve(expanded);\n\t}\n\n\tfunction resolveActionPath(\n\t\tresolvedPath: string,\n\t\taction: string,\n\t): { ok: true; path: string } | { ok: false; reason: string } {\n\t\ttry {\n\t\t\tif (action === 'write') {\n\t\t\t\t// For new files, resolve symlinks in parent directories to prevent escapes.\n\t\t\t\tif (!existsSync(resolvedPath)) {\n\t\t\t\t\tconst parent = path.dirname(resolvedPath);\n\t\t\t\t\tconst realParent = realpathSync(parent);\n\t\t\t\t\treturn { ok: true, path: path.join(realParent, path.basename(resolvedPath)) };\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn { ok: true, path: realpathSync(resolvedPath) };\n\t\t} catch (err: unknown) {\n\t\t\tconst reason = err instanceof Error ? err.message : 'Failed to resolve real path';\n\t\t\treturn { ok: false, reason };\n\t\t}\n\t}\n\n\tfunction checkPermission(request: PermissionRequest): PermissionDecision {\n\t\tconst resolvedPath = resolveFsPath(request.resource);\n\t\tconst actionPath = resolveActionPath(resolvedPath, request.action);\n\n\t\tif (!actionPath.ok) {\n\t\t\treturn {\n\t\t\t\tallowed: false,\n\t\t\t\treason: `Path resolution failed for \"${request.resource}\": ${actionPath.reason}`,\n\t\t\t\tlevel: 'denied',\n\t\t\t};\n\t\t}\n\t\tconst effectivePath = actionPath.path;\n\n\t\t// Detect path traversal\n\t\tif (isPathTraversal(request.resource, effectivePath, homePath)) {\n\t\t\tlogger.warn('Path traversal detected', {\n\t\t\t\traw: request.resource,\n\t\t\t\tresolved: effectivePath,\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tallowed: false,\n\t\t\t\treason: `Path traversal detected: ${request.resource} resolves to ${effectivePath}`,\n\t\t\t\tlevel: 'denied',\n\t\t\t};\n\t\t}\n\n\t\t// 1. Check denied paths FIRST (always wins)\n\t\tfor (const deniedPattern of resolvedDeniedPatterns) {\n\t\t\tif (micromatch.isMatch(effectivePath, deniedPattern)) {\n\t\t\t\tlogger.debug('Path denied by rule', {\n\t\t\t\t\tpath: effectivePath,\n\t\t\t\t\tpattern: deniedPattern,\n\t\t\t\t});\n\t\t\t\treturn {\n\t\t\t\t\tallowed: false,\n\t\t\t\t\treason: `Path is denied: ${request.resource}`,\n\t\t\t\t\tlevel: 'denied',\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// 2. Workspace is always allowed (auto level)\n\t\tif (effectivePath === resolvedWorkspace || effectivePath.startsWith(`${resolvedWorkspace}/`)) {\n\t\t\treturn { allowed: true, level: 'auto' };\n\t\t}\n\n\t\t// 3. Check allowed paths: find matching rule by glob + action\n\t\tfor (const rule of resolvedAllowedRules) {\n\t\t\tconst matchesPath = micromatch.isMatch(effectivePath, rule.resolvedPattern);\n\t\t\tconst matchesAction = rule.actions.includes(request.action);\n\n\t\t\tif (matchesPath && matchesAction) {\n\t\t\t\tif (rule.level === 'deny') {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tallowed: false,\n\t\t\t\t\t\treason: `Rule explicitly denies ${request.action} on ${request.resource}`,\n\t\t\t\t\t\tlevel: 'denied',\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tconst level: 'auto' | 'user-approved' = rule.level === 'ask' ? 'user-approved' : 'auto';\n\n\t\t\t\treturn { allowed: true, level };\n\t\t\t}\n\t\t}\n\n\t\t// 4. No rule matches -> deny\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: `No rule allows '${request.action}' on ${request.resource}`,\n\t\t\tlevel: 'denied',\n\t\t};\n\t}\n\n\tasync function execute(\n\t\taction: string,\n\t\tparams: Record<string, unknown>,\n\t): Promise<CapabilityResult> {\n\t\tconst rawPath = params.path as string | undefined;\n\n\t\tif (!rawPath) {\n\t\t\tconst auditEntry = createAuditEntry(\n\t\t\t\taction,\n\t\t\t\t'',\n\t\t\t\tparams,\n\t\t\t\t'rule-denied',\n\t\t\t\t'error',\n\t\t\t\t0,\n\t\t\t\tundefined,\n\t\t\t\t'Missing required parameter: path',\n\t\t\t);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: 'Missing required parameter: path',\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs: 0,\n\t\t\t};\n\t\t}\n\n\t\tconst resolvedPath = resolveFsPath(rawPath);\n\n\t\t// Check permission internally before executing\n\t\tconst permRequest: PermissionRequest = {\n\t\t\tcapability: 'filesystem',\n\t\t\taction,\n\t\t\tresource: rawPath,\n\t\t\trequestedBy: (params.requestedBy as string | undefined) ?? 'agent',\n\t\t};\n\t\tconst decision = checkPermission(permRequest);\n\n\t\tif (!decision.allowed) {\n\t\t\tconst auditEntry = createAuditEntry(\n\t\t\t\taction,\n\t\t\t\tresolvedPath,\n\t\t\t\tparams,\n\t\t\t\t'rule-denied',\n\t\t\t\t'denied',\n\t\t\t\t0,\n\t\t\t\tundefined,\n\t\t\t\tdecision.reason,\n\t\t\t);\n\t\t\tlogger.warn('Filesystem access denied', {\n\t\t\t\taction,\n\t\t\t\tpath: resolvedPath,\n\t\t\t\treason: decision.reason,\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: decision.reason,\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs: 0,\n\t\t\t};\n\t\t}\n\n\t\tif (decision.level === 'user-approved' && params.__approvedByUser !== true) {\n\t\t\tconst auditEntry = createAuditEntry(\n\t\t\t\taction,\n\t\t\t\tresolvedPath,\n\t\t\t\tparams,\n\t\t\t\t'rule-denied',\n\t\t\t\t'denied',\n\t\t\t\t0,\n\t\t\t\tundefined,\n\t\t\t\t'Missing explicit user approval token',\n\t\t\t\tpermRequest.requestedBy,\n\t\t\t);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: 'Missing explicit user approval token',\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs: 0,\n\t\t\t};\n\t\t}\n\n\t\tconst actionPath = resolveActionPath(resolvedPath, action);\n\t\tif (!actionPath.ok) {\n\t\t\tconst auditEntry = createAuditEntry(\n\t\t\t\taction,\n\t\t\t\tresolvedPath,\n\t\t\t\tparams,\n\t\t\t\t'error',\n\t\t\t\t'error',\n\t\t\t\t0,\n\t\t\t\tundefined,\n\t\t\t\t`Path resolution failed: ${actionPath.reason}`,\n\t\t\t\tpermRequest.requestedBy,\n\t\t\t);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: `Path resolution failed: ${actionPath.reason}`,\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs: 0,\n\t\t\t};\n\t\t}\n\t\tconst executionPath = actionPath.path;\n\n\t\tconst start = Date.now();\n\n\t\ttry {\n\t\t\tlet output: unknown;\n\t\t\tlet outputStr: string;\n\n\t\t\tswitch (action) {\n\t\t\t\tcase 'read': {\n\t\t\t\t\tconst content = readFileSync(executionPath, 'utf-8');\n\t\t\t\t\toutput = content;\n\t\t\t\t\toutputStr = content;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'write': {\n\t\t\t\t\tconst content = (params.content as string) ?? '';\n\t\t\t\t\twriteFileSync(executionPath, content, 'utf-8');\n\t\t\t\t\tconst bytesWritten = Buffer.byteLength(content, 'utf-8');\n\t\t\t\t\toutput = { bytesWritten };\n\t\t\t\t\toutputStr = `${String(bytesWritten)} bytes written`;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'list': {\n\t\t\t\t\tconst entries = readdirSync(executionPath);\n\t\t\t\t\toutput = entries;\n\t\t\t\t\toutputStr = entries.join('\\n');\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'delete': {\n\t\t\t\t\tunlinkSync(executionPath);\n\t\t\t\t\toutput = { deleted: true };\n\t\t\t\t\toutputStr = `Deleted ${executionPath}`;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault: {\n\t\t\t\t\tconst durationMs = Date.now() - start;\n\t\t\t\t\tconst auditEntry = createAuditEntry(\n\t\t\t\t\t\taction,\n\t\t\t\t\t\texecutionPath,\n\t\t\t\t\t\tparams,\n\t\t\t\t\t\t'rule-denied',\n\t\t\t\t\t\t'error',\n\t\t\t\t\t\tdurationMs,\n\t\t\t\t\t\tundefined,\n\t\t\t\t\t\t`Unknown action: ${action}`,\n\t\t\t\t\t);\n\t\t\t\t\treturn {\n\t\t\t\t\t\tsuccess: false,\n\t\t\t\t\t\toutput: null,\n\t\t\t\t\t\terror: `Unknown action: ${action}`,\n\t\t\t\t\t\tauditEntry,\n\t\t\t\t\t\tdurationMs,\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst durationMs = Date.now() - start;\n\t\t\tconst decisionLabel: AuditEntry['decision'] =\n\t\t\t\tdecision.level === 'user-approved' ? 'user-approved' : 'auto-approved';\n\t\t\tconst auditEntry = createAuditEntry(\n\t\t\t\taction,\n\t\t\t\texecutionPath,\n\t\t\t\tparams,\n\t\t\t\tdecisionLabel,\n\t\t\t\t'success',\n\t\t\t\tdurationMs,\n\t\t\t\ttruncateOutput(outputStr, AUDIT_OUTPUT_MAX_BYTES),\n\t\t\t\tundefined,\n\t\t\t\tpermRequest.requestedBy,\n\t\t\t);\n\n\t\t\tlogger.debug('Filesystem action executed', {\n\t\t\t\taction,\n\t\t\t\tpath: executionPath,\n\t\t\t\tdurationMs,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\toutput,\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs,\n\t\t\t};\n\t\t} catch (err: unknown) {\n\t\t\tconst durationMs = Date.now() - start;\n\t\t\tconst errorMessage =\n\t\t\t\terr instanceof Error ? err.message : 'Unknown error during filesystem operation';\n\n\t\t\tlogger.error('Filesystem action failed', {\n\t\t\t\taction,\n\t\t\t\tpath: executionPath,\n\t\t\t\terror: errorMessage,\n\t\t\t});\n\n\t\t\tconst auditEntry = createAuditEntry(\n\t\t\t\taction,\n\t\t\t\texecutionPath,\n\t\t\t\tparams,\n\t\t\t\t'error',\n\t\t\t\t'error',\n\t\t\t\tdurationMs,\n\t\t\t\tundefined,\n\t\t\t\terrorMessage,\n\t\t\t\tpermRequest.requestedBy,\n\t\t\t);\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: errorMessage,\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs,\n\t\t\t};\n\t\t}\n\t}\n\n\tfunction createAuditEntry(\n\t\taction: string,\n\t\tresource: string,\n\t\tparams: Record<string, unknown>,\n\t\tdecision: AuditEntry['decision'],\n\t\tresult: AuditEntry['result'],\n\t\tdurationMs: number,\n\t\toutput?: string,\n\t\terror?: string,\n\t\trequestedBy?: string,\n\t): AuditEntry {\n\t\treturn {\n\t\t\tid: uuidv4(),\n\t\t\ttimestamp: new Date(),\n\t\t\tcapability: 'filesystem',\n\t\t\taction,\n\t\t\tresource,\n\t\t\tparams,\n\t\t\tdecision,\n\t\t\tresult,\n\t\t\toutput,\n\t\t\terror,\n\t\t\tdurationMs,\n\t\t\trequestedBy: requestedBy ?? 'agent',\n\t\t};\n\t}\n\n\treturn {\n\t\tname: 'filesystem',\n\t\tdescription: 'Controls file system access: read, write, list, and delete operations',\n\t\tcheckPermission,\n\t\texecute,\n\t};\n}\n","import { v4 as uuidv4 } from 'uuid';\nimport { createLogger } from '../utils/logger.js';\nimport type {\n\tAuditEntry,\n\tCapability,\n\tCapabilityResult,\n\tPermissionDecision,\n\tPermissionRequest,\n} from './types.js';\n\nconst logger = createLogger('sandbox:network');\n\nconst MAX_RESPONSE_BODY_LENGTH = 10_000;\n\nexport interface NetworkSandboxConfig {\n\tallowedDomains: string[];\n\taskDomains: boolean;\n\trateLimitPerMinute: number;\n\tlogAllRequests: boolean;\n}\n\nfunction extractDomain(url: string): string {\n\treturn new URL(url).hostname;\n}\n\n/**\n * Creates a Network Capability for the sandbox.\n * Controls all outbound HTTP requests with domain allowlists,\n * user-approval for unknown domains, and rate limiting.\n */\nexport function createNetworkCapability(config: NetworkSandboxConfig): Capability {\n\tconst sessionApprovedDomains = new Set<string>();\n\tconst requestTimestamps: number[] = [];\n\n\tfunction isRateLimited(): boolean {\n\t\tconst now = Date.now();\n\t\tconst windowStart = now - 60_000;\n\n\t\t// Prune timestamps older than the window\n\t\twhile (requestTimestamps.length > 0) {\n\t\t\tconst first = requestTimestamps[0];\n\t\t\tif (first === undefined || first >= windowStart) break;\n\t\t\trequestTimestamps.shift();\n\t\t}\n\n\t\treturn requestTimestamps.length >= config.rateLimitPerMinute;\n\t}\n\n\tfunction checkPermission(request: PermissionRequest): PermissionDecision {\n\t\tlet domain: string;\n\t\ttry {\n\t\t\tdomain = extractDomain(request.resource);\n\t\t} catch {\n\t\t\treturn { allowed: false, reason: `Invalid URL: ${request.resource}`, level: 'denied' };\n\t\t}\n\n\t\tif (config.allowedDomains.includes(domain) || sessionApprovedDomains.has(domain)) {\n\t\t\treturn { allowed: true, level: 'auto' };\n\t\t}\n\n\t\tif (config.askDomains) {\n\t\t\treturn { allowed: true, level: 'user-approved' };\n\t\t}\n\n\t\treturn {\n\t\t\tallowed: false,\n\t\t\treason: `Domain not allowed: ${domain}`,\n\t\t\tlevel: 'denied',\n\t\t};\n\t}\n\n\tasync function execute(\n\t\taction: string,\n\t\tparams: Record<string, unknown>,\n\t): Promise<CapabilityResult> {\n\t\tconst startTime = Date.now();\n\t\tconst requestedBy = (params.requestedBy as string | undefined) ?? 'agent';\n\t\tconst url = params.url as string | undefined;\n\n\t\tif (!url || typeof url !== 'string') {\n\t\t\tconst auditEntry = createAuditEntry({\n\t\t\t\taction,\n\t\t\t\tresource: String(url ?? ''),\n\t\t\t\tparams,\n\t\t\t\tdecision: 'error',\n\t\t\t\tresult: 'error',\n\t\t\t\terror: 'Missing or invalid \"url\" parameter',\n\t\t\t\tdurationMs: Date.now() - startTime,\n\t\t\t\trequestedBy,\n\t\t\t});\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: 'Missing or invalid \"url\" parameter',\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs: auditEntry.durationMs,\n\t\t\t};\n\t\t}\n\n\t\tconst method = (params.method as string | undefined) ?? 'GET';\n\t\tconst headers = params.headers as Record<string, string> | undefined;\n\t\tconst body = params.body as string | undefined;\n\n\t\t// Check permission\n\t\tconst permission = checkPermission({\n\t\t\tcapability: 'network',\n\t\t\taction,\n\t\t\tresource: url,\n\t\t\trequestedBy,\n\t\t});\n\n\t\tif (!permission.allowed) {\n\t\t\tconst auditEntry = createAuditEntry({\n\t\t\t\taction,\n\t\t\t\tresource: url,\n\t\t\t\tparams: { url, method },\n\t\t\t\tdecision: 'rule-denied',\n\t\t\t\tresult: 'denied',\n\t\t\t\terror: permission.reason,\n\t\t\t\tdurationMs: Date.now() - startTime,\n\t\t\t\trequestedBy,\n\t\t\t});\n\n\t\t\tlogger.warn('Network request denied', {\n\t\t\t\turl,\n\t\t\t\tmethod,\n\t\t\t\treason: permission.reason,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: permission.reason,\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs: auditEntry.durationMs,\n\t\t\t};\n\t\t}\n\n\t\tif (permission.level === 'user-approved' && params.__approvedByUser !== true) {\n\t\t\tconst auditEntry = createAuditEntry({\n\t\t\t\taction,\n\t\t\t\tresource: url,\n\t\t\t\tparams: { url, method },\n\t\t\t\tdecision: 'rule-denied',\n\t\t\t\tresult: 'denied',\n\t\t\t\terror: 'Missing explicit user approval token',\n\t\t\t\tdurationMs: Date.now() - startTime,\n\t\t\t\trequestedBy,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: 'Missing explicit user approval token',\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs: auditEntry.durationMs,\n\t\t\t};\n\t\t}\n\n\t\t// Check rate limit\n\t\tif (isRateLimited()) {\n\t\t\tconst error = `Rate limit exceeded: ${config.rateLimitPerMinute} requests per minute`;\n\t\t\tconst auditEntry = createAuditEntry({\n\t\t\t\taction,\n\t\t\t\tresource: url,\n\t\t\t\tparams: { url, method },\n\t\t\t\tdecision: 'rule-denied',\n\t\t\t\tresult: 'error',\n\t\t\t\terror,\n\t\t\t\tdurationMs: Date.now() - startTime,\n\t\t\t\trequestedBy,\n\t\t\t});\n\n\t\t\tlogger.warn('Network rate limit exceeded', {\n\t\t\t\turl,\n\t\t\t\tmethod,\n\t\t\t\trateLimitPerMinute: config.rateLimitPerMinute,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror,\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs: auditEntry.durationMs,\n\t\t\t};\n\t\t}\n\n\t\t// Execute the fetch\n\t\ttry {\n\t\t\tconst fetchOptions: RequestInit = { method };\n\n\t\t\tif (headers) {\n\t\t\t\tfetchOptions.headers = headers;\n\t\t\t}\n\n\t\t\tif (body && method !== 'GET' && method !== 'HEAD') {\n\t\t\t\tfetchOptions.body = body;\n\t\t\t}\n\n\t\t\tconst response = await fetch(url, fetchOptions);\n\n\t\t\t// Record timestamp for rate limiting\n\t\t\trequestTimestamps.push(Date.now());\n\n\t\t\tconst responseBody = await response.text();\n\t\t\tconst truncatedBody =\n\t\t\t\tresponseBody.length > MAX_RESPONSE_BODY_LENGTH\n\t\t\t\t\t? `${responseBody.slice(0, MAX_RESPONSE_BODY_LENGTH)}... [truncated, ${responseBody.length} total chars]`\n\t\t\t\t\t: responseBody;\n\n\t\t\tconst responseHeaders: Record<string, string> = {};\n\t\t\tresponse.headers.forEach((value, key) => {\n\t\t\t\tresponseHeaders[key] = value;\n\t\t\t});\n\n\t\t\tconst output = {\n\t\t\t\tstatus: response.status,\n\t\t\t\tstatusText: response.statusText,\n\t\t\t\theaders: responseHeaders,\n\t\t\t\tbody: truncatedBody,\n\t\t\t};\n\n\t\t\tconst durationMs = Date.now() - startTime;\n\t\t\tconst decision = permission.level === 'user-approved' ? 'user-approved' : 'auto-approved';\n\n\t\t\tconst auditEntry = createAuditEntry({\n\t\t\t\taction,\n\t\t\t\tresource: url,\n\t\t\t\tparams: { url, method },\n\t\t\t\tdecision,\n\t\t\t\tresult: 'success',\n\t\t\t\toutput: `HTTP ${response.status} ${response.statusText}`,\n\t\t\t\tdurationMs,\n\t\t\t\trequestedBy,\n\t\t\t});\n\n\t\t\t// Add domain to session-approved on success\n\t\t\ttry {\n\t\t\t\tconst domain = extractDomain(url);\n\t\t\t\tsessionApprovedDomains.add(domain);\n\t\t\t} catch {\n\t\t\t\t// Domain extraction already validated above, but be defensive\n\t\t\t}\n\n\t\t\tif (config.logAllRequests) {\n\t\t\t\tlogger.info('Network request completed', {\n\t\t\t\t\turl,\n\t\t\t\t\tmethod,\n\t\t\t\t\tstatus: response.status,\n\t\t\t\t\tdurationMs,\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tlogger.debug('Network request completed', {\n\t\t\t\t\turl,\n\t\t\t\t\tmethod,\n\t\t\t\t\tstatus: response.status,\n\t\t\t\t\tdurationMs,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tsuccess: true,\n\t\t\t\toutput,\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs,\n\t\t\t};\n\t\t} catch (err: unknown) {\n\t\t\tconst durationMs = Date.now() - startTime;\n\t\t\tconst errorMessage = err instanceof Error ? err.message : String(err);\n\n\t\t\tconst auditEntry = createAuditEntry({\n\t\t\t\taction,\n\t\t\t\tresource: url,\n\t\t\t\tparams: { url, method },\n\t\t\t\tdecision: 'error',\n\t\t\t\tresult: 'error',\n\t\t\t\terror: errorMessage,\n\t\t\t\tdurationMs,\n\t\t\t\trequestedBy,\n\t\t\t});\n\n\t\t\tlogger.error('Network request failed', {\n\t\t\t\turl,\n\t\t\t\tmethod,\n\t\t\t\terror: errorMessage,\n\t\t\t\tdurationMs,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: errorMessage,\n\t\t\t\tauditEntry,\n\t\t\t\tdurationMs,\n\t\t\t};\n\t\t}\n\t}\n\n\tfunction createAuditEntry(fields: {\n\t\taction: string;\n\t\tresource: string;\n\t\tparams: Record<string, unknown>;\n\t\tdecision: AuditEntry['decision'];\n\t\tresult: AuditEntry['result'];\n\t\toutput?: string;\n\t\terror?: string;\n\t\tdurationMs: number;\n\t\trequestedBy: string;\n\t}): AuditEntry {\n\t\treturn {\n\t\t\tid: uuidv4(),\n\t\t\ttimestamp: new Date(),\n\t\t\tcapability: 'network',\n\t\t\taction: fields.action,\n\t\t\tresource: fields.resource,\n\t\t\tparams: fields.params,\n\t\t\tdecision: fields.decision,\n\t\t\tresult: fields.result,\n\t\t\toutput: fields.output,\n\t\t\terror: fields.error,\n\t\t\tdurationMs: fields.durationMs,\n\t\t\trequestedBy: fields.requestedBy,\n\t\t};\n\t}\n\n\treturn {\n\t\tname: 'network',\n\t\tdescription: 'Controlled outbound HTTP requests with domain allowlists and rate limiting',\n\t\tcheckPermission,\n\t\texecute,\n\t};\n}\n","import { v4 as uuidv4 } from 'uuid';\nimport { createLogger } from '../utils/logger.js';\nimport type {\n\tApprovalHandler,\n\tApprovalRequest,\n\tAuditEntry,\n\tCapability,\n\tCapabilityResult,\n\tPermissionDecision,\n\tPermissionRequest,\n} from './types.js';\n\nconst logger = createLogger('sandbox');\n\ninterface AuditStore {\n\tlog(entry: AuditEntry): void;\n}\n\ninterface Sandbox {\n\tregister(capability: Capability): void;\n\tcheck(\n\t\tcapName: string,\n\t\taction: string,\n\t\tresource: string,\n\t\trequestedBy?: string,\n\t): PermissionDecision;\n\texecute(\n\t\tcapName: string,\n\t\taction: string,\n\t\tparams: Record<string, unknown>,\n\t\trequestedBy?: string,\n\t): Promise<CapabilityResult>;\n\tsetApprovalHandler(handler: ApprovalHandler): void;\n\tgetCapability(name: string): Capability | undefined;\n\tgetCapabilities(): Capability[];\n}\n\n/**\n * Creates the central Capability Sandbox.\n * All system access routes through here.\n */\nexport function createSandbox(auditStore?: AuditStore): Sandbox {\n\tconst capabilities = new Map<string, Capability>();\n\tlet approvalHandler: ApprovalHandler | null = null;\n\n\tfunction register(capability: Capability): void {\n\t\tcapabilities.set(capability.name, capability);\n\t\tlogger.info('Capability registered', { name: capability.name });\n\t}\n\n\tfunction check(\n\t\tcapName: string,\n\t\taction: string,\n\t\tresource: string,\n\t\trequestedBy = 'agent',\n\t): PermissionDecision {\n\t\tconst capability = capabilities.get(capName);\n\t\tif (!capability) {\n\t\t\treturn { allowed: false, reason: `Unknown capability: ${capName}`, level: 'denied' };\n\t\t}\n\n\t\tconst request: PermissionRequest = {\n\t\t\tcapability: capName,\n\t\t\taction,\n\t\t\tresource,\n\t\t\trequestedBy,\n\t\t};\n\n\t\treturn capability.checkPermission(request);\n\t}\n\n\tasync function execute(\n\t\tcapName: string,\n\t\taction: string,\n\t\tparams: Record<string, unknown>,\n\t\trequestedBy = 'agent',\n\t): Promise<CapabilityResult> {\n\t\tconst baseParams: Record<string, unknown> = { ...params, requestedBy };\n\t\tconst capability = capabilities.get(capName);\n\t\tif (!capability) {\n\t\t\tconst entry = createDeniedAuditEntry(\n\t\t\t\tcapName,\n\t\t\t\taction,\n\t\t\t\tbaseParams,\n\t\t\t\t`Unknown capability: ${capName}`,\n\t\t\t\trequestedBy,\n\t\t\t);\n\t\t\tauditStore?.log(entry);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: `Unknown capability: ${capName}`,\n\t\t\t\tauditEntry: entry,\n\t\t\t\tdurationMs: 0,\n\t\t\t};\n\t\t}\n\n\t\tconst resource = (baseParams.path ?? baseParams.command ?? baseParams.url ?? '') as string;\n\t\tconst permission = check(capName, action, resource, requestedBy);\n\n\t\tif (!permission.allowed) {\n\t\t\tlogger.warn('Capability denied', {\n\t\t\t\tcapability: capName,\n\t\t\t\taction,\n\t\t\t\tresource,\n\t\t\t\treason: permission.reason,\n\t\t\t});\n\t\t\tconst entry = createDeniedAuditEntry(\n\t\t\t\tcapName,\n\t\t\t\taction,\n\t\t\t\tbaseParams,\n\t\t\t\tpermission.reason,\n\t\t\t\trequestedBy,\n\t\t\t);\n\t\t\tauditStore?.log(entry);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: permission.reason,\n\t\t\t\tauditEntry: entry,\n\t\t\t\tdurationMs: 0,\n\t\t\t};\n\t\t}\n\n\t\t// If level is 'user-approved' we need actual user approval (ask level from config)\n\t\t// This is handled inside each capability, but we also support it here\n\t\tif (permission.level === 'user-approved' || (permission.level as string) === 'ask') {\n\t\t\tif (!approvalHandler) {\n\t\t\t\tconst entry = createDeniedAuditEntry(\n\t\t\t\t\tcapName,\n\t\t\t\t\taction,\n\t\t\t\t\tbaseParams,\n\t\t\t\t\t'No approval handler available',\n\t\t\t\t\trequestedBy,\n\t\t\t\t);\n\t\t\t\tauditStore?.log(entry);\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\toutput: null,\n\t\t\t\t\terror: 'No approval handler available',\n\t\t\t\t\tauditEntry: entry,\n\t\t\t\t\tdurationMs: 0,\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tconst approvalReq: ApprovalRequest = {\n\t\t\t\tcapability: capName,\n\t\t\t\taction,\n\t\t\t\tresource,\n\t\t\t\tcontext: baseParams.context as string | undefined,\n\t\t\t};\n\n\t\t\tconst approved = await approvalHandler(approvalReq);\n\t\t\tif (!approved) {\n\t\t\t\tlogger.info('User denied capability', { capability: capName, action, resource });\n\t\t\t\tconst entry: AuditEntry = {\n\t\t\t\t\tid: uuidv4(),\n\t\t\t\t\ttimestamp: new Date(),\n\t\t\t\t\tcapability: capName,\n\t\t\t\t\taction,\n\t\t\t\t\tresource,\n\t\t\t\t\tparams: baseParams,\n\t\t\t\t\tdecision: 'user-denied',\n\t\t\t\t\tresult: 'denied',\n\t\t\t\t\tdurationMs: 0,\n\t\t\t\t\trequestedBy,\n\t\t\t\t};\n\t\t\t\tauditStore?.log(entry);\n\t\t\t\treturn {\n\t\t\t\t\tsuccess: false,\n\t\t\t\t\toutput: null,\n\t\t\t\t\terror: 'User denied the action',\n\t\t\t\t\tauditEntry: entry,\n\t\t\t\t\tdurationMs: 0,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tconst executionParams =\n\t\t\tpermission.level === 'user-approved'\n\t\t\t\t? ({ ...baseParams, __approvedByUser: true } as Record<string, unknown>)\n\t\t\t\t: baseParams;\n\n\t\t// Execute the capability\n\t\tconst result = await capability.execute(action, executionParams);\n\t\tauditStore?.log(result.auditEntry);\n\n\t\tlogger.info('Capability executed', {\n\t\t\tcapability: capName,\n\t\t\taction,\n\t\t\tresource,\n\t\t\tsuccess: result.success,\n\t\t\tdurationMs: result.durationMs,\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tfunction setApprovalHandler(handler: ApprovalHandler): void {\n\t\tapprovalHandler = handler;\n\t}\n\n\treturn {\n\t\tregister,\n\t\tcheck,\n\t\texecute,\n\t\tsetApprovalHandler,\n\t\tgetCapability: (name) => capabilities.get(name),\n\t\tgetCapabilities: () => [...capabilities.values()],\n\t};\n}\n\nfunction createDeniedAuditEntry(\n\tcapability: string,\n\taction: string,\n\tparams: Record<string, unknown>,\n\treason: string,\n\trequestedBy: string,\n): AuditEntry {\n\treturn {\n\t\tid: uuidv4(),\n\t\ttimestamp: new Date(),\n\t\tcapability,\n\t\taction,\n\t\tresource: (params.path ?? params.command ?? params.url ?? '') as string,\n\t\tparams,\n\t\tdecision: 'rule-denied',\n\t\tresult: 'denied',\n\t\terror: reason,\n\t\tdurationMs: 0,\n\t\trequestedBy,\n\t};\n}\n","import { execFile } from 'node:child_process';\nimport { v4 as uuidv4 } from 'uuid';\nimport { createLogger } from '../utils/logger.js';\nimport type {\n\tAuditEntry,\n\tCapability,\n\tCapabilityResult,\n\tPermissionDecision,\n\tPermissionRequest,\n} from './types.js';\n\nconst logger = createLogger('sandbox:shell');\n\nexport interface ShellSandboxConfig {\n\tsafeCommands: string[];\n\taskCommands: string[];\n\tdeniedPatterns: string[];\n}\n\ntype SegmentClassification = 'safe' | 'ask' | 'denied' | 'unknown';\n\nconst SHELL_EXPANSION_PATTERN = /`|\\$\\(|\\$\\{|<\\(|>\\(|\\n/;\nconst SHELL_REDIRECTION_PATTERN = /(^|\\s)(?:>|>>|<|<<|1>|1>>|2>|2>>|&>)/;\n\n/**\n * Splits a compound command string into individual segments by\n * pipe (|), semicolon (;), and logical operators (&& and ||).\n */\nexport function parseCommand(command: string): string[] {\n\t// Split on |, ;, &&, || ‚Äî keeping the delimiters out\n\tconst segments = command.split(/\\s*(?:\\|\\||&&|[|;])\\s*/);\n\treturn segments.map((s) => s.trim()).filter((s) => s.length > 0);\n}\n\n/**\n * Classifies a single command segment against the sandbox config.\n *\n * Priority: denied > safe > ask > unknown\n */\nexport function classifySegment(\n\tsegment: string,\n\tconfig: ShellSandboxConfig,\n): SegmentClassification {\n\tconst trimmed = segment.trim();\n\tconst lowered = trimmed.toLowerCase();\n\n\t// Check denied patterns first ‚Äî substring match\n\tfor (const pattern of config.deniedPatterns) {\n\t\tif (lowered.includes(pattern.toLowerCase())) {\n\t\t\treturn 'denied';\n\t\t}\n\t}\n\n\t// Shell expansions and redirections are never auto-approved.\n\t// They can introduce side effects or hidden command execution.\n\tif (SHELL_EXPANSION_PATTERN.test(trimmed) || SHELL_REDIRECTION_PATTERN.test(trimmed)) {\n\t\treturn 'ask';\n\t}\n\n\t// Extract the command base (first word, or first two words for compound commands like \"git status\")\n\tconst words = trimmed.split(/\\s+/);\n\n\t// Check safe commands ‚Äî match against command base\n\tfor (const safe of config.safeCommands) {\n\t\tconst safeWords = safe.split(/\\s+/);\n\t\tif (safeWords.length <= words.length) {\n\t\t\tconst baseSlice = words.slice(0, safeWords.length).join(' ');\n\t\t\tif (baseSlice === safe) {\n\t\t\t\treturn 'safe';\n\t\t\t}\n\t\t}\n\t}\n\n\t// Check ask commands ‚Äî match against command base\n\tfor (const ask of config.askCommands) {\n\t\tconst askWords = ask.split(/\\s+/);\n\t\tif (askWords.length <= words.length) {\n\t\t\tconst baseSlice = words.slice(0, askWords.length).join(' ');\n\t\t\tif (baseSlice === ask) {\n\t\t\t\treturn 'ask';\n\t\t\t}\n\t\t}\n\t}\n\n\treturn 'unknown';\n}\n\ninterface ShellExecOutput {\n\tstdout: string;\n\tstderr: string;\n\texitCode: number;\n}\n\nconst MAX_AUDIT_OUTPUT_LENGTH = 1024;\nconst DEFAULT_TIMEOUT_MS = 30_000;\nconst MAX_BUFFER_BYTES = 1024 * 1024;\n\n/**\n * Creates a Shell capability for the sandbox.\n *\n * Commands are classified into safe (auto-approved), ask (user-approved),\n * denied (blocked), or unknown (treated as ask). Compound commands\n * (pipes, chains) are split and each segment is classified independently;\n * the most restrictive classification wins.\n */\nexport function createShellCapability(config: ShellSandboxConfig): Capability {\n\tfunction checkPermission(request: PermissionRequest): PermissionDecision {\n\t\tconst command = request.resource;\n\t\tconst segments = parseCommand(command);\n\n\t\tif (segments.length === 0) {\n\t\t\treturn { allowed: false, reason: 'Empty command', level: 'denied' };\n\t\t}\n\n\t\tlet needsApproval = false;\n\n\t\t// Compound commands are never auto-approved.\n\t\tif (segments.length > 1) {\n\t\t\tneedsApproval = true;\n\t\t}\n\n\t\tfor (const segment of segments) {\n\t\t\tconst classification = classifySegment(segment, config);\n\n\t\t\tif (classification === 'denied') {\n\t\t\t\tlogger.warn('Shell command denied', {\n\t\t\t\t\tcommand,\n\t\t\t\t\tsegment,\n\t\t\t\t\trequestedBy: request.requestedBy,\n\t\t\t\t});\n\t\t\t\treturn {\n\t\t\t\t\tallowed: false,\n\t\t\t\t\treason: `Command segment denied: \"${segment}\"`,\n\t\t\t\t\tlevel: 'denied',\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tif (classification === 'ask' || classification === 'unknown') {\n\t\t\t\tneedsApproval = true;\n\t\t\t}\n\t\t}\n\n\t\tif (needsApproval) {\n\t\t\treturn { allowed: true, level: 'user-approved' };\n\t\t}\n\n\t\treturn { allowed: true, level: 'auto' };\n\t}\n\n\tasync function execute(\n\t\taction: string,\n\t\tparams: Record<string, unknown>,\n\t): Promise<CapabilityResult> {\n\t\tconst command = params.command as string | undefined;\n\t\tconst cwd = params.cwd as string | undefined;\n\t\tconst timeout = (params.timeout as number | undefined) ?? DEFAULT_TIMEOUT_MS;\n\n\t\tif (!command || typeof command !== 'string') {\n\t\t\tconst entry = createErrorAuditEntry(\n\t\t\t\taction,\n\t\t\t\tcommand ?? '',\n\t\t\t\t'Missing or invalid command parameter',\n\t\t\t);\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: 'Missing or invalid command parameter',\n\t\t\t\tauditEntry: entry,\n\t\t\t\tdurationMs: 0,\n\t\t\t};\n\t\t}\n\n\t\t// Check permission before executing\n\t\tconst request: PermissionRequest = {\n\t\t\tcapability: 'shell',\n\t\t\taction,\n\t\t\tresource: command,\n\t\t\trequestedBy: (params.requestedBy as string | undefined) ?? 'agent',\n\t\t};\n\t\tconst decision = checkPermission(request);\n\n\t\tif (!decision.allowed) {\n\t\t\tconst entry: AuditEntry = {\n\t\t\t\tid: uuidv4(),\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tcapability: 'shell',\n\t\t\t\taction,\n\t\t\t\tresource: command,\n\t\t\t\tparams: { command, cwd, timeout },\n\t\t\t\tdecision: 'rule-denied',\n\t\t\t\tresult: 'denied',\n\t\t\t\terror: decision.reason,\n\t\t\t\tdurationMs: 0,\n\t\t\t\trequestedBy: request.requestedBy,\n\t\t\t};\n\n\t\t\tlogger.warn('Shell execution denied', { command, reason: decision.reason });\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: decision.reason,\n\t\t\t\tauditEntry: entry,\n\t\t\t\tdurationMs: 0,\n\t\t\t};\n\t\t}\n\n\t\tif (decision.level === 'user-approved' && params.__approvedByUser !== true) {\n\t\t\tconst entry: AuditEntry = {\n\t\t\t\tid: uuidv4(),\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tcapability: 'shell',\n\t\t\t\taction,\n\t\t\t\tresource: command,\n\t\t\t\tparams: { command, cwd, timeout },\n\t\t\t\tdecision: 'rule-denied',\n\t\t\t\tresult: 'denied',\n\t\t\t\terror: 'Missing explicit user approval token',\n\t\t\t\tdurationMs: 0,\n\t\t\t\trequestedBy: request.requestedBy,\n\t\t\t};\n\n\t\t\tlogger.warn('Shell execution blocked: missing approval token', { command });\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: 'Missing explicit user approval token',\n\t\t\t\tauditEntry: entry,\n\t\t\t\tdurationMs: 0,\n\t\t\t};\n\t\t}\n\n\t\tconst startTime = Date.now();\n\n\t\ttry {\n\t\t\tconst result = await executeShellCommand(command, { cwd, timeout });\n\t\t\tconst durationMs = Date.now() - startTime;\n\n\t\t\tconst outputStr = formatOutput(result);\n\t\t\tconst truncatedOutput = outputStr.slice(0, MAX_AUDIT_OUTPUT_LENGTH);\n\n\t\t\tconst entry: AuditEntry = {\n\t\t\t\tid: uuidv4(),\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tcapability: 'shell',\n\t\t\t\taction,\n\t\t\t\tresource: command,\n\t\t\t\tparams: { command, cwd, timeout },\n\t\t\t\tdecision: decision.level === 'auto' ? 'auto-approved' : 'user-approved',\n\t\t\t\tresult: result.exitCode === 0 ? 'success' : 'error',\n\t\t\t\toutput: truncatedOutput,\n\t\t\t\terror: result.exitCode !== 0 ? result.stderr.slice(0, MAX_AUDIT_OUTPUT_LENGTH) : undefined,\n\t\t\t\tdurationMs,\n\t\t\t\trequestedBy: request.requestedBy,\n\t\t\t};\n\n\t\t\tlogger.info('Shell command executed', {\n\t\t\t\tcommand,\n\t\t\t\texitCode: result.exitCode,\n\t\t\t\tdurationMs,\n\t\t\t});\n\n\t\t\treturn {\n\t\t\t\tsuccess: result.exitCode === 0,\n\t\t\t\toutput: {\n\t\t\t\t\tstdout: result.stdout,\n\t\t\t\t\tstderr: result.stderr,\n\t\t\t\t\texitCode: result.exitCode,\n\t\t\t\t},\n\t\t\t\terror: result.exitCode !== 0 ? result.stderr : undefined,\n\t\t\t\tauditEntry: entry,\n\t\t\t\tdurationMs,\n\t\t\t};\n\t\t} catch (err: unknown) {\n\t\t\tconst durationMs = Date.now() - startTime;\n\t\t\tconst errorMessage = err instanceof Error ? err.message : String(err);\n\n\t\t\tconst entry: AuditEntry = {\n\t\t\t\tid: uuidv4(),\n\t\t\t\ttimestamp: new Date(),\n\t\t\t\tcapability: 'shell',\n\t\t\t\taction,\n\t\t\t\tresource: command,\n\t\t\t\tparams: { command, cwd, timeout },\n\t\t\t\tdecision: decision.level === 'auto' ? 'auto-approved' : 'user-approved',\n\t\t\t\tresult: 'error',\n\t\t\t\terror: errorMessage.slice(0, MAX_AUDIT_OUTPUT_LENGTH),\n\t\t\t\tdurationMs,\n\t\t\t\trequestedBy: request.requestedBy,\n\t\t\t};\n\n\t\t\tlogger.error('Shell command failed', { command, error: errorMessage, durationMs });\n\n\t\t\treturn {\n\t\t\t\tsuccess: false,\n\t\t\t\toutput: null,\n\t\t\t\terror: errorMessage,\n\t\t\t\tauditEntry: entry,\n\t\t\t\tdurationMs,\n\t\t\t};\n\t\t}\n\t}\n\n\treturn {\n\t\tname: 'shell',\n\t\tdescription: 'Execute shell commands with safety classification',\n\t\tcheckPermission,\n\t\texecute,\n\t};\n}\n\nfunction executeShellCommand(\n\tcommand: string,\n\toptions: { cwd?: string; timeout: number },\n): Promise<ShellExecOutput> {\n\treturn new Promise((resolve, reject) => {\n\t\texecFile(\n\t\t\t'/bin/sh',\n\t\t\t['-c', command],\n\t\t\t{\n\t\t\t\ttimeout: options.timeout,\n\t\t\t\tmaxBuffer: MAX_BUFFER_BYTES,\n\t\t\t\tcwd: options.cwd,\n\t\t\t},\n\t\t\t(error, stdout, stderr) => {\n\t\t\t\tif (error && !('code' in error)) {\n\t\t\t\t\t// Process-level error (e.g. timeout, spawn failure)\n\t\t\t\t\treject(error);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Normal completion ‚Äî exitCode may be non-zero\n\t\t\t\tconst exitCode = error && 'code' in error ? (error.code as number) : 0;\n\t\t\t\tresolve({\n\t\t\t\t\tstdout: String(stdout),\n\t\t\t\t\tstderr: String(stderr),\n\t\t\t\t\texitCode,\n\t\t\t\t});\n\t\t\t},\n\t\t);\n\t});\n}\n\nfunction formatOutput(result: ShellExecOutput): string {\n\tconst parts: string[] = [];\n\tif (result.stdout) {\n\t\tparts.push(`stdout: ${result.stdout}`);\n\t}\n\tif (result.stderr) {\n\t\tparts.push(`stderr: ${result.stderr}`);\n\t}\n\tparts.push(`exitCode: ${result.exitCode}`);\n\treturn parts.join('\\n');\n}\n\nfunction createErrorAuditEntry(action: string, resource: string, error: string): AuditEntry {\n\treturn {\n\t\tid: uuidv4(),\n\t\ttimestamp: new Date(),\n\t\tcapability: 'shell',\n\t\taction,\n\t\tresource,\n\t\tdecision: 'error',\n\t\tresult: 'error',\n\t\terror,\n\t\tdurationMs: 0,\n\t\trequestedBy: 'agent',\n\t};\n}\n","import { v4 as uuidv4 } from 'uuid';\nimport type { MemoryStore } from '../memory/store.js';\nimport type { AuditEntry } from '../sandbox/types.js';\nimport { createLogger } from '../utils/logger.js';\nimport type {\n\tJob,\n\tJobLastResult,\n\tJobRunContext,\n\tJobRunResult,\n\tNewJob,\n\tScheduleParser,\n} from './types.js';\n\nconst logger = createLogger('scheduler:cron');\n\ninterface AuditStoreLike {\n\tlog(entry: AuditEntry): void;\n}\n\ninterface ScheduledTaskLike {\n\tstart(): void;\n\tstop(): void;\n\tdestroy(): void;\n\tgetNextRun?(): Date | null;\n}\n\ninterface CronApi {\n\tschedule(\n\t\texpression: string,\n\t\tcallback: () => void | Promise<void>,\n\t\toptions?: { timezone?: string },\n\t): ScheduledTaskLike;\n\tvalidate(expression: string): boolean;\n}\n\ninterface JobRow {\n\tid: string;\n\tname: string;\n\ttype: string;\n\tschedule: string | null;\n\ttask: string;\n\tenabled: number | boolean;\n\tlast_run: string | null;\n\tnext_run: string | null;\n\trun_count: number | null;\n\tlast_result: string | null;\n}\n\ninterface CreateCronSchedulerOptions {\n\tstore: MemoryStore;\n\ttimezone: string;\n\trunTask: (task: string, context: JobRunContext) => Promise<JobRunResult>;\n\tparser?: ScheduleParser;\n\tauditStore?: AuditStoreLike;\n\tcronApi?: CronApi;\n}\n\ninterface CronScheduler {\n\tstart(): Promise<void>;\n\tstop(): void;\n\tcreateJob(job: NewJob): Promise<string>;\n\tlistJobs(): Promise<Job[]>;\n\tgetJob(id: string): Promise<Job | null>;\n\tenableJob(id: string): Promise<void>;\n\tdisableJob(id: string): Promise<void>;\n\tdeleteJob(id: string): Promise<void>;\n\trunJobNow(id: string): Promise<JobRunResult>;\n\tparseSchedule(schedule: string): Promise<string>;\n}\n\ntype CronModule = typeof import('node-cron');\n\nlet cachedCronApi: CronApi | null = null;\n\nasync function loadDefaultCronApi(): Promise<CronApi> {\n\tif (cachedCronApi) return cachedCronApi;\n\tconst module = (await import('node-cron')) as CronModule;\n\tcachedCronApi = {\n\t\tschedule: module.schedule,\n\t\tvalidate: module.validate,\n\t};\n\treturn cachedCronApi;\n}\n\nfunction parseTimestamp(value: string | null): Date | null {\n\treturn value ? new Date(value) : null;\n}\n\nfunction parseLastResult(value: string | null): JobLastResult | null {\n\tif (!value) return null;\n\ttry {\n\t\treturn JSON.parse(value) as JobLastResult;\n\t} catch {\n\t\treturn null;\n\t}\n}\n\nfunction mapJobRow(row: JobRow): Job {\n\treturn {\n\t\tid: row.id,\n\t\tname: row.name,\n\t\ttype: row.type,\n\t\tschedule: row.schedule ?? '',\n\t\ttask: row.task,\n\t\tenabled: Boolean(row.enabled),\n\t\tlastRun: parseTimestamp(row.last_run),\n\t\tnextRun: parseTimestamp(row.next_run),\n\t\trunCount: row.run_count ?? 0,\n\t\tlastResult: parseLastResult(row.last_result),\n\t};\n}\n\nfunction fallbackNaturalScheduleToCron(schedule: string): string | null {\n\tconst normalized = schedule.trim().toLowerCase();\n\tif (normalized === 'every minute') return '* * * * *';\n\tif (normalized === 'every hour' || normalized === 'hourly') return '0 * * * *';\n\tif (normalized === 'every day' || normalized === 'daily') return '0 9 * * *';\n\tif (normalized === 'every week' || normalized === 'weekly') return '0 9 * * 1';\n\tif (normalized === 'every month' || normalized === 'monthly') return '0 9 1 * *';\n\n\tconst everyMinutes = normalized.match(/^every\\s+(\\d+)\\s+minutes?$/);\n\tif (everyMinutes?.[1]) {\n\t\tconst value = Number.parseInt(everyMinutes[1], 10);\n\t\tif (value >= 1 && value <= 59) return `*/${value} * * * *`;\n\t}\n\n\tconst everyHours = normalized.match(/^every\\s+(\\d+)\\s+hours?$/);\n\tif (everyHours?.[1]) {\n\t\tconst value = Number.parseInt(everyHours[1], 10);\n\t\tif (value >= 1 && value <= 23) return `0 */${value} * * *`;\n\t}\n\n\tconst dailyAt = normalized.match(/^every day at (\\d{1,2}):(\\d{2})$/);\n\tif (dailyAt?.[1] && dailyAt[2]) {\n\t\tconst hour = Number.parseInt(dailyAt[1], 10);\n\t\tconst minute = Number.parseInt(dailyAt[2], 10);\n\t\tif (hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {\n\t\t\treturn `${minute} ${hour} * * *`;\n\t\t}\n\t}\n\n\tconst weeklyAt = normalized.match(\n\t\t/^every (monday|tuesday|wednesday|thursday|friday|saturday|sunday) at (\\d{1,2}):(\\d{2})$/,\n\t);\n\tif (weeklyAt?.[1] && weeklyAt[2] && weeklyAt[3]) {\n\t\tconst dayMap: Record<string, number> = {\n\t\t\tsunday: 0,\n\t\t\tmonday: 1,\n\t\t\ttuesday: 2,\n\t\t\twednesday: 3,\n\t\t\tthursday: 4,\n\t\t\tfriday: 5,\n\t\t\tsaturday: 6,\n\t\t};\n\t\tconst day = dayMap[weeklyAt[1]];\n\t\tconst hour = Number.parseInt(weeklyAt[2], 10);\n\t\tconst minute = Number.parseInt(weeklyAt[3], 10);\n\t\tif (day !== undefined && hour >= 0 && hour <= 23 && minute >= 0 && minute <= 59) {\n\t\t\treturn `${minute} ${hour} * * ${day}`;\n\t\t}\n\t}\n\n\treturn null;\n}\n\nfunction nextRunFromTask(task: ScheduledTaskLike): Date | null {\n\tconst next = task.getNextRun?.();\n\tif (!next) return null;\n\treturn Number.isNaN(next.getTime()) ? null : next;\n}\n\nexport async function createCronScheduler(\n\toptions: CreateCronSchedulerOptions,\n): Promise<CronScheduler> {\n\tconst cronApi = options.cronApi ?? (await loadDefaultCronApi());\n\tconst activeTasks = new Map<string, ScheduledTaskLike>();\n\n\tasync function parseSchedule(schedule: string): Promise<string> {\n\t\tconst trimmed = schedule.trim();\n\t\tif (trimmed.length === 0) {\n\t\t\tthrow new Error('Schedule cannot be empty');\n\t\t}\n\n\t\tif (cronApi.validate(trimmed)) {\n\t\t\treturn trimmed;\n\t\t}\n\n\t\tlet parsedByLlm: string | null = null;\n\t\tif (options.parser) {\n\t\t\tparsedByLlm = await options.parser.parseNaturalLanguage(trimmed);\n\t\t\tif (parsedByLlm && cronApi.validate(parsedByLlm)) {\n\t\t\t\treturn parsedByLlm;\n\t\t\t}\n\t\t}\n\n\t\tconst fallback = fallbackNaturalScheduleToCron(trimmed);\n\t\tif (fallback && cronApi.validate(fallback)) {\n\t\t\treturn fallback;\n\t\t}\n\n\t\tthrow new Error(\n\t\t\t`Invalid schedule \"${schedule}\". Use a cron expression or natural format like \"every 30 minutes\".`,\n\t\t);\n\t}\n\n\tfunction readJobRow(id: string): JobRow | null {\n\t\tconst row = options.store.get<JobRow>(\n\t\t\t`SELECT id, name, type, schedule, task, enabled, last_run, next_run, run_count, last_result\n\t\t\t FROM jobs\n\t\t\t WHERE id = ?`,\n\t\t\t[id],\n\t\t);\n\t\treturn row ?? null;\n\t}\n\n\tfunction registerJob(row: JobRow): void {\n\t\tif (!row.schedule || !row.enabled) return;\n\t\tif (activeTasks.has(row.id)) return;\n\n\t\tconst task = cronApi.schedule(\n\t\t\trow.schedule,\n\t\t\tasync () => {\n\t\t\t\ttry {\n\t\t\t\t\tawait runJobNow(row.id);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tlogger.error('Scheduled job execution failed', {\n\t\t\t\t\t\tid: row.id,\n\t\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\t{ timezone: options.timezone },\n\t\t);\n\t\tactiveTasks.set(row.id, task);\n\n\t\tconst nextRun = nextRunFromTask(task)?.toISOString() ?? null;\n\t\toptions.store.run('UPDATE jobs SET next_run = ? WHERE id = ?', [nextRun, row.id]);\n\t}\n\n\tfunction unregisterJob(id: string): void {\n\t\tconst task = activeTasks.get(id);\n\t\tif (!task) return;\n\t\ttask.stop();\n\t\ttask.destroy();\n\t\tactiveTasks.delete(id);\n\t}\n\n\tasync function listJobs(): Promise<Job[]> {\n\t\tconst rows = options.store.all<JobRow>(\n\t\t\t`SELECT id, name, type, schedule, task, enabled, last_run, next_run, run_count, last_result\n\t\t\t FROM jobs\n\t\t\t ORDER BY name ASC`,\n\t\t);\n\t\treturn rows.map(mapJobRow);\n\t}\n\n\tasync function getJob(id: string): Promise<Job | null> {\n\t\tconst row = readJobRow(id);\n\t\treturn row ? mapJobRow(row) : null;\n\t}\n\n\tasync function runJobNow(id: string): Promise<JobRunResult> {\n\t\tconst row = readJobRow(id);\n\t\tif (!row) {\n\t\t\tthrow new Error(`Job not found: ${id}`);\n\t\t}\n\n\t\tconst job = mapJobRow(row);\n\t\tconst startedAt = Date.now();\n\t\tconst nowIso = new Date().toISOString();\n\n\t\tlet result: JobRunResult;\n\t\ttry {\n\t\t\tresult = await options.runTask(job.task, {\n\t\t\t\tjobId: job.id,\n\t\t\t\tjobName: job.name,\n\t\t\t\ttask: job.task,\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tresult = {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t};\n\t\t}\n\n\t\tconst task = activeTasks.get(job.id);\n\t\tconst nextRunIso = task ? (nextRunFromTask(task)?.toISOString() ?? null) : null;\n\t\tconst finishedAt = new Date().toISOString();\n\t\tconst lastResult: JobLastResult = {\n\t\t\tsuccess: result.success,\n\t\t\toutput: result.output,\n\t\t\terror: result.error,\n\t\t\tfinishedAt,\n\t\t};\n\n\t\toptions.store.run(\n\t\t\t`UPDATE jobs\n\t\t\t SET last_run = ?, next_run = ?, run_count = COALESCE(run_count, 0) + 1, last_result = ?\n\t\t\t WHERE id = ?`,\n\t\t\t[nowIso, nextRunIso, JSON.stringify(lastResult), job.id],\n\t\t);\n\n\t\toptions.auditStore?.log({\n\t\t\tid: uuidv4(),\n\t\t\ttimestamp: new Date(),\n\t\t\tcapability: 'scheduler',\n\t\t\taction: 'run_job',\n\t\t\tresource: job.id,\n\t\t\tparams: {\n\t\t\t\tjobId: job.id,\n\t\t\t\tjobName: job.name,\n\t\t\t\ttask: job.task,\n\t\t\t},\n\t\t\tdecision: 'auto-approved',\n\t\t\tresult: result.success ? 'success' : 'error',\n\t\t\toutput: JSON.stringify(result.output ?? null).slice(0, 1024),\n\t\t\terror: result.error,\n\t\t\tdurationMs: Date.now() - startedAt,\n\t\t\trequestedBy: 'scheduler',\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tasync function createJob(job: NewJob): Promise<string> {\n\t\tif (job.task.trim().length === 0) {\n\t\t\tthrow new Error('Task cannot be empty');\n\t\t}\n\t\tconst id = uuidv4();\n\t\tconst schedule = await parseSchedule(job.schedule);\n\t\tconst name = job.name?.trim() ? job.name.trim() : `job-${id.slice(0, 8)}`;\n\t\tconst type = job.type?.trim() ? job.type.trim() : 'cron';\n\n\t\toptions.store.run(\n\t\t\t`INSERT INTO jobs (id, name, type, schedule, task, enabled, run_count)\n\t\t\t VALUES (?, ?, ?, ?, ?, 1, 0)`,\n\t\t\t[id, name, type, schedule, job.task],\n\t\t);\n\n\t\tconst row = readJobRow(id);\n\t\tif (row) registerJob(row);\n\n\t\tlogger.info('Scheduled job created', { id, name, schedule });\n\t\treturn id;\n\t}\n\n\tasync function enableJob(id: string): Promise<void> {\n\t\tconst row = readJobRow(id);\n\t\tif (!row) throw new Error(`Job not found: ${id}`);\n\t\toptions.store.run('UPDATE jobs SET enabled = 1 WHERE id = ?', [id]);\n\t\tregisterJob({ ...row, enabled: 1 });\n\t}\n\n\tasync function disableJob(id: string): Promise<void> {\n\t\tconst row = readJobRow(id);\n\t\tif (!row) throw new Error(`Job not found: ${id}`);\n\t\toptions.store.run('UPDATE jobs SET enabled = 0, next_run = NULL WHERE id = ?', [id]);\n\t\tunregisterJob(id);\n\t}\n\n\tasync function deleteJob(id: string): Promise<void> {\n\t\tunregisterJob(id);\n\t\toptions.store.run('DELETE FROM jobs WHERE id = ?', [id]);\n\t}\n\n\tasync function start(): Promise<void> {\n\t\tconst rows = options.store.all<JobRow>(\n\t\t\t`SELECT id, name, type, schedule, task, enabled, last_run, next_run, run_count, last_result\n\t\t\t FROM jobs\n\t\t\t WHERE enabled = 1`,\n\t\t);\n\t\tfor (const row of rows) {\n\t\t\tregisterJob(row);\n\t\t}\n\t}\n\n\tfunction stop(): void {\n\t\tfor (const task of activeTasks.values()) {\n\t\t\ttask.stop();\n\t\t\ttask.destroy();\n\t\t}\n\t\tactiveTasks.clear();\n\t}\n\n\treturn {\n\t\tstart,\n\t\tstop,\n\t\tcreateJob,\n\t\tlistJobs,\n\t\tgetJob,\n\t\tenableJob,\n\t\tdisableJob,\n\t\tdeleteJob,\n\t\trunJobNow,\n\t\tparseSchedule,\n\t};\n}\n\nexport type { CronScheduler, CreateCronSchedulerOptions };\n","import { readFile } from 'node:fs/promises';\nimport os from 'node:os';\nimport { v4 as uuidv4 } from 'uuid';\nimport type { AuditEntry } from '../sandbox/types.js';\nimport { createLogger } from '../utils/logger.js';\nimport type { JobRunResult } from './types.js';\n\nconst logger = createLogger('scheduler:heartbeat');\n\ninterface AuditStoreLike {\n\tlog(entry: AuditEntry): void;\n}\n\nexport interface HeartbeatRunReport {\n\tstartedAt: string;\n\tfinishedAt: string;\n\tchecklistPath: string;\n\tchecklistLength: number;\n\tsystemState: {\n\t\tplatform: string;\n\t\tuptimeSeconds: number;\n\t\tloadAverage: number[];\n\t\tfreeMemoryBytes: number;\n\t\ttotalMemoryBytes: number;\n\t};\n\tresult: JobRunResult;\n}\n\ninterface CreateHeartbeatOptions {\n\tintervalMinutes?: number;\n\theartbeatFile: string;\n\trunTask: (prompt: string) => Promise<JobRunResult>;\n\tauditStore?: AuditStoreLike;\n\tonRun?: (report: HeartbeatRunReport) => void;\n\treadChecklist?: (path: string) => Promise<string>;\n}\n\nexport interface HeartbeatController {\n\tstart(): void;\n\tstop(): void;\n\trunOnce(): Promise<HeartbeatRunReport>;\n\tisRunning(): boolean;\n}\n\nfunction defaultReadChecklist(path: string): Promise<string> {\n\treturn readFile(path, 'utf-8');\n}\n\nfunction collectSystemState() {\n\tconst safeNumber = (fn: () => number, fallback = 0): number => {\n\t\ttry {\n\t\t\treturn fn();\n\t\t} catch {\n\t\t\treturn fallback;\n\t\t}\n\t};\n\tconst safeNumbers = (fn: () => number[], fallback: number[] = [0, 0, 0]): number[] => {\n\t\ttry {\n\t\t\treturn fn();\n\t\t} catch {\n\t\t\treturn fallback;\n\t\t}\n\t};\n\n\treturn {\n\t\tplatform: process.platform,\n\t\tuptimeSeconds: Math.floor(safeNumber(() => os.uptime(), 0)),\n\t\tloadAverage: safeNumbers(() => os.loadavg()),\n\t\tfreeMemoryBytes: safeNumber(() => os.freemem(), 0),\n\t\ttotalMemoryBytes: safeNumber(() => os.totalmem(), 0),\n\t};\n}\n\nfunction buildHeartbeatPrompt(\n\tchecklist: string,\n\tsystemState: ReturnType<typeof collectSystemState>,\n): string {\n\treturn [\n\t\t'Review these heartbeat items and take action if needed.',\n\t\t'',\n\t\t'Checklist:',\n\t\tchecklist.trim(),\n\t\t'',\n\t\t'Current system state:',\n\t\tJSON.stringify(systemState, null, 2),\n\t].join('\\n');\n}\n\nexport function createHeartbeat(options: CreateHeartbeatOptions): HeartbeatController {\n\tconst intervalMs = Math.max(1, options.intervalMinutes ?? 30) * 60_000;\n\tconst readChecklist = options.readChecklist ?? defaultReadChecklist;\n\tlet timer: NodeJS.Timeout | null = null;\n\tlet running = false;\n\n\tasync function runOnce(): Promise<HeartbeatRunReport> {\n\t\tconst startedAt = new Date();\n\t\tlet checklist = '';\n\t\ttry {\n\t\t\tchecklist = await readChecklist(options.heartbeatFile);\n\t\t} catch {\n\t\t\tchecklist =\n\t\t\t\t'# Heartbeat checklist missing\\n- No checklist file found. Ask user to create one.';\n\t\t}\n\n\t\tconst systemState = collectSystemState();\n\t\tconst prompt = buildHeartbeatPrompt(checklist, systemState);\n\t\tlet result: JobRunResult;\n\t\ttry {\n\t\t\tresult = await options.runTask(prompt);\n\t\t} catch (error) {\n\t\t\tresult = {\n\t\t\t\tsuccess: false,\n\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t};\n\t\t}\n\n\t\tconst finishedAt = new Date();\n\t\tconst report: HeartbeatRunReport = {\n\t\t\tstartedAt: startedAt.toISOString(),\n\t\t\tfinishedAt: finishedAt.toISOString(),\n\t\t\tchecklistPath: options.heartbeatFile,\n\t\t\tchecklistLength: checklist.length,\n\t\t\tsystemState,\n\t\t\tresult,\n\t\t};\n\n\t\toptions.auditStore?.log({\n\t\t\tid: uuidv4(),\n\t\t\ttimestamp: finishedAt,\n\t\t\tcapability: 'heartbeat',\n\t\t\taction: 'run',\n\t\t\tresource: options.heartbeatFile,\n\t\t\tparams: {\n\t\t\t\tchecklistLength: checklist.length,\n\t\t\t\tsystemState,\n\t\t\t},\n\t\t\tdecision: 'auto-approved',\n\t\t\tresult: result.success ? 'success' : 'error',\n\t\t\toutput: JSON.stringify(result.output ?? null).slice(0, 1024),\n\t\t\terror: result.error,\n\t\t\tdurationMs: finishedAt.getTime() - startedAt.getTime(),\n\t\t\trequestedBy: 'heartbeat',\n\t\t});\n\n\t\toptions.onRun?.(report);\n\t\treturn report;\n\t}\n\n\tfunction start(): void {\n\t\tif (running) return;\n\t\trunning = true;\n\t\ttimer = setInterval(() => {\n\t\t\trunOnce().catch((error) => {\n\t\t\t\tlogger.error('Heartbeat run failed', {\n\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t});\n\t\t\t});\n\t\t}, intervalMs);\n\t}\n\n\tfunction stop(): void {\n\t\trunning = false;\n\t\tif (timer) {\n\t\t\tclearInterval(timer);\n\t\t\ttimer = null;\n\t\t}\n\t}\n\n\treturn {\n\t\tstart,\n\t\tstop,\n\t\trunOnce,\n\t\tisRunning: () => running,\n\t};\n}\n","import { type FSWatcher, watch } from 'node:fs';\nimport { createServer, type IncomingMessage, type Server, type ServerResponse } from 'node:http';\nimport { createLogger } from '../utils/logger.js';\nimport type { JobRunResult } from './types.js';\n\nconst logger = createLogger('scheduler:triggers');\n\ntype FileWatcherEvent = 'add' | 'change' | 'unlink' | 'rename';\n\ninterface FileWatcherConfig {\n\tpath: string;\n\tevents: FileWatcherEvent[];\n\ttask: string;\n}\n\ninterface WebhookHookConfig {\n\tid: string;\n\ttoken: string;\n\ttask: string;\n}\n\ninterface WebhookConfig {\n\tenabled: boolean;\n\thost?: string;\n\tport: number;\n\thooks: WebhookHookConfig[];\n}\n\ninterface TriggerTaskContext {\n\tsource: 'file_watcher' | 'webhook';\n\twatcherPath?: string;\n\tfilename?: string;\n\thookId?: string;\n\tpayload?: unknown;\n}\n\ninterface WatcherLike {\n\tclose(): void;\n}\n\ntype WatchFactory = (\n\tpath: string,\n\tlistener: (eventType: string, filename: string | Buffer | null) => void,\n) => WatcherLike;\n\ninterface CreateTriggerEngineOptions {\n\tfileWatchers?: FileWatcherConfig[];\n\twebhooks?: WebhookConfig;\n\trunTask: (task: string, context: TriggerTaskContext) => Promise<JobRunResult | undefined>;\n\twatchFactory?: WatchFactory;\n}\n\ninterface TriggerEngine {\n\tstart(): Promise<void>;\n\tstop(): Promise<void>;\n\tgetWebhookPort(): number | null;\n}\n\ninterface WebhookDispatchRequest {\n\tmethod: string;\n\turl: string;\n\tauthorizationHeader?: string;\n\tbody: string;\n}\n\ninterface WebhookDispatchResponse {\n\tstatus: number;\n\tbody: { error?: string; accepted?: boolean };\n}\n\nfunction eventMatches(eventType: string, configured: FileWatcherEvent[]): boolean {\n\tif (eventType === 'change') {\n\t\treturn configured.includes('change');\n\t}\n\tif (eventType === 'rename') {\n\t\treturn (\n\t\t\tconfigured.includes('add') || configured.includes('unlink') || configured.includes('rename')\n\t\t);\n\t}\n\treturn false;\n}\n\nfunction fillTemplate(template: string, values: Record<string, string>): string {\n\tlet output = template;\n\tfor (const [key, value] of Object.entries(values)) {\n\t\toutput = output.replaceAll(`{${key}}`, value);\n\t}\n\treturn output;\n}\n\nasync function readBody(req: IncomingMessage): Promise<string> {\n\tconst chunks: Buffer[] = [];\n\tfor await (const chunk of req) {\n\t\tchunks.push(Buffer.isBuffer(chunk) ? chunk : Buffer.from(chunk));\n\t}\n\treturn Buffer.concat(chunks).toString('utf-8');\n}\n\nfunction json(res: ServerResponse, statusCode: number, payload: unknown): void {\n\tres.statusCode = statusCode;\n\tres.setHeader('content-type', 'application/json');\n\tres.end(JSON.stringify(payload));\n}\n\nfunction defaultWatchFactory(\n\tpath: string,\n\tlistener: (eventType: string, filename: string | Buffer | null) => void,\n): WatcherLike {\n\treturn watch(path, listener) as FSWatcher;\n}\n\nfunction parsePayload(body: string): unknown {\n\tif (!body) return {};\n\ttry {\n\t\treturn JSON.parse(body);\n\t} catch {\n\t\treturn body;\n\t}\n}\n\nexport function createWebhookRequestHandler(options: {\n\thooks: WebhookHookConfig[];\n\trunTask: (task: string, context: TriggerTaskContext) => Promise<JobRunResult | undefined>;\n}) {\n\tconst hookMap = new Map(options.hooks.map((hook) => [hook.id, hook]));\n\n\treturn async function handle(request: WebhookDispatchRequest): Promise<WebhookDispatchResponse> {\n\t\tif (request.method !== 'POST') {\n\t\t\treturn { status: 404, body: { error: 'Not found' } };\n\t\t}\n\t\tconst match = request.url.match(/^\\/hooks\\/([a-zA-Z0-9_-]+)$/);\n\t\tif (!match?.[1]) {\n\t\t\treturn { status: 404, body: { error: 'Not found' } };\n\t\t}\n\n\t\tconst hookId = match[1];\n\t\tconst hook = hookMap.get(hookId);\n\t\tif (!hook) {\n\t\t\treturn { status: 404, body: { error: 'Unknown hook' } };\n\t\t}\n\n\t\tconst header = request.authorizationHeader ?? '';\n\t\tconst token = header.startsWith('Bearer ') ? header.slice(7).trim() : '';\n\t\tif (!token || token !== hook.token) {\n\t\t\treturn { status: 401, body: { error: 'Unauthorized' } };\n\t\t}\n\n\t\tconst payload = parsePayload(request.body);\n\t\tconst task = fillTemplate(hook.task, {\n\t\t\tpayload: typeof payload === 'string' ? payload : JSON.stringify(payload),\n\t\t});\n\t\tvoid options.runTask(task, {\n\t\t\tsource: 'webhook',\n\t\t\thookId,\n\t\t\tpayload,\n\t\t});\n\t\treturn { status: 202, body: { accepted: true } };\n\t};\n}\n\nexport function createTriggerEngine(options: CreateTriggerEngineOptions): TriggerEngine {\n\tconst watchers: WatcherLike[] = [];\n\tconst watchFactory = options.watchFactory ?? defaultWatchFactory;\n\tlet server: Server | null = null;\n\tlet webhookPort: number | null = null;\n\n\tfunction startFileWatchers(): void {\n\t\tfor (const watcherConfig of options.fileWatchers ?? []) {\n\t\t\ttry {\n\t\t\t\tconst watcher = watchFactory(watcherConfig.path, (eventType, filename) => {\n\t\t\t\t\tif (!eventMatches(eventType, watcherConfig.events)) return;\n\t\t\t\t\tconst fileNameValue = filename?.toString() ?? '';\n\t\t\t\t\tconst task = fillTemplate(watcherConfig.task, {\n\t\t\t\t\t\tfilename: fileNameValue,\n\t\t\t\t\t\tevent: eventType,\n\t\t\t\t\t\tpath: watcherConfig.path,\n\t\t\t\t\t});\n\t\t\t\t\tvoid options\n\t\t\t\t\t\t.runTask(task, {\n\t\t\t\t\t\t\tsource: 'file_watcher',\n\t\t\t\t\t\t\twatcherPath: watcherConfig.path,\n\t\t\t\t\t\t\tfilename: fileNameValue,\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch((error) => {\n\t\t\t\t\t\t\tlogger.error('File watcher trigger failed', {\n\t\t\t\t\t\t\t\tpath: watcherConfig.path,\n\t\t\t\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t\twatchers.push(watcher);\n\t\t\t} catch (error) {\n\t\t\t\tlogger.warn('File watcher could not be started', {\n\t\t\t\t\tpath: watcherConfig.path,\n\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tfunction startWebhookServer(webhooks: WebhookConfig): Promise<void> {\n\t\tif (!webhooks.enabled) return Promise.resolve();\n\n\t\tconst handler = createWebhookRequestHandler({\n\t\t\thooks: webhooks.hooks,\n\t\t\trunTask: options.runTask,\n\t\t});\n\n\t\tserver = createServer(async (req, res) => {\n\t\t\ttry {\n\t\t\t\tif (!req.url || !req.method) {\n\t\t\t\t\tjson(res, 404, { error: 'Not found' });\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst body = await readBody(req);\n\t\t\t\tconst result = await handler({\n\t\t\t\t\tmethod: req.method,\n\t\t\t\t\turl: req.url,\n\t\t\t\t\tauthorizationHeader: req.headers.authorization,\n\t\t\t\t\tbody,\n\t\t\t\t});\n\t\t\t\tjson(res, result.status, result.body);\n\t\t\t} catch (error) {\n\t\t\t\tjson(res, 500, {\n\t\t\t\t\terror: error instanceof Error ? error.message : String(error),\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\treturn new Promise<void>((resolve, reject) => {\n\t\t\tserver?.once('error', reject);\n\t\t\tserver?.listen(webhooks.port, webhooks.host ?? '127.0.0.1', () => {\n\t\t\t\tconst address = server?.address();\n\t\t\t\tif (address && typeof address !== 'string') {\n\t\t\t\t\twebhookPort = address.port;\n\t\t\t\t}\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\t}\n\n\tasync function start(): Promise<void> {\n\t\tstartFileWatchers();\n\t\tif (options.webhooks) {\n\t\t\tawait startWebhookServer(options.webhooks);\n\t\t}\n\t}\n\n\tasync function stop(): Promise<void> {\n\t\tfor (const watcher of watchers) {\n\t\t\twatcher.close();\n\t\t}\n\t\twatchers.length = 0;\n\n\t\tif (server) {\n\t\t\tawait new Promise<void>((resolve, reject) => {\n\t\t\t\tserver?.close((error) => {\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treject(error);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tserver = null;\n\t\twebhookPort = null;\n\t}\n\n\treturn {\n\t\tstart,\n\t\tstop,\n\t\tgetWebhookPort: () => webhookPort,\n\t};\n}\n\nexport type {\n\tCreateTriggerEngineOptions,\n\tFileWatcherConfig,\n\tFileWatcherEvent,\n\tTriggerEngine,\n\tTriggerTaskContext,\n\tWebhookConfig,\n\tWebhookDispatchRequest,\n\tWebhookDispatchResponse,\n\tWebhookHookConfig,\n\tWatcherLike,\n\tWatchFactory,\n};\n"],"mappings":"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","names":["join","mkdirSync","logger","mkdirSync","response","program","existsSync","mkdirSync","writeFileSync","homedir","dirname","join","join","os","join","mkdirSync","existsSync","dirname","writeFileSync","program","program","scheduler","formatDate","program","existsSync","mkdirSync","readFileSync","parseYaml","path","existsSync","readFileSync","parseYaml","mkdirSync","z","path","z","z","z","z","fromCapabilityResult","z","z","z","scheduler","z","fromCapabilityResult","z","json","logger","existsSync","mkdirSync","readFileSync","writeFileSync","dirname","logger","mkdirSync","dirname","writeFileSync","existsSync","readFileSync","logger","record","logger","logger","convertMessages","logger","logger","queryTokens","uuidv4","z","logger","CATEGORY_VALUES","z","clampConfidence","parseJsonArray","serializeEmbedding","extractJsonBlock","uuidv4","logger","clampConfidence","logger","uuidv4","logger","serializeEmbedding","deserializeEmbedding","cosineSimilarity","uuidv4","logger","logger","STOPWORDS","tokenizeQuery","lexicalScore","queryTokens","existsSync","mkdirSync","readFileSync","writeFileSync","dirname","logger","title","existsSync","readFileSync","mkdirSync","dirname","writeFileSync","mkdirSync","readFileSync","dirname","join","logger","join","dirname","readFileSync","mkdirSync","logger","existsSync","readdirSync","readFileSync","writeFileSync","uuidv4","logger","existsSync","readFileSync","writeFileSync","readdirSync","durationMs","auditEntry","uuidv4","uuidv4","logger","uuidv4","uuidv4","logger","uuidv4","uuidv4","logger","uuidv4","uuidv4","logger","uuidv4","uuidv4","logger","path","uuidv4","createServer","logger","readBody","json","path","createServer","logger","join","scheduler"]}